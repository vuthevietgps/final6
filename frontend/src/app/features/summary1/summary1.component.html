<div class="summary1-page">
  <!-- Filter Toolbar -->
  <div class="filter-toolbar">
    <div class="filter-row">
      <input class="input search-input" type="text" placeholder="T√¨m ki·∫øm KH/SƒêT/M√£ v·∫≠n ƒë∆°n" 
             [ngModel]="q()" (ngModelChange)="q.set($event)" />
      <button class="btn btn-secondary" (click)="showFilters.set(!showFilters())">
        {{ showFilters() ? 'üîº ·∫®n Filter' : 'üîΩ Hi·ªán Filter' }}
      </button>
      <button class="btn btn-primary" (click)="refresh()">üîÑ L√†m m·ªõi</button>
      
      <!-- Template Actions -->
      <div class="template-actions">
        <button class="btn btn-success" (click)="exportTemplate()" [disabled]="isLoading()">
          üì• T·∫£i Template
        </button>
        <button class="btn btn-info" (click)="exportUnpaid()" [disabled]="isLoading()">
          üí∏ Ch∆∞a thanh to√°n
        </button>
        <label class="btn btn-warning" style="margin: 0;">
          üì§ Import Template
          <input type="file" accept=".csv,.xlsx" (change)="onTemplateFileSelected($event)" style="display: none;" />
        </label>
      </div>
    </div>

    <!-- Advanced Filters -->
    <div class="filter-panel" *ngIf="showFilters()">
      <div class="filter-grid">
        <!-- L·ªçc ƒê·∫°i l√Ω -->
        <div class="filter-group">
          <label>ƒê·∫°i l√Ω:</label>
          <select [ngModel]="filter().agentId" (ngModelChange)="updateAgentFilter($event)">
            <option value="">T·∫•t c·∫£ ƒë·∫°i l√Ω</option>
            <option *ngFor="let agent of filterOptions().agents" [value]="agent.id">
              {{ agent.name }}
            </option>
          </select>
        </div>

        <!-- L·ªçc S·∫£n ph·∫©m -->
        <div class="filter-group">
          <label>S·∫£n ph·∫©m:</label>
          <select [ngModel]="filter().productId" (ngModelChange)="updateProductFilter($event)">
            <option value="">T·∫•t c·∫£ s·∫£n ph·∫©m</option>
            <option *ngFor="let product of filterOptions().products" [value]="product.id">
              {{ product.name }}
            </option>
          </select>
        </div>

        <!-- L·ªçc Tr·∫°ng th√°i S·∫£n xu·∫•t -->
        <div class="filter-group">
          <label>Tr·∫°ng th√°i s·∫£n xu·∫•t:</label>
          <select [ngModel]="filter().productionStatus" (ngModelChange)="updateProductionStatusFilter($event)">
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option *ngFor="let status of filterOptions().productionStatuses" [value]="status">
              {{ status }}
            </option>
          </select>
        </div>

        <!-- L·ªçc Tr·∫°ng th√°i V·∫≠n ƒë∆°n -->
        <div class="filter-group">
          <label>Tr·∫°ng th√°i v·∫≠n ƒë∆°n:</label>
          <select [ngModel]="filter().orderStatus" (ngModelChange)="updateOrderStatusFilter($event)">
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option *ngFor="let status of filterOptions().orderStatuses" [value]="status">
              {{ status }}
            </option>
          </select>
        </div>

        <!-- L·ªçc T·ª´ ng√†y -->
        <div class="filter-group">
          <label>T·ª´ ng√†y:</label>
          <input type="date" [ngModel]="filter().fromDate" 
                 (ngModelChange)="updateFromDateFilter($event)" />
        </div>

        <!-- L·ªçc ƒê·∫øn ng√†y -->
        <div class="filter-group">
          <label>ƒê·∫øn ng√†y:</label>
          <input type="date" [ngModel]="filter().toDate" 
                 (ngModelChange)="updateToDateFilter($event)" />
        </div>

        <!-- S·∫Øp x·∫øp -->
        <div class="filter-group">
          <label>S·∫Øp x·∫øp theo:</label>
          <select [ngModel]="filter().sortBy" (ngModelChange)="updateSortByFilter($event)">
            <option *ngFor="let sort of filterOptions().sortOptions" [value]="sort.value">
              {{ sort.label }}
            </option>
          </select>
        </div>

        <!-- Th·ª© t·ª± s·∫Øp x·∫øp -->
        <div class="filter-group">
          <label>Th·ª© t·ª±:</label>
          <select [ngModel]="filter().sortOrder" (ngModelChange)="updateSortOrderFilter($event)">
            <option value="asc">TƒÉng d·∫ßn</option>
            <option value="desc">Gi·∫£m d·∫ßn</option>
          </select>
        </div>
      </div>

      <div class="filter-actions">
        <button class="btn btn-warning" (click)="resetFilters()">üîÑ Reset Filter</button>
        <div class="filter-info">
          T√¨m th·∫•y {{ pagination().total }} k·∫øt qu·∫£
        </div>
      </div>
    </div>
  </div>

  <!-- Statistics Panel -->
  <div class="stats-panel" *ngIf="!isLoading()">
    <div class="stats-grid">
      <div class="stat-item">
        <div class="stat-label">T·ªïng s·ªë d√≤ng:</div>
        <div class="stat-value">{{ stats().totalRows }}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">T·ªïng ph·∫£i tr·∫£:</div>
        <div class="stat-value">{{ formatCurrency(stats().totalMustPay) }}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">T·ªïng ƒë√£ tr·∫£:</div>
        <div class="stat-value">{{ formatCurrency(stats().totalPaid) }}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">T·ªïng thanh to√°n tay:</div>
        <div class="stat-value">{{ formatCurrency(stats().totalManualPayment) }}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">T·ªïng c·∫ßn thanh to√°n:</div>
        <div class="stat-value">{{ formatCurrency(stats().totalNeedToPay) }}</div>
      </div>
    </div>
  </div>

  <div class="toolbar">
    <input class="input" type="text" placeholder="T√¨m ki·∫øm KH/SƒêT/M√£ v·∫≠n ƒë∆°n" [ngModel]="q()" (ngModelChange)="q.set($event)" />
    <button class="btn" (click)="refresh()">üîÑ L√†m m·ªõi</button>
  </div>

  <div class="table-wrapper" *ngIf="!isLoading(); else loadingTpl">
    <div *ngIf="error()" class="alert alert-danger">{{ error() }}</div>
    <table class="data-table">
      <thead>
        <tr>
          <!-- C√°c c·ªôt c·ªßa ƒê∆°n h√†ng th·ª≠ nghi·ªám 2 -->
          <th>Ng√†y</th>
          <th>KH</th>
          <th>SP</th>
          <th>SL</th>
          <th>ƒê·∫°i l√Ω</th>
          <th>ID Nh√≥m QC</th>
          <th>K√≠ch ho·∫°t</th>
          <th>Chi ti·∫øt DV</th>
          <th>TT S·∫£n xu·∫•t</th>
          <th>TT V·∫≠n ƒë∆°n</th>
          <th>Link n·ªôp</th>
          <th>M√£ v·∫≠n ƒë∆°n</th>
          <th>ƒê·∫∑t c·ªçc</th>
          <th>COD</th>
          <th>Ng∆∞·ªùi nh·∫≠n</th>
          <th>SƒêT</th>
          <th>ƒê·ªãa ch·ªâ</th>
          <!-- C√°c c·ªôt t√≠nh to√°n b·ªï sung -->
          <th>B√°o gi√° ƒë·∫°i l√Ω</th>
          <th>Ph·∫£i Tr·∫£ c√¥ng ty<br/><span class="muted">T·ªïng: {{ totalMustPay() | number:'1.0-0' }}</span></th>
          <th>ƒê√£ Tr·∫£ c√¥ng ty<br/><span class="muted">T·ªïng: {{ totalPaid() | number:'1.0-0' }}</span></th>
          <th>C·∫ßn thanh to√°n<br/><span class="muted">T·ªïng: {{ totalNeedToPay() | number:'1.0-0' }}</span></th>
          <th>Thanh to√°n tay</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of filtered()">
          <!-- ƒê∆°n h√†ng th·ª≠ nghi·ªám 2 -->
          <td>{{ r.createdAt | date:'dd/MM/yyyy' }}</td>
          <td>{{ r.customerName }}</td>
          <td>{{ displayProduct(r) }}</td>
          <td>{{ r.quantity }}</td>
          <td>{{ displayAgent(r) }}</td>
          <td>{{ r.adGroupId }}</td>
          <td class="center"><input type="checkbox" [checked]="r.isActive" disabled /></td>
          <td>{{ r.serviceDetails }}</td>
          <td>{{ r.productionStatus }}</td>
          <td>{{ r.orderStatus }}</td>
          <td>{{ r.submitLink }}</td>
          <td>{{ r.trackingNumber }}</td>
          <td>{{ r.depositAmount }}</td>
          <td>{{ r.codAmount }}</td>
          <td>{{ r.receiverName }}</td>
          <td>{{ r.receiverPhone }}</td>
          <td>{{ r.receiverAddress }}</td>
          <!-- B·ªï sung -->
          <td>{{ r.quotePrice || 0 }}</td>
          <td>{{ r.mustPay || 0 }}</td>
          <td>{{ r.paid || 0 }}</td>
          <td>{{ r.needToPay || 0 }}</td>
          <td>
            <input class="input" type="number" step="1000" [ngModel]="r.manualPayment || 0" (blur)="onBlurManual(r, $event)" (keydown.enter)="$event.target.blur()" />
          </td>
        </tr>
        <tr *ngIf="!error() && filtered().length===0">
          <td colspan="22" class="center muted">Ch∆∞a c√≥ d·ªØ li·ªáu</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination-wrapper" *ngIf="!isLoading() && pagination().total > 0">
    <div class="pagination-info">
      Hi·ªÉn th·ªã {{ (pagination().page - 1) * pagination().limit + 1 }} - 
      {{ Math.min(pagination().page * pagination().limit, pagination().total) }} 
      trong t·ªïng s·ªë {{ pagination().total }} k·∫øt qu·∫£
    </div>
    
    <div class="pagination-controls">
      <select [ngModel]="filter().limit" (ngModelChange)="changePageSize($event)" class="page-size-select">
        <option value="10">10/trang</option>
        <option value="25">25/trang</option>
        <option value="50">50/trang</option>
        <option value="100">100/trang</option>
      </select>

      <button class="btn btn-sm" [disabled]="pagination().page <= 1" (click)="goToPage(1)">
        ‚èÆÔ∏è ƒê·∫ßu
      </button>
      <button class="btn btn-sm" [disabled]="pagination().page <= 1" (click)="goToPage(pagination().page - 1)">
        ‚¨ÖÔ∏è Tr∆∞·ªõc
      </button>
      
      <span class="page-info">
        Trang {{ pagination().page }} / {{ pagination().totalPages }}
      </span>
      
      <button class="btn btn-sm" [disabled]="pagination().page >= pagination().totalPages" (click)="goToPage(pagination().page + 1)">
        Sau ‚û°Ô∏è
      </button>
      <button class="btn btn-sm" [disabled]="pagination().page >= pagination().totalPages" (click)="goToPage(pagination().totalPages)">
        Cu·ªëi ‚è≠Ô∏è
      </button>
    </div>
  </div>

  <ng-template #loadingTpl>
    <div class="loading">ƒêang t·∫£i...</div>
  </ng-template>
</div>
