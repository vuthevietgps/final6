<!-- Header v·ªõi backdrop glassmorphism -->
<div class="header-section">
  <div class="page-title">
    <h2><span class="icon">üì¢</span> Qu·∫£n L√Ω Nh√≥m Qu·∫£ng C√°o</h2>
    <p class="subtitle">T√≠ch h·ª£p chatbot v√† webhook cho d·ªãch v·ª• kh√°ch h√†ng t·ª± ƒë·ªông</p>
  </div>
  <div class="header-actions">
    <button type="button" class="btn btn-primary" (click)="openModal()">
      ‚ûï Th√™m Nh√≥m Qu·∫£ng C√°o
    </button>
  </div>
</div>

<!-- Error/Loading states -->
<div *ngIf="error()" class="alert alert-danger">‚ö†Ô∏è {{ error() }}</div>
<div *ngIf="isLoading()" class="loading-spinner">
  <div class="spinner"></div>
  <span>ƒêang t·∫£i d·ªØ li·ªáu...</span>
</div>

<!-- Stats cards -->
<div class="stats-grid" *ngIf="!isLoading()">
  <div class="stat-card">
    <div class="stat-icon">üì¢</div>
    <div class="stat-info">
      <div class="stat-number">{{ adGroups().length }}</div>
      <div class="stat-label">T·ªïng nh√≥m QC</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon">üü¢</div>
    <div class="stat-info">
      <div class="stat-number">{{ getActiveCount() }}</div>
      <div class="stat-label">ƒêang ho·∫°t ƒë·ªông</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon">ü§ñ</div>
    <div class="stat-info">
      <div class="stat-number">{{ getChatbotEnabledCount() }}</div>
      <div class="stat-label">C√≥ chatbot</div>
    </div>
  </div>
  <div class="stat-card">
    <div class="stat-icon">üîó</div>
    <div class="stat-info">
      <div class="stat-number">{{ getWebhookEnabledCount() }}</div>
      <div class="stat-label">Webhook ho·∫°t ƒë·ªông</div>
    </div>
  </div>
</div>

<!-- Search and filters -->
<div class="toolbar" *ngIf="!isLoading()">
  <div class="toolbar-left">
    <div class="search-input">
      <span class="search-icon">üîé</span>
      <input 
        type="text" 
        [value]="searchQuery()" 
        (input)="searchQuery.set($any($event.target).value)" 
        placeholder="T√¨m t√™n nh√≥m, ID, fanpage...">
    </div>
    <button class="btn btn-primary" (click)="onSearch()">T√¨m ki·∫øm</button>
    <button class="btn btn-secondary" (click)="resetFilters()">ƒê·∫∑t l·∫°i</button>
  </div>
</div>

<!-- Data table -->
<div class="table-container" *ngIf="!isLoading()">
  <table class="modern-table">
    <thead>
      <tr>
        <th (click)="setSort('name')" class="sortable">
          <span>T√™n Nh√≥m</span>
          <span class="sort-icon">‚ÜïÔ∏è</span>
        </th>
        <th>Fanpage</th>
        <th>Danh m·ª•c SP</th>
        <th>S·∫£n ph·∫©m</th>
        <th>AI Config</th>
        <th>Webhook</th>
        <th>Tr·∫°ng th√°i</th>
        <th class="actions-col">H√†nh ƒë·ªông</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let group of adGroups()" class="data-row">
        <td>
          <div class="cell-content">
            <div class="cell-main">{{ group.name }}</div>
            <div class="cell-sub">{{ group.adGroupId }}</div>
          </div>
        </td>
        <td>
          <div class="fanpage-info">
            <span class="fanpage-name">{{ getFanpageName(group.fanpageId) }}</span>
          </div>
        </td>
        <td>
          <span class="category-badge">{{ getCategoryName(group.productCategoryId) }}</span>
        </td>
        <td>
          <div class="product-count">
            {{ group.selectedProducts?.length || 0 }} s·∫£n ph·∫©m
          </div>
        </td>
        <td>
          <span class="ai-status" [class.enabled]="group.openAIConfigId">
            {{ group.openAIConfigId ? 'ü§ñ C√≥ AI' : '‚ùå Ch∆∞a c·∫•u h√¨nh' }}
          </span>
        </td>
        <td>
          <div class="webhook-controls">
            <label class="toggle-switch">
              <input 
                type="checkbox" 
                [checked]="group.enableWebhook"
                (change)="toggleWebhook(group, $event)">
              <span class="slider"></span>
            </label>
          </div>
        </td>
        <td>
          <span class="status-badge" [class.active]="group.isActive" (click)="toggleActive(group)">
            {{ group.isActive ? 'Ho·∫°t ƒë·ªông' : 'T·∫°m d·ª´ng' }}
          </span>
        </td>
        <td class="actions-cell">
          <button class="action-btn edit" (click)="editItem(group)" title="Ch·ªânh s·ª≠a">
            ‚úèÔ∏è
          </button>
          <button class="action-btn delete" (click)="deleteItem(group)" title="X√≥a">
            üóëÔ∏è
          </button>
        </td>
      </tr>
      <tr *ngIf="adGroups().length === 0">
        <td colspan="8" class="empty-state">
          <div class="empty-content">
            <div class="empty-icon">üì¢</div>
            <h3>Ch∆∞a c√≥ nh√≥m qu·∫£ng c√°o n√†o</h3>
            <p>T·∫°o nh√≥m qu·∫£ng c√°o ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu qu·∫£n l√Ω chatbot</p>
            <button class="btn btn-primary" (click)="openModal()">Th√™m nh√≥m ƒë·∫ßu ti√™n</button>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Modal for Create/Edit -->
<div *ngIf="showModal()" class="modal-backdrop" (click)="closeModalIfOutside($event)">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ isEditing() ? 'Ch·ªânh S·ª≠a Nh√≥m Qu·∫£ng C√°o' : 'Th√™m Nh√≥m Qu·∫£ng C√°o M·ªõi' }}</h3>
      <button class="close-btn" (click)="closeModal()">√ó</button>
    </div>

    <form [formGroup]="adGroupForm" (ngSubmit)="saveItem()" class="modal-form">
      <div class="modal-body">
        <!-- Basic Information Section -->
        <div class="form-section">
          <h4 class="section-title">
            <span class="section-icon">‚ÑπÔ∏è</span>
            Th√¥ng Tin C∆° B·∫£n
          </h4>
          
          <div class="form-row">
            <div class="form-group">
              <label for="name">T√™n nh√≥m qu·∫£ng c√°o *</label>
              <input 
                id="name"
                type="text" 
                formControlName="name" 
                class="form-control"
                placeholder="VD: Gi√†y th·ªÉ thao Nike - Target 18-35">
              <div *ngIf="adGroupForm.get('name')?.invalid && adGroupForm.get('name')?.touched" class="error-message">
                T√™n nh√≥m l√† b·∫Øt bu·ªôc
              </div>
            </div>
            <div class="form-group">
              <label for="adGroupId">ID nh√≥m qu·∫£ng c√°o *</label>
              <input 
                id="adGroupId"
                type="text" 
                formControlName="adGroupId" 
                class="form-control"
                placeholder="VD: 23851234567890123">
              <div *ngIf="adGroupForm.get('adGroupId')?.invalid && adGroupForm.get('adGroupId')?.touched" class="error-message">
                ID nh√≥m qu·∫£ng c√°o l√† b·∫Øt bu·ªôc
              </div>
            </div>
          </div>
        </div>

        <!-- Fanpage & Product Selection -->
        <div class="form-section">
          <h4 class="section-title">
            <span class="section-icon">üìÑ</span>
            Fanpage v√† S·∫£n Ph·∫©m
          </h4>
          
          <div class="form-row">
            <div class="form-group">
              <label for="fanpageId">Fanpage *</label>
              <select id="fanpageId" formControlName="fanpageId" class="form-control">
                <option value="">-- Ch·ªçn fanpage --</option>
                <option *ngFor="let fanpage of fanpages()" [value]="fanpage._id">
                  {{ fanpage.name }}
                </option>
              </select>
              <div *ngIf="adGroupForm.get('fanpageId')?.invalid && adGroupForm.get('fanpageId')?.touched" class="error-message">
                Vui l√≤ng ch·ªçn fanpage
              </div>
            </div>
            <div class="form-group">
              <label for="productCategoryId">Danh m·ª•c s·∫£n ph·∫©m *</label>
              <select 
                id="productCategoryId" 
                formControlName="productCategoryId" 
                class="form-control"
                (change)="onCategoryChange($event)">
                <option value="">-- Ch·ªçn danh m·ª•c --</option>
                <option *ngFor="let category of productCategories()" [value]="category._id">
                  {{ category.name }}
                </option>
              </select>
              <div *ngIf="adGroupForm.get('productCategoryId')?.invalid && adGroupForm.get('productCategoryId')?.touched" class="error-message">
                Vui l√≤ng ch·ªçn danh m·ª•c s·∫£n ph·∫©m
              </div>
            </div>
          </div>

          <!-- Product Selection -->
          <div class="form-group" *ngIf="availableProducts().length > 0">
            <label>Ch·ªçn s·∫£n ph·∫©m (c√≥ th·ªÉ ch·ªçn nhi·ªÅu)</label>
            <div class="product-grid">
              <div *ngFor="let product of availableProducts()" class="product-card">
                <label class="product-checkbox">
                  <input 
                    type="checkbox" 
                    [value]="product._id"
                    [checked]="isProductSelected(product._id)"
                    (change)="toggleProductSelection(product._id, $event)">
                  <div class="product-info">
                    <div class="product-name">{{ product.name }}</div>
                    <div class="product-price">{{ getProductPrice(product) }}</div>
                  </div>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- AI Configuration Section -->
        <div class="form-section">
          <h4 class="section-title">
            <span class="section-icon">ü§ñ</span>
            C·∫•u H√¨nh AI Chatbot
          </h4>
          
          <div class="form-group">
            <label for="openAIConfigId">C·∫•u h√¨nh OpenAI</label>
            <select id="openAIConfigId" formControlName="openAIConfigId" class="form-control">
              <option value="">-- Kh√¥ng s·ª≠ d·ª•ng AI --</option>
              <option *ngFor="let config of openAIConfigs()" [value]="config._id">
                {{ config.name }} ({{ config.model }})
              </option>
            </select>
          </div>

          <!-- Chat Script Configuration -->
          <div class="chat-script-config" *ngIf="adGroupForm.get('openAIConfigId')?.value">
            <h5>K·ªãch b·∫£n tr√≤ chuy·ªán</h5>
            <div formGroupName="chatScript" class="chat-script-form">
              <div class="form-group">
                <label for="greeting">L·ªùi ch√†o</label>
                <textarea 
                  id="greeting"
                  formControlName="greeting" 
                  class="form-control"
                  rows="2"
                  placeholder="VD: Xin ch√†o! C·∫£m ∆°n b·∫°n ƒë√£ quan t√¢m ƒë·∫øn s·∫£n ph·∫©m c·ªßa ch√∫ng t√¥i."></textarea>
              </div>
              <div class="form-group">
                <label for="upsell">G·ª£i √Ω b√°n th√™m</label>
                <textarea 
                  id="upsell"
                  formControlName="upsell" 
                  class="form-control"
                  rows="3"
                  placeholder="VD: B·∫°n c√≥ mu·ªën xem th√™m c√°c s·∫£n ph·∫©m kh√°c kh√¥ng?"></textarea>
              </div>
              <div class="form-group">
                <label for="closing">L·ªùi k·∫øt th√∫c</label>
                <textarea 
                  id="closing"
                  formControlName="closing" 
                  class="form-control"
                  rows="2"
                  placeholder="VD: C·∫£m ∆°n b·∫°n! H√£y li√™n h·ªá n·∫øu c·∫ßn h·ªó tr·ª£ th√™m."></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Discount Program Section -->
        <div class="form-section">
          <h4 class="section-title">
            <span class="section-icon">üí∞</span>
            Ch∆∞∆°ng Tr√¨nh Khuy·∫øn M√£i
          </h4>
          
          <div formGroupName="discountProgram" class="discount-form">
            <div class="form-row">
              <div class="form-group">
                <label for="discountType">Lo·∫°i gi·∫£m gi√°</label>
                <select id="discountType" formControlName="discountType" class="form-control">
                  <option value="">Kh√¥ng √°p d·ª•ng</option>
                  <option value="percentage">Theo ph·∫ßn trƒÉm (%)</option>
                  <option value="fixed">S·ªë ti·ªÅn c·ªë ƒë·ªãnh (VNƒê)</option>
                </select>
              </div>
              <div class="form-group">
                <label for="discountValue">Gi√° tr·ªã gi·∫£m</label>
                <input 
                  id="discountValue"
                  type="number" 
                  formControlName="discountValue" 
                  class="form-control"
                  placeholder="VD: 15 ho·∫∑c 50000">
              </div>
            </div>
            <div class="form-group">
              <label for="conditions">ƒêi·ªÅu ki·ªán √°p d·ª•ng</label>
              <textarea 
                id="conditions"
                formControlName="conditions" 
                class="form-control"
                rows="2"
                placeholder="VD: √Åp d·ª•ng cho ƒë∆°n h√†ng t·ª´ 500,000 VNƒê"></textarea>
            </div>
          </div>
        </div>

        <!-- Settings Section -->
        <div class="form-section">
          <h4 class="section-title">
            <span class="section-icon">‚öôÔ∏è</span>
            C√†i ƒê·∫∑t
          </h4>
          
          <div class="form-row">
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" formControlName="enableWebhook">
                <span class="checkmark"></span>
                K√≠ch ho·∫°t webhook
              </label>
              <small class="help-text">Cho ph√©p nh·∫≠n tin nh·∫Øn t·ª´ fanpage</small>
            </div>
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" formControlName="enableAIChat">
                <span class="checkmark"></span>
                K√≠ch ho·∫°t AI chat
              </label>
              <small class="help-text">T·ª± ƒë·ªông tr·∫£ l·ªùi tin nh·∫Øn b·∫±ng AI</small>
            </div>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" formControlName="isActive">
              <span class="checkmark"></span>
              Tr·∫°ng th√°i ho·∫°t ƒë·ªông
            </label>
          </div>
        </div>

        <div class="form-section">
          <div class="form-group">
            <label for="notes">Ghi ch√∫</label>
            <textarea 
              id="notes"
              formControlName="notes" 
              class="form-control"
              rows="3"
              placeholder="Th√¥ng tin b·ªï sung v·ªÅ nh√≥m qu·∫£ng c√°o n√†y..."></textarea>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModal()">
          H·ªßy b·ªè
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="adGroupForm.invalid || isSaving()">
          <span *ngIf="isSaving()" class="loading-dot"></span>
          {{ isEditing() ? 'C·∫≠p nh·∫≠t' : 'T·∫°o m·ªõi' }}
        </button>
      </div>
    </form>
  </div>
</div>
