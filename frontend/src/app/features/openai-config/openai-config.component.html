<div class="openai-config-container">
  <!-- Header v·ªõi title v√† action buttons -->
  <div class="header">
    <h2>ü§ñ Qu·∫£n l√Ω C·∫•u h√¨nh OpenAI</h2>
    <div class="header-actions">
      <button type="button" class="btn btn-primary" (click)="openAddModal()" [disabled]="loading()">
        ‚ûï Th√™m c·∫•u h√¨nh
      </button>
      <button type="button" class="btn btn-secondary" (click)="loadConfigs()" [disabled]="loading()">
        üîÑ T·∫£i l·∫°i
      </button>
    </div>
  </div>

  <!-- Error message -->
  <div *ngIf="error() && !showModal()" class="error-message">
    <span>‚ö†Ô∏è {{ error() }}</span>
    <button type="button" (click)="error.set(null)" class="close-btn">√ó</button>
  </div>

  <!-- Loading state -->
  <div *ngIf="loading() && !showModal()" class="loading-state">
    <span>üîÑ ƒêang t·∫£i d·ªØ li·ªáu...</span>
  </div>

  <!-- B·∫£ng danh s√°ch c·∫•u h√¨nh OpenAI -->
  <div class="table-container" *ngIf="!loading()">
    <table class="openai-config-table">
      <thead>
        <tr>
          <th>T√™n c·∫•u h√¨nh</th>
          <th>Model</th>
          <th>API Key</th>
          <th>Temperature</th>
          <th>Max Tokens</th>
          <th>Scope</th>
          <th>Tr·∫°ng th√°i</th>
          <th>M·∫∑c ƒë·ªãnh</th>
          <th>Thao t√°c</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let config of configs(); trackBy: trackById" class="config-row">
          <td>
            <div class="config-info">
              <div class="config-name">{{ config.name }}</div>
              <div class="config-desc" *ngIf="config.description">{{ config.description }}</div>
            </div>
          </td>
          <td>
            <span class="model-badge">{{ config.model }}</span>
          </td>
          <td>
            <span class="api-key">{{ maskApiKey(config.apiKey) }}</span>
          </td>
          <td>
            <span class="temperature">{{ config.temperature }}</span>
          </td>
          <td>
            <span class="max-tokens">{{ config.maxTokens }}</span>
          </td>
          <td>
            <div class="scope-info">
              <span class="scope-type">{{ config.scopeType }}</span>
              <span class="scope-ref" *ngIf="config.scopeRef">{{ config.scopeRef }}</span>
            </div>
          </td>
          <td>
            <span class="status-badge" [class]="'status-' + config.status">
              {{ config.status === 'active' ? 'Ho·∫°t ƒë·ªông' : 'Ng∆∞ng' }}
            </span>
          </td>
          <td>
            <span class="default-badge" *ngIf="config.isDefault">‚≠ê M·∫∑c ƒë·ªãnh</span>
          </td>
          <td class="actions">
            <button type="button" class="btn-action edit" (click)="openEditModal(config)" title="Ch·ªânh s·ª≠a">
              ‚úèÔ∏è
            </button>
            <button type="button" class="btn-action delete" (click)="deleteConfig(config)" title="X√≥a">
              üóëÔ∏è
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Empty state -->
  <div *ngIf="!loading() && configs().length === 0" class="empty-state">
    <div class="empty-icon">ü§ñ</div>
    <h3>Ch∆∞a c√≥ c·∫•u h√¨nh OpenAI</h3>
    <p>Th√™m c·∫•u h√¨nh ƒë·∫ßu ti√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu s·ª≠ d·ª•ng AI chatbot.</p>
    <button type="button" class="btn btn-primary" (click)="openAddModal()">
      ‚ûï Th√™m c·∫•u h√¨nh OpenAI
    </button>
  </div>

  <!-- Modal form -->
  <div class="modal-overlay" *ngIf="showModal()" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ isEditing() ? '‚úèÔ∏è Ch·ªânh s·ª≠a c·∫•u h√¨nh' : '‚ûï T·∫°o c·∫•u h√¨nh OpenAI m·ªõi' }}</h3>
        <button type="button" class="close-btn" (click)="closeModal()">√ó</button>
      </div>

      <div class="modal-body">
        <!-- Error trong modal -->
        <div *ngIf="error()" class="error-message">
          <span>‚ö†Ô∏è {{ error() }}</span>
          <button type="button" (click)="error.set(null)" class="close-btn">√ó</button>
        </div>

        <form (submit)="$event.preventDefault(); saveConfig()">
          <!-- Th√¥ng tin c∆° b·∫£n -->
          <div class="form-section">
            <h4>Th√¥ng tin c∆° b·∫£n</h4>
            
            <div class="form-group">
              <label for="name">T√™n c·∫•u h√¨nh *</label>
              <input type="text" id="name" 
                     [value]="formData().name || ''" 
                     (input)="onInputChange($event, 'name')" 
                     placeholder="V√≠ d·ª•: ChatBot Fanpage Ch√≠nh"
                     required>
            </div>

            <div class="form-group">
              <label for="description">M√¥ t·∫£</label>
              <textarea id="description" 
                        [value]="formData().description || ''" 
                        (input)="onInputChange($event, 'description')" 
                        rows="2" 
                        placeholder="M√¥ t·∫£ ng·∫Øn g·ªçn v·ªÅ c·∫•u h√¨nh n√†y"></textarea>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="status">Tr·∫°ng th√°i</label>
                <select id="status" 
                        [value]="formData().status || 'active'" 
                        (change)="onInputChange($event, 'status')">
                  <option value="active">Ho·∫°t ƒë·ªông</option>
                  <option value="inactive">Ng∆∞ng</option>
                </select>
              </div>
              <div class="form-group">
                <label>M·∫∑c ƒë·ªãnh</label>
                <input type="checkbox" 
                       [checked]="formData().isDefault || false" 
                       (change)="onCheckboxChange($event, 'isDefault')">
                <span class="checkbox-label">ƒê·∫∑t l√†m c·∫•u h√¨nh m·∫∑c ƒë·ªãnh</span>
              </div>
            </div>
          </div>

          <!-- C·∫•u h√¨nh OpenAI -->
          <div class="form-section">
            <h4>C·∫•u h√¨nh OpenAI</h4>
            
            <div class="form-group">
              <label for="model">Model OpenAI *</label>
              <select id="model" 
                      [value]="formData().model || 'gpt-4o-mini'" 
                      (change)="onInputChange($event, 'model')">
                <option value="gpt-4o-mini">gpt-4o-mini</option>
                <option value="gpt-4o">gpt-4o</option>
                <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                <option value="o4-mini">o4-mini (reasoning)</option>
                <option value="gpt-4.1-mini">gpt-4.1-mini</option>
                <option value="gpt-4.1">gpt-4.1</option>
                <option value="gpt-4.1-nano">gpt-4.1-nano</option>
                <option value="o3-mini">o3-mini</option>
              </select>
            </div>

            <div class="form-group">
              <label for="apiKey">OpenAI API Key *</label>
              <div class="input-with-icon">
                <input type="password" id="apiKey" 
                       [value]="formData().apiKey || ''" 
                       (input)="onInputChange($event, 'apiKey')" 
                       placeholder="sk-proj-...">
                <button type="button" class="test-btn" (click)="testApiKey()" [disabled]="testingKey()">
                  {{ testingKey() ? '‚è≥ ƒêang test...' : 'üîç Test API Key' }}
                </button>
              </div>
              <small *ngIf="testResult() && !error()" style="border-left-color:#00b894; color:#1a6b46;">‚úÖ {{ testResult() }}</small>
              <small>API key t·ª´ OpenAI platform (https://platform.openai.com/api-keys)</small>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="maxTokens">Max Tokens *</label>
                <input type="number" id="maxTokens" 
                       [value]="formData().maxTokens || 150" 
                       (input)="onNumberChange($event, 'maxTokens')" 
                       min="1" max="4000">
                <small>S·ªë token t·ªëi ƒëa cho m·ªói response (50-4000)</small>
              </div>
              <div class="form-group">
                <label for="temperature">Temperature *</label>
                <input type="number" id="temperature" 
                       [value]="formData().temperature || 0.7" 
                       (input)="onNumberChange($event, 'temperature')" 
                       min="0" max="2" step="0.1">
                <small>ƒê·ªô s√°ng t·∫°o (0: nghi√™m t√∫c, 2: s√°ng t·∫°o)</small>
              </div>
            </div>
          </div>

          <!-- Tham s·ªë AI -->
          <div class="form-section">
            <h4>Tham s·ªë AI</h4>
            
            <div class="form-group">
              <label for="systemPrompt">System Prompt *</label>
              <textarea id="systemPrompt" 
                        [value]="formData().systemPrompt || ''" 
                        (input)="onInputChange($event, 'systemPrompt')" 
                        rows="4" 
                        placeholder="H∆∞·ªõng d·∫´n cho AI v·ªÅ c√°ch tr·∫£ l·ªùi kh√°ch h√†ng..."></textarea>
              <small>H∆∞·ªõng d·∫´n chi cho AI v·ªÅ c√°ch tr·∫£ l·ªùi v√† h√†nh vi</small>
            </div>
          </div>

          <!-- Ph·∫°m vi √°p d·ª•ng -->
          <div class="form-section">
            <h4>Ph·∫°m vi √°p d·ª•ng</h4>
            
            <div class="form-row">
              <div class="form-group">
                <label for="scopeType">Lo·∫°i ph·∫°m vi *</label>
                <select id="scopeType" 
                        [value]="formData().scopeType || 'global'" 
                        (change)="onInputChange($event, 'scopeType')">
                  <option value="global">To√†n c·ª•c</option>
                  <option value="fanpage">Fanpage</option>
                  <option value="adgroup">Ad Group</option>
                  <option value="messageScope">Message Scope</option>
                </select>
                <small>X√°c ƒë·ªãnh c·∫•u h√¨nh √°p d·ª•ng ·ªü ƒë√¢u trong h·ªá th·ªëng</small>
              </div>
              <div class="form-group" *ngIf="formData().scopeType !== 'global'">
                <label for="scopeRef">ID tham chi·∫øu</label>
                <input type="text" id="scopeRef" 
                       [value]="formData().scopeRef || ''" 
                       (input)="onInputChange($event, 'scopeRef')" 
                       placeholder="Ch·ªçn fanpage √°p d·ª•ng c·∫•u h√¨nh n√†y">
                <small>Ch·ªçn fanpage √°p d·ª•ng c·∫•u h√¨nh n√†y</small>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" (click)="closeModal()" [disabled]="loading()">
              H·ªßy
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="loading()">
              {{ loading() ? '‚è≥ ƒêang l∆∞u...' : (isEditing() ? 'üíæ C·∫≠p nh·∫≠t' : '‚ûï T·∫°o m·ªõi') }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
