<div class="conversation-container">
  <div class="header-row">
    <h2>ğŸ—‚ï¸ Há»™i Thoáº¡i Fanpage</h2>
    <div class="filters">
      <input placeholder="Fanpage ID" [ngModel]="filter().fanpageId" (ngModelChange)="updateFilter('fanpageId',$event)"/>
      <input placeholder="Sender PSID" [ngModel]="filter().senderPsid" (ngModelChange)="updateFilter('senderPsid',$event)"/>
      <select [ngModel]="filter().needsHuman" (ngModelChange)="updateFilter('needsHuman',$event)">
        <option value="">--Needs Human?--</option>
        <option value="true">Cáº§n xá»­ lÃ½</option>
        <option value="false">ÄÃ£ á»•n</option>
      </select>
      <button class="btn" (click)="page.set(1); load()" [disabled]="loading()">Táº£i</button>
    </div>
  </div>
  <div *ngIf="error()" class="error-box">{{ error() }}</div>
  <div *ngIf="loading()" class="loading">Äang táº£i...</div>
  <table class="conv-table" *ngIf="!loading() && items().length">
    <thead>
      <tr>
        <th>Fanpage</th>
        <th>Sender</th>
        <th>Ad Group</th>
        <th>Tá»•ng</th>
        <th>Inbound/Out</th>
        <th>Chá»</th>
        <th>Cuá»‘i (ago)</th>
        <th>Snippet</th>
        <th>Tráº¡ng thÃ¡i</th>
        <th>AI</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let c of items()" (dblclick)="open(c)" [class.needs]="c.needsHuman" [class.recent]="timeAgo(c.lastMessageAt||'').endsWith('s') || timeAgo(c.lastMessageAt||'').endsWith('m')">
        <td>
          <div class="fanpage-cell">
            <span class="fanpage-id">{{ getFanpagePageId(c.fanpageId) }}</span>
            <span *ngIf="getFanpageName(c.fanpageId)" class="fanpage-name">{{ getFanpageName(c.fanpageId) }}</span>
            <a *ngIf="isFanpageObject(c.fanpageId)" [href]="'https://facebook.com/' + getFanpagePageId(c.fanpageId)" target="_blank" class="fb-link" title="Xem fanpage trÃªn Facebook">ğŸ”—</a>
          </div>
        </td>
        <td>{{ c.senderPsid }}</td>
        <td>
          <span *ngIf="c.lastAdGroupId" class="ad-group-badge">{{ c.lastAdGroupId }}</span>
          <span *ngIf="!c.lastAdGroupId" class="no-ad-group">-</span>
        </td>
        <td>{{ c.totalMessages }}</td>
        <td>{{ c.inboundCount }}/{{ c.outboundCount }}</td>
        <td>{{ c.awaitingCount }}</td>
        <td>{{ timeAgo(c.lastMessageAt||'') }}</td>
        <td>{{ c.lastMessageSnippet }}</td>
        <td>
          <span class="badge needs" *ngIf="c.needsHuman">Cáº§n ngÆ°á»i</span>
          <span class="badge ok" *ngIf="!c.needsHuman">OK</span>
        </td>
        <td>
          <span class="badge ai-on" *ngIf="c.autoAiEnabled!==false">AI</span>
          <span class="badge ai-off" *ngIf="c.autoAiEnabled===false">Táº¯t</span>
        </td>
        <td><button class="mini" (click)="open(c)">Chi tiáº¿t</button></td>
      </tr>
    </tbody>
  </table>
  <div *ngIf="!loading() && !items().length" class="empty">KhÃ´ng cÃ³ há»™i thoáº¡i</div>

  <div class="pagination" *ngIf="total()>limit()">
    <button (click)="setPage(page()-1)" [disabled]="page()===1">Â«</button>
    <span>Trang {{ page() }}</span>
    <button (click)="setPage(page()+1)" [disabled]="page()*limit()>=total()">Â»</button>
  </div>

  <!-- Detail Modal -->
  <div class="modal-backdrop" *ngIf="showDetail()" (click)="showDetail.set(false)">
    <div class="modal" (click)="$event.stopPropagation()">
      <h3>Há»™i thoáº¡i: {{ currentConv()?.senderPsid }}</h3>
      <div class="meta-row" *ngIf="currentConv()">
        <span>Tá»•ng: {{ currentConv()?.totalMessages }}</span>
        <span>Inbound: {{ currentConv()?.inboundCount }}</span>
        <span>Outbound: {{ currentConv()?.outboundCount }}</span>
        <span>Chá»: {{ currentConv()?.awaitingCount }}</span>
        <span>Cuá»‘i: {{ currentConv()?.lastMessageAt | date:'short' }}</span>
      </div>
      <div class="ai-info" *ngIf="currentConv()?.autoAiEnabled!==false">
        <small>ğŸ¤– AI Ä‘ang báº­t: Tá»± Ä‘á»™ng tráº£ lá»i dá»±a trÃªn mÃ´ táº£ fanpage vÃ  lá»‹ch sá»­ chat. AI sáº½ táº¯t khi báº¡n báº¥m "Táº¯t AI".</small>
      </div>
      <div class="ai-info" *ngIf="currentConv()?.autoAiEnabled===false">
        <small>â­• AI Ä‘Ã£ táº¯t: Tin nháº¯n má»›i sáº½ khÃ´ng Ä‘Æ°á»£c AI tá»± tráº£ lá»i. Báº¥m "Báº­t AI" Ä‘á»ƒ kÃ­ch hoáº¡t láº¡i.</small>
      </div>
      <div class="detail-actions">
        <button class="btn" (click)="resolve()" *ngIf="currentConv()?.needsHuman">ÄÃ¡nh dáº¥u xong</button>
        <button class="btn" (click)="toggleAI()">{{ currentConv()?.autoAiEnabled===false ? 'Báº­t AI' : 'Táº¯t AI' }}</button>
        <button class="btn" (click)="showDetail.set(false)">ÄÃ³ng</button>
        <small class="performance-info" *ngIf="detailLoading()">âš¡ Táº£i nhanh...</small>
      </div>
      <div class="thread-layout">
        <div class="thread-col">
          <div class="thread">
            <div *ngIf="detailLoading() && messages().length === 0" class="loading-messages">
              <div class="loading-spinner">â³</div>
              <div>Äang táº£i tin nháº¯n...</div>
            </div>
            <div *ngFor="let m of messages()" class="msg" [class.in]="m.direction==='in'" [class.out]="m.direction==='out'" [class.ai]="m.isAI">
              <div class="meta">
                <span class="sender-label">{{ m.direction==='in' ? 'ğŸ‘¤ KhÃ¡ch hÃ ng' : (m.isAI ? 'ğŸ¤– AI Assistant' : 'ğŸ‘¨â€ğŸ’¼ NhÃ¢n viÃªn') }}</span>
                <span class="time-label">{{ m.createdAt | date:'HH:mm, dd/MM' }}</span>
                <span *ngIf="m.isAI && m.aiModelUsed" class="model-tag">{{ m.aiModelUsed }}</span>
              </div>
              <div class="body">{{ m.content }}</div>
              <div class="flags" *ngIf="m.awaitingHuman || m.adGroupId || m.isAI">
                <span *ngIf="m.awaitingHuman" class="flag-item awaiting">â³ Chá» xá»­ lÃ½</span>
                <span *ngIf="m.adGroupId" class="flag-item adgroup">ğŸ¯ {{ m.adGroupId }}</span>
                <span *ngIf="m.isAI" class="flag-item ai-generated">âœ¨ AI tá»± Ä‘á»™ng</span>
              </div>
            </div>
          </div>
          <div class="reply-box">
            <textarea rows="2" placeholder="Tráº£ lá»i (Ctrl+Enter gá»­i)" [ngModel]="replyText()" (ngModelChange)="replyText.set($event)" (keydown)="onReplyKey($event)"></textarea>
            <div class="reply-actions">
              <button class="btn" (click)="sendReply()" [disabled]="sending() || !replyText().trim()">Gá»­i</button>
            </div>
          </div>
        </div>
        <div class="order-col">
          <h4>ğŸ“ ÄÆ¡n HÃ ng</h4>
          <div class="mini-hint" *ngIf="orderExtractLoading()">Äang quÃ©t há»™i thoáº¡i...</div>
          <div class="mini-hint" *ngIf="!orderExtractLoading() && extractSuggestions()">Gá»£i Ã½ Ä‘Ã£ Ä‘iá»n tá»± Ä‘á»™ng â€“ kiá»ƒm tra láº¡i trÆ°á»›c khi lÆ°u.</div>
          <div class="form-grid">
            <label>Sáº£n pháº©m
              <select [ngModel]="orderDraft()?.productId" (ngModelChange)="setDraftField('productId',$event)">
                <option value="">-- Chá»n --</option>
                <option *ngFor="let p of products()" [value]="p._id">{{ p.name }}</option>
              </select>
            </label>
            <label>KhÃ¡ch HÃ ng<input [ngModel]="orderDraft()?.customerName" (ngModelChange)="setDraftField('customerName',$event)"/></label>
            <label>Äiá»‡n Thoáº¡i<input [ngModel]="orderDraft()?.phone" (ngModelChange)="setDraftField('phone',$event)"/></label>
            <label>Äá»‹a Chá»‰<textarea rows="2" [ngModel]="orderDraft()?.address" (ngModelChange)="setDraftField('address',$event)"></textarea></label>
            <label>Sá»‘ lÆ°á»£ng<input type="number" min="1" [ngModel]="orderDraft()?.quantity" (ngModelChange)="setDraftField('quantity',$event)"/></label>
            <label>Ad Group<input [ngModel]="orderDraft()?.adGroupId" (ngModelChange)="setDraftField('adGroupId',$event)"/></label>
            <label>Äáº¡i lÃ½
              <select [ngModel]="orderDraft()?.agentId" (ngModelChange)="setDraftField('agentId',$event)">
                <option value="">-- Chá»n Ä‘áº¡i lÃ½ --</option>
                <option *ngFor="let a of agents()" [value]="a._id">{{ a.fullName }} ({{ a.role }})</option>
              </select>
            </label>
            <label>Ghi chÃº<textarea rows="2" [ngModel]="orderDraft()?.notes" (ngModelChange)="setDraftField('notes',$event)"></textarea></label>
          </div>
          <div class="draft-actions">
            <div class="action-row">
              <button class="mini secondary" (click)="extractOrder()" [disabled]="orderExtractLoading()">
                ğŸ” QuÃ©t láº¡i
              </button>
              <button class="mini secondary" (click)="saveDraft('draft')">
                ğŸ’¾ LÆ°u nhÃ¡p
              </button>
            </div>
            <div class="action-row">
              <button class="mini primary" (click)="saveDraft('awaiting')">
                ğŸ“¤ Gá»­i duyá»‡t
              </button>
              <button class="btn primary" (click)="approve()" [disabled]="approveLoading() || !orderDraft()?._id || orderDraft()?.status==='approved'">
                âœ… Duyá»‡t & Táº¡o
              </button>
            </div>
          </div>
          <div class="status-box" *ngIf="orderDraft()" [class]="'status-' + (orderDraft()?.status || 'draft')">
            <div class="status-indicator"></div>
            <span>{{ getStatusText(orderDraft()?.status || 'draft') }}</span>
          </div>
        </div>
      </div>
      <ng-template #loadingTpl><div class="loading">Äang táº£i...</div></ng-template>
    </div>
  </div>
</div>
