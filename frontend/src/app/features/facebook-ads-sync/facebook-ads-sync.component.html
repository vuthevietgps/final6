<!-- facebook-ads-sync.component.html -->
<div class="facebook-sync-container">
  <div class="header">
    <h2>ğŸ”„ Äá»“ng Bá»™ Chi PhÃ­ Facebook Ads</h2>
    <p class="description">
      Tá»± Ä‘á»™ng cáº­p nháº­t chi phÃ­ quáº£ng cÃ¡o tá»« Facebook Marketing API vÃ o há»‡ thá»‘ng
    </p>
  </div>

  <!-- Configuration Form -->
  <div class="config-section">
    <!-- Section 1: Time Selection -->
    <div class="config-card">
      <h3>â° Cáº¥u HÃ¬nh Thá»i Gian</h3>
      
      <div class="form-group">
        <label for="syncType"><strong>Loáº¡i Äá»“ng Bá»™</strong></label>
        <select
          id="syncType"
          [(ngModel)]="syncType"
          (change)="onSyncTypeChange()"
          class="form-control"
          [disabled]="loading()"
        >
          <option value="yesterday">ğŸ“… NgÃ y hÃ´m qua</option>
          <option value="lastWeek">ğŸ“† Tuáº§n trÆ°á»›c (7 ngÃ y)</option>
          <option value="range">ğŸ—“ï¸ Khoáº£ng thá»i gian tÃ¹y chá»n</option>
          <option value="all">ğŸŒ Táº¥t cáº£ dá»¯ liá»‡u</option>
        </select>
      </div>

      <!-- Date Range Selection -->
      <div class="form-row horizontal" *ngIf="syncType === 'range'">
        <div class="form-group">
          <label><strong>Tá»« ngÃ y</strong></label>
          <input
            type="date"
            [(ngModel)]="dateFrom"
            class="form-control"
            [disabled]="loading()"
          />
        </div>

        <div class="form-group">
          <label><strong>Äáº¿n ngÃ y</strong></label>
          <input
            type="date"
            [(ngModel)]="dateTo"
            class="form-control"
            [disabled]="loading()"
          />
        </div>
      </div>
    </div>

    <!-- Divider -->
    <div class="section-divider"></div>

    <!-- Section 2: Account & Token Selection -->
    <div class="config-card">
      <h3>ğŸ”‘ Cáº¥u HÃ¬nh TÃ i Khoáº£n</h3>
      
      <div class="form-group">
        <label for="tokenId"><strong>Facebook Access Token *</strong></label>
        <select
          id="tokenId"
          [(ngModel)]="selectedTokenId"
          class="form-control"
          [disabled]="loading()"
        >
          <option value="">-- Chá»n token --</option>
          <option *ngFor="let token of availableTokens()" [value]="token._id">
            {{ token.name }} 
            <span *ngIf="token.isDefault">(Máº·c Ä‘á»‹nh)</span>
            <span *ngIf="!token.isActive" class="inactive">(KhÃ´ng hoáº¡t Ä‘á»™ng)</span>
          </option>
        </select>
        <small class="help-text">
          Token sáº½ Ä‘Æ°á»£c láº¥y tá»« database vÃ  Ä‘Æ°á»£c mÃ£ hÃ³a báº£o máº­t
        </small>
      </div>

      <div class="form-group">
        <label for="accountId"><strong>TÃ i Khoáº£n Quáº£ng CÃ¡o</strong></label>
        <select
          id="accountId"
          [(ngModel)]="selectedAccountId"
          class="form-control"
          [disabled]="loading()"
        >
          <option value="">-- Chá»n tÃ i khoáº£n --</option>
          <option *ngFor="let account of adAccounts()" [value]="account.accountId">
            {{ account.name }} ({{ account.accountId }})
          </option>
        </select>
        <small class="help-text">
          Äá»ƒ trá»‘ng Ä‘á»ƒ Ä‘á»“ng bá»™ táº¥t cáº£ tÃ i khoáº£n
        </small>
      </div>
    </div>
  </div>

  <!-- Actions -->
  <div class="actions-section">
    <div class="actions">
      <button
        class="btn btn-primary btn-large"
        (click)="syncData()"
        [disabled]="loading() || !selectedTokenId"
      >
        <span *ngIf="loading()">â³ Äang Ä‘á»“ng bá»™...</span>
        <span *ngIf="!loading()">ğŸš€ Báº¯t Ä‘áº§u Ä‘á»“ng bá»™</span>
      </button>

      <button
        class="btn btn-secondary"
        (click)="testConnection()"
        [disabled]="loading() || !selectedTokenId || !selectedAccountId"
      *ngIf="syncType === 'account'"
    >
      ğŸ” Test káº¿t ná»‘i
    </button>

    <button
      class="btn btn-outline"
      (click)="clearResults()"
      [disabled]="loading()"
      *ngIf="syncResult() || error()"
    >
      ğŸ—‘ï¸ XÃ³a káº¿t quáº£
    </button>
    </div>
  </div>

  <!-- Error Message -->
  <div class="alert alert-error" *ngIf="error()">
    <strong>âŒ Lá»—i:</strong> {{ error() }}
  </div>

  <!-- Success Results -->
  <div class="results-section" *ngIf="syncResult()">
    <h3>ğŸ“Š Káº¿t Quáº£ Äá»“ng Bá»™</h3>
    
    <div class="stats-grid">
      <div class="stat-card success">
        <div class="stat-number">{{ syncResult()!.success }}</div>
        <div class="stat-label">ThÃ nh cÃ´ng</div>
      </div>
      <div class="stat-card error" *ngIf="syncResult()!.failed > 0">
        <div class="stat-number">{{ syncResult()!.failed }}</div>
        <div class="stat-label">Tháº¥t báº¡i</div>
      </div>
      <div class="stat-card info">
        <div class="stat-number">{{ getTotalSpend() | currency:'VND' }}</div>
        <div class="stat-label">Tá»•ng chi phÃ­</div>
      </div>
      <div class="stat-card info">
        <div class="stat-number">{{ syncResult()!.synced.length }}</div>
        <div class="stat-label">Adset Ä‘á»“ng bá»™</div>
      </div>
    </div>

    <!-- Detailed Results -->
    <div class="detailed-results" *ngIf="syncResult()!.synced.length > 0">
      <h4>ğŸ“‹ Chi Tiáº¿t Adset ÄÃ£ Äá»“ng Bá»™</h4>
      <div class="results-table">
        <table>
          <thead>
            <tr>
              <th>Adset ID</th>
              <th>NgÃ y</th>
              <th>Chi phÃ­</th>
              <th>CPM</th>
              <th>CPC</th>
              <th>LÆ°á»£t hiá»ƒn thá»‹</th>
              <th>LÆ°á»£t click</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of syncResult()!.synced">
              <td>{{ item.adGroupId }}</td>
              <td>{{ formatDate(item.date) }}</td>
              <td>{{ formatCurrency(item.spend) }}</td>
              <td>{{ item.cpm.toFixed(2) }}</td>
              <td>{{ item.cpc.toFixed(2) }}</td>
              <td>{{ item.impressions | number }}</td>
              <td>{{ item.clicks | number }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Error Details -->
    <div class="error-details" *ngIf="syncResult()!.errors.length > 0">
      <h4>âš ï¸ Chi Tiáº¿t Lá»—i</h4>
      <ul class="error-list">
        <li *ngFor="let error of syncResult()!.errors">{{ error }}</li>
      </ul>
    </div>
  </div>

  <!-- Help Section -->
  <div class="help-section">
    <h3>ğŸ“š HÆ°á»›ng Dáº«n</h3>
    <div class="help-content">
      <p><strong>1. Láº¥y Facebook Access Token:</strong></p>
      <ul>
        <li>Truy cáº­p <a href="https://developers.facebook.com/apps" target="_blank">Facebook Developers</a></li>
        <li>Chá»n á»©ng dá»¥ng â†’ Marketing API â†’ Tools â†’ Graph API Explorer</li>
        <li>Chá»n permissions: ads_read, ads_management</li>
        <li>Generate Access Token vÃ  copy</li>
      </ul>

      <p><strong>2. Cron Job Tá»± Äá»™ng:</strong></p>
      <ul>
        <li>ğŸ“… HÃ ng ngÃ y lÃºc 9:00 AM: Sync ngÃ y hÃ´m qua</li>
        <li>ğŸ“† Chá»§ nháº­t lÃºc 10:00 AM: Sync láº¡i cáº£ tuáº§n</li>
        <li>Cáº§n cáº¥u hÃ¬nh FACEBOOK_ACCESS_TOKEN trong environment</li>
      </ul>

      <p><strong>3. LÆ°u Ã:</strong></p>
      <ul>
        <li>Chi phÃ­ sáº½ Ä‘Æ°á»£c lÆ°u vÃ o module "Chi PhÃ­ Quáº£ng CÃ¡o"</li>
        <li>Dá»¯ liá»‡u trÃ¹ng láº·p sáº½ Ä‘Æ°á»£c cáº­p nháº­t (khÃ´ng táº¡o má»›i)</li>
        <li>Impressions Ä‘Æ°á»£c lÆ°u trong trÆ°á»ng "Táº§n suáº¥t"</li>
      </ul>
    </div>
  </div>
</div>