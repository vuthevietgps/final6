<div class="quote-container">
  <!-- Header with stats -->
  <div class="header-section">
    <div class="page-title">
      <h2>üìä B√°o Gi√° ƒê·∫°i L√Ω</h2>
      <p>Qu·∫£n l√Ω b√°o gi√° s·∫£n ph·∫©m cho c√°c ƒë·∫°i l√Ω</p>
    </div>
    
    <!-- Stats Cards -->
    <div class="stats-container">
      <div class="stat-card total">
        <div class="stat-icon">üìã</div>
        <div class="stat-content">
          <h3>{{ stats().total }}</h3>
          <p>T·ªïng b√°o gi√°</p>
        </div>
      </div>
      
      <div class="stat-card pending">
        <div class="stat-icon">‚è≥</div>
        <div class="stat-content">
          <h3>{{ stats().pending }}</h3>
          <p>Ch·ªù duy·ªát</p>
        </div>
      </div>
      
      <div class="stat-card approved">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-content">
          <h3>{{ stats().approved }}</h3>
          <p>ƒê√£ duy·ªát</p>
        </div>
      </div>
      
      <div class="stat-card rate">
        <div class="stat-icon">üìà</div>
        <div class="stat-content">
          <h3>{{ stats().approvalRate }}%</h3>
          <p>T·ª∑ l·ªá duy·ªát</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls-section">
    <div class="search-controls">
      <input 
        type="text" 
        class="search-input" 
        placeholder="T√¨m ki·∫øm theo s·∫£n ph·∫©m, ƒë·∫°i l√Ω..."
        [ngModel]="searchTerm()"
        (ngModelChange)="searchTerm.set($event)"
      >
      
      <select 
        class="status-filter"
        [ngModel]="statusFilter()"
        (ngModelChange)="statusFilter.set($event)"
      >
        <option value="all">T·∫•t c·∫£ tr·∫°ng th√°i</option>
        <option value="Ch·ªù duy·ªát">Ch·ªù duy·ªát</option>
        <option value="ƒê√£ duy·ªát">ƒê√£ duy·ªát</option>
        <option value="T·ª´ ch·ªëi">T·ª´ ch·ªëi</option>
        <option value="H·∫øt hi·ªáu l·ª±c">H·∫øt hi·ªáu l·ª±c</option>
      </select>
    </div>
    
    <button 
      class="btn-primary add-btn" 
      (click)="openCreateModal()"
      [disabled]="isLoading()"
    >
      <span class="btn-icon">‚ûï</span>
      Th√™m B√°o Gi√° M·ªõi
    </button>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading()" class="loading-container">
    <div class="loading-spinner"></div>
    <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
  </div>

  <!-- Quotes Table -->
  <div *ngIf="!isLoading()" class="table-container">
    <table class="quotes-table">
      <thead>
        <tr>
          <th>S·∫£n ph·∫©m</th>
          <th>ƒê·∫°i l√Ω</th>
          <th>Gi√° b√°o</th>
          <th>Tr·∫°ng th√°i</th>
          <th>Ng√†y h·∫øt h·∫°n</th>
          <th>Ng√†y t·∫°o</th>
          <th>Thao t√°c</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let quote of filteredQuotes(); trackBy: trackByQuoteId" class="quote-row">
          <td class="product-cell">
            <div class="product-info">
              <span class="product-name">{{ getProductName(quote.productId) }}</span>
              <span class="product-sku" *ngIf="typeof quote.productId !== 'string' && quote.productId?.sku">{{ quote.productId.sku }}</span>
            </div>
          </td>
          
          <td class="agent-cell">
            <div class="agent-info">
              <span class="agent-name">{{ getAgentName(quote.agentId) }}</span>
              <span class="agent-role" *ngIf="typeof quote.agentId !== 'string' && quote.agentId?.role">{{ quote.agentId.role }}</span>
            </div>
          </td>
          
          <td class="price-cell">
            <span class="price">{{ formatPrice(quote.unitPrice) }}</span>
          </td>
          
          <td class="status-cell">
            <span 
              class="status-badge" 
              [style.background-color]="getStatusColor(quote.status)"
            >
              {{ quote.status }}
            </span>
          </td>
          
          <td class="date-cell">
            {{ formatDate(quote.validUntil) }}
          </td>
          
          <td class="date-cell">
            {{ formatDate(quote.createdAt!) }}
          </td>
          
          <td class="actions-cell">
            <button 
              class="btn-icon edit-btn" 
              (click)="openEditModal(quote)"
              title="Ch·ªânh s·ª≠a"
            >
              ‚úèÔ∏è
            </button>
            <button 
              class="btn-icon delete-btn" 
              (click)="deleteQuote(quote._id!)"
              title="X√≥a"
            >
              üóëÔ∏è
            </button>
          </td>
        </tr>
        
        <tr *ngIf="filteredQuotes().length === 0" class="no-data-row">
          <td colspan="7" class="no-data-cell">
            <div class="no-data-message">
              <span class="no-data-icon">üì≠</span>
              <p>Kh√¥ng c√≥ b√°o gi√° n√†o</p>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Quote Modal -->
<div class="modal fade" #quoteModal id="quoteModal" tabindex="-1" aria-labelledby="quoteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="quoteModalLabel">
          {{ isEditMode() ? '‚úèÔ∏è Ch·ªânh S·ª≠a B√°o Gi√°' : '‚ûï Th√™m B√°o Gi√° M·ªõi' }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <form [formGroup]="quoteForm" (ngSubmit)="onSubmit()">
        <div class="modal-body">
          <div class="form-grid">
            <!-- Product Selection -->
            <div class="form-group">
              <label for="productId">S·∫£n ph·∫©m *</label>
              <select 
                id="productId" 
                class="form-control"
                formControlName="productId"
                [class.is-invalid]="quoteForm.get('productId')?.invalid && quoteForm.get('productId')?.touched"
              >
                <option value="">Ch·ªçn s·∫£n ph·∫©m</option>
                <option *ngFor="let product of products()" [value]="product._id">
                  {{ product.name }} ({{ product.sku }}) - {{ formatPrice(product.price) }}
                </option>
              </select>
              <div class="invalid-feedback" *ngIf="quoteForm.get('productId')?.invalid && quoteForm.get('productId')?.touched">
                Vui l√≤ng ch·ªçn s·∫£n ph·∫©m
              </div>
            </div>

            <!-- Agent Selection -->
            <div class="form-group">
              <label for="agentId">ƒê·∫°i l√Ω *</label>
              
              <!-- Checkbox √°p d·ª•ng cho t·∫•t c·∫£ -->
              <div class="apply-all-checkbox">
                <input 
                  type="checkbox" 
                  id="applyToAllAgents"
                  formControlName="applyToAllAgents"
                  (change)="onApplyToAllChanged($event)"
                >
                <label for="applyToAllAgents" class="checkbox-label">
                  ‚úÖ √Åp d·ª•ng cho t·∫•t c·∫£ ƒë·∫°i l√Ω
                </label>
              </div>
              
              <select 
                id="agentId" 
                class="form-control"
                formControlName="agentId"
                [disabled]="quoteForm.get('applyToAllAgents')?.value"
                [class.is-invalid]="quoteForm.get('agentId')?.invalid && quoteForm.get('agentId')?.touched && !quoteForm.get('applyToAllAgents')?.value"
              >
                <option value="">
                  {{ quoteForm.get('applyToAllAgents')?.value ? '√Åp d·ª•ng cho t·∫•t c·∫£ ƒë·∫°i l√Ω' : 'Ch·ªçn ƒë·∫°i l√Ω' }}
                </option>
                <option *ngFor="let agent of agents()" [value]="agent._id">
                  {{ agent.fullName }}
                </option>
              </select>
              <div class="invalid-feedback" *ngIf="quoteForm.get('agentId')?.invalid && quoteForm.get('agentId')?.touched && !quoteForm.get('applyToAllAgents')?.value">
                Vui l√≤ng ch·ªçn ƒë·∫°i l√Ω ho·∫∑c ch·ªçn "√Åp d·ª•ng cho t·∫•t c·∫£"
              </div>
              
              <small class="form-text text-muted" *ngIf="quoteForm.get('applyToAllAgents')?.value">
                B√°o gi√° s·∫Ω ƒë∆∞·ª£c t·∫°o cho t·∫•t c·∫£ ƒë·∫°i l√Ω hi·ªán t·∫°i. B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a ri√™ng t·ª´ng ƒë·∫°i l√Ω sau.
              </small>
            </div>

            <!-- Unit Price -->
            <div class="form-group">
              <label for="unitPrice">Gi√° b√°o (VNƒê) *</label>
              <input 
                type="number" 
                id="unitPrice" 
                class="form-control"
                formControlName="unitPrice"
                placeholder="Nh·∫≠p gi√° b√°o"
                min="0"
                step="1000"
                [class.is-invalid]="quoteForm.get('unitPrice')?.invalid && quoteForm.get('unitPrice')?.touched"
              >
              <div class="invalid-feedback" *ngIf="quoteForm.get('unitPrice')?.invalid && quoteForm.get('unitPrice')?.touched">
                Vui l√≤ng nh·∫≠p gi√° h·ª£p l·ªá (‚â• 0)
              </div>
            </div>

            <!-- Valid From -->
            <div class="form-group">
              <label for="validFrom">C√≥ hi·ªáu l·ª±c t·ª´ *</label>
              <input 
                type="date" 
                id="validFrom" 
                class="form-control"
                formControlName="validFrom"
                [class.is-invalid]="quoteForm.get('validFrom')?.invalid && quoteForm.get('validFrom')?.touched"
              >
              <div class="invalid-feedback" *ngIf="quoteForm.get('validFrom')?.invalid && quoteForm.get('validFrom')?.touched">
                Vui l√≤ng ch·ªçn ng√†y b·∫Øt ƒë·∫ßu hi·ªáu l·ª±c
              </div>
            </div>

            <!-- Valid Until -->
            <div class="form-group">
              <label for="validUntil">C√≥ hi·ªáu l·ª±c ƒë·∫øn *</label>
              <input 
                type="date" 
                id="validUntil" 
                class="form-control"
                formControlName="validUntil"
                [class.is-invalid]="quoteForm.get('validUntil')?.invalid && quoteForm.get('validUntil')?.touched"
              >
              <div class="invalid-feedback" *ngIf="quoteForm.get('validUntil')?.invalid && quoteForm.get('validUntil')?.touched">
                Vui l√≤ng ch·ªçn ng√†y k·∫øt th√∫c hi·ªáu l·ª±c
              </div>
            </div>

            <!-- Status -->
            <div class="form-group">
              <label for="status">Tr·∫°ng th√°i *</label>
              <select 
                id="status" 
                class="form-control"
                formControlName="status"
                [class.is-invalid]="quoteForm.get('status')?.invalid && quoteForm.get('status')?.touched"
              >
                <option *ngFor="let option of statusOptions" [value]="option.value">
                  {{ option.label }}
                </option>
              </select>
              <div class="invalid-feedback" *ngIf="quoteForm.get('status')?.invalid && quoteForm.get('status')?.touched">
                Vui l√≤ng ch·ªçn tr·∫°ng th√°i
              </div>
            </div>

            <!-- Notes -->
            <div class="form-group full-width">
              <label for="notes">Ghi ch√∫</label>
              <textarea 
                id="notes" 
                class="form-control"
                formControlName="notes"
                rows="3"
                placeholder="Nh·∫≠p ghi ch√∫ (t√πy ch·ªçn)"
                maxlength="500"
                [class.is-invalid]="quoteForm.get('notes')?.invalid && quoteForm.get('notes')?.touched"
              ></textarea>
              <div class="char-count">{{ quoteForm.get('notes')?.value?.length || 0 }}/500</div>
              <div class="invalid-feedback" *ngIf="quoteForm.get('notes')?.invalid && quoteForm.get('notes')?.touched">
                Ghi ch√∫ kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 500 k√Ω t·ª±
              </div>
            </div>
          </div>
        </div> <!-- Closing modal-body -->
        
        <div class="modal-footer">
          <button type="button" class="btn-secondary" data-bs-dismiss="modal">
            H·ªßy
          </button>
          <button 
            type="submit" 
            class="btn-primary"
            [disabled]="quoteForm.invalid || isLoading()"
          >
            <span *ngIf="isLoading()" class="loading-spinner small"></span>
            {{ isEditMode() ? 'C·∫≠p nh·∫≠t' : 'T·∫°o m·ªõi' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
