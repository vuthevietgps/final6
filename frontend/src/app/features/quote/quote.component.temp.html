<!-- Quote Modal -->
<div class="modal fade" #quoteModal id="quoteModal" tabindex="-1" aria-labelledby="quoteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="quoteModalLabel">
          {{ isEditMode() ? '✏️ Chỉnh Sửa Báo Giá' : '➕ Thêm Báo Giá Mới' }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <form [formGroup]="quoteForm" (ngSubmit)="onSubmit()">
        <div class="modal-body">
          <div class="form-grid">
            <!-- Product Selection -->
            <div class="form-group">
              <label for="productId">Sản phẩm *</label>
              <select 
                id="productId" 
                class="form-control"
                formControlName="productId"
                [class.is-invalid]="quoteForm.get('productId')?.invalid && quoteForm.get('productId')?.touched"
              >
                <option value="">Chọn sản phẩm</option>
                <option *ngFor="let product of products()" [value]="product._id">
                  {{ product.name }} ({{ product.sku }}) - {{ formatPrice(product.price) }}
                </option>
              </select>
              <div class="invalid-feedback" *ngIf="quoteForm.get('productId')?.invalid && quoteForm.get('productId')?.touched">
                Vui lòng chọn sản phẩm
              </div>
            </div>

            <!-- Agent Selection -->
            <div class="form-group">
              <label for="agentId">Đại lý *</label>
              
              <!-- Checkbox áp dụng cho tất cả -->
              <div class="apply-all-checkbox">
                <input 
                  type="checkbox" 
                  id="applyToAllAgents"
                  formControlName="applyToAllAgents"
                >
                <label for="applyToAllAgents" class="checkbox-label">
                  ✅ Áp dụng cho tất cả đại lý
                </label>
              </div>
              
              <select 
                id="agentId" 
                class="form-control"
                formControlName="agentId"
                [disabled]="quoteForm.get('applyToAllAgents')?.value"
                [class.is-invalid]="quoteForm.get('agentId')?.invalid && quoteForm.get('agentId')?.touched && !quoteForm.get('applyToAllAgents')?.value"
              >
                <option value="">
                  {{ quoteForm.get('applyToAllAgents')?.value ? 'Áp dụng cho tất cả đại lý' : 'Chọn đại lý' }}
                </option>
                <option *ngFor="let agent of agents()" [value]="agent._id">
                  {{ agent.fullName }}
                </option>
              </select>
              <div class="invalid-feedback" *ngIf="quoteForm.get('agentId')?.invalid && quoteForm.get('agentId')?.touched && !quoteForm.get('applyToAllAgents')?.value">
                Vui lòng chọn đại lý hoặc chọn "Áp dụng cho tất cả"
              </div>
              
              <small class="form-text text-muted" *ngIf="quoteForm.get('applyToAllAgents')?.value">
                Báo giá sẽ được tạo cho tất cả đại lý hiện tại. Bạn có thể chỉnh sửa riêng từng đại lý sau.
              </small>
            </div>

            <!-- Unit Price -->
            <div class="form-group">
              <label for="unitPrice">Giá báo (VNĐ) *</label>
              <input 
                type="number" 
                id="unitPrice" 
                class="form-control"
                formControlName="unitPrice"
                placeholder="Nhập giá báo"
                min="0"
                step="1000"
                [class.is-invalid]="quoteForm.get('unitPrice')?.invalid && quoteForm.get('unitPrice')?.touched"
              >
              <div class="invalid-feedback" *ngIf="quoteForm.get('unitPrice')?.invalid && quoteForm.get('unitPrice')?.touched">
                Vui lòng nhập giá hợp lệ (≥ 0)
              </div>
            </div>

            <!-- Valid From -->
            <div class="form-group">
              <label for="validFrom">Có hiệu lực từ *</label>
              <input 
                type="date" 
                id="validFrom" 
                class="form-control"
                formControlName="validFrom"
                [class.is-invalid]="quoteForm.get('validFrom')?.invalid && quoteForm.get('validFrom')?.touched"
              >
              <div class="invalid-feedback" *ngIf="quoteForm.get('validFrom')?.invalid && quoteForm.get('validFrom')?.touched">
                Vui lòng chọn ngày bắt đầu hiệu lực
              </div>
            </div>

            <!-- Valid Until -->
            <div class="form-group">
              <label for="validUntil">Có hiệu lực đến *</label>
              <input 
                type="date" 
                id="validUntil" 
                class="form-control"
                formControlName="validUntil"
                [class.is-invalid]="quoteForm.get('validUntil')?.invalid && quoteForm.get('validUntil')?.touched"
              >
              <div class="invalid-feedback" *ngIf="quoteForm.get('validUntil')?.invalid && quoteForm.get('validUntil')?.touched">
                Vui lòng chọn ngày kết thúc hiệu lực
              </div>
            </div>

            <!-- Notes -->
            <div class="form-group full-width">
              <label for="notes">Ghi chú</label>
              <textarea 
                id="notes" 
                class="form-control"
                formControlName="notes"
                rows="3"
                placeholder="Nhập ghi chú (tùy chọn)"
                maxlength="500"
                [class.is-invalid]="quoteForm.get('notes')?.invalid && quoteForm.get('notes')?.touched"
              ></textarea>
              <div class="char-count">{{ quoteForm.get('notes')?.value?.length || 0 }}/500</div>
              <div class="invalid-feedback" *ngIf="quoteForm.get('notes')?.invalid && quoteForm.get('notes')?.touched">
                Ghi chú không được vượt quá 500 ký tự
              </div>
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn-secondary" data-bs-dismiss="modal">
            Hủy
          </button>
          <button 
            type="submit" 
            class="btn-primary"
            [disabled]="quoteForm.invalid || isLoading()"
          >
            <span *ngIf="isLoading()" class="loading-spinner small"></span>
            {{ isEditMode() ? 'Cập nhật' : 'Tạo mới' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>