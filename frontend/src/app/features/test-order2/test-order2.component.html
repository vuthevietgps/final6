<div class="test-order2-page">
  <div class="toolbar">
    <div class="left">
      <button class="btn btn-primary" (click)="addNew()" aria-label="ThÃªm Ä‘Æ¡n má»›i">â• ThÃªm má»›i</button>
      <button class="btn" (click)="refresh()" aria-label="LÃ m má»›i dá»¯ liá»‡u">ğŸ”„ LÃ m má»›i</button>
      <button class="btn btn-success" (click)="downloadCSV()" aria-label="Táº£i CSV">ğŸ“¥ Táº£i CSV</button>
      <button class="btn btn-warning" (click)="openUploadModal()" aria-label="Táº£i lÃªn & Cáº­p nháº­t">ğŸ“¤ Táº£i lÃªn & Cáº­p
        nháº­t</button>
      <button class="btn btn-info" (click)="openDeliveryModal()" aria-label="Cáº­p nháº­t Tráº¡ng thÃ¡i Giao hÃ ng">ğŸšš Cáº­p nháº­t TT Giao hÃ ng (7 cá»™t)</button>
      <button class="btn btn-danger" (click)="downloadPendingDelivery()" aria-label="Táº£i xuá»‘ng Ä‘Æ¡n chÆ°a giao thÃ nh cÃ´ng">âŒ ChÆ°a Giao ThÃ nh CÃ´ng</button>
    </div>
    <div class="stats">
      <span class="badge">Tá»•ng: {{ stats().total }}</span>
      <span class="badge info">Äang hiá»ƒn thá»‹: {{ stats().filtered }}</span>
      <span class="badge success">KÃ­ch hoáº¡t: {{ stats().active }}</span>
    </div>
  </div>

  <div class="filters-grid">
    <input class="input" type="text" placeholder="TÃ¬m KH/SÄT/mÃ£ váº­n Ä‘Æ¡n" [ngModel]="q()"
      (ngModelChange)="onFilterChange('q', $event)" />
    <select class="select" [ngModel]="selectedProduct()" (ngModelChange)="onFilterChange('product', $event)">
      <option value="all">Sáº£n pháº©m: Táº¥t cáº£</option>
      <option *ngFor="let p of products()" [value]="p._id">{{ p.name }}</option>
    </select>
    <select class="select" [ngModel]="selectedAgent()" (ngModelChange)="onFilterChange('agent', $event)">
      <option value="all">Äáº¡i lÃ½: Táº¥t cáº£</option>
      <option *ngFor="let a of agents()" [value]="a._id">{{ a.name }}</option>
    </select>
    <select class="select" [ngModel]="selectedAdGroup()" (ngModelChange)="onFilterChange('adGroup', $event)">
      <option value="all">ID NhÃ³m QC: Táº¥t cáº£</option>
      <option *ngFor="let g of adGroups()" [value]="g._id">{{ g._id }}</option>
    </select>

    <select class="select status-select" [ngModel]="selectedProductionStatus()"
      (ngModelChange)="onFilterChange('productionStatus', $event)">
      <option value="all">TT Sáº£n xuáº¥t: Táº¥t cáº£</option>
      <option *ngFor="let s of productionStatuses()" [value]="s" [ngStyle]="getStatusOptionStyle('prod', s)">{{ s }}
      </option>
    </select>
    <select class="select status-select" [ngModel]="selectedOrderStatus()"
      (ngModelChange)="onFilterChange('orderStatus', $event)">
      <option value="all">TT Váº­n Ä‘Æ¡n: Táº¥t cáº£</option>
      <option *ngFor="let s of orderStatuses()" [value]="s" [ngStyle]="getStatusOptionStyle('del', s)">{{ s }}</option>
    </select>
    <select class="select" [ngModel]="selectedActive()" (ngModelChange)="onFilterChange('active', $event)">
      <option value="all">Tráº¡ng thÃ¡i: Táº¥t cáº£</option>
      <option value="true">Äang hoáº¡t Ä‘á»™ng</option>
      <option value="false">Ngá»«ng</option>
    </select>
    <input class="input date-input" type="date" [ngModel]="from()" (ngModelChange)="onFilterChange('from', $event)" title="Tá»« ngÃ y" />
    <input class="input date-input" type="date" [ngModel]="to()" (ngModelChange)="onFilterChange('to', $event)" title="Äáº¿n ngÃ y" />
    <div class="filter-actions">
      <button class="btn btn-outline" (click)="resetFilters()">â†º Äáº·t láº¡i</button>
      <button class="btn btn-search" (click)="refresh()">ğŸ” TÃ¬m kiáº¿m</button>
    </div>
  </div>

  <!-- Split layout: fixed left (3 cols) + scrollable right -->
  <div class="split-table" *ngIf="!isLoading(); else loadingTpl">
    <div class="fixed-pane" #fixedPane (scroll)="onFixedScroll($event)">
      <table class="fixed-table">
        <thead>
          <tr>
            <th class="col-date">NgÃ y</th>
            <th class="col-customer">KH</th>
            <th class="col-product">SP</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let o of orders(); trackBy: trackById; let i = index" [class.alt]="i % 2 === 1">
            <td class="muted col-date">{{ formatDate(o.createdAt) }}</td>
            <td class="col-customer">
              <input type="text" [ngModel]="o.customerName" (blur)="onInputUpdate(o, 'customerName', $event)" />
            </td>
            <td class="col-product">
              <select [ngModel]="getId(o.productId)" (change)="onSelectUpdate(o, 'productId', $event)"
                      [ngStyle]="productSelectStyle(o.productId)" class="status-dropdown">
                <option *ngFor="let p of products()" [value]="p._id" [ngStyle]="getProductOptionStyle(p._id)">{{ p.name }}</option>
              </select>
            </td>
          </tr>
          <tr *ngIf="orders().length===0">
            <td class="center muted" colspan="3">ChÆ°a cÃ³ Ä‘Æ¡n</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="scroll-pane" #scrollPane (scroll)="onScrollPane($event)">
      <table class="scroll-table">
        <thead>
          <tr>
            <th class="col-qty">SL</th>
            <th class="col-agent">Äáº¡i lÃ½</th>
            <th class="col-wide">ID NhÃ³m QC</th>
            <th class="col-active">KÃ­ch hoáº¡t</th>
            <th class="col-wide col-service">Chi tiáº¿t DV</th>
            <th class="col-wide col-prod-status">TT Sáº£n xuáº¥t</th>
            <th class="w-order-status col-order-status">TT Váº­n Ä‘Æ¡n</th>
            <th class="col-wide col-submit-link">Link ná»™p</th>
            <th class="col-tracking">MÃ£ váº­n Ä‘Æ¡n</th>
            <th class="col-wide">Äáº·t cá»c</th>
            <th class="col-wide">COD</th>
            <th class="col-wider">NgÆ°á»i nháº­n</th>
            <th class="col-wide">SÄT</th>
            <th class="col-wider">Äá»‹a chá»‰</th>
            <th class="center col-delete">XÃ³a</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let o of orders(); trackBy: trackById; let i = index" [class.alt]="i % 2 === 1">
            <td class="col-qty"><input class="input-qty" type="number" min="1" [ngModel]="o.quantity"
                (blur)="onInputUpdate(o, 'quantity', $event)" /></td>
            <td class="col-agent">
              <select [ngModel]="getId(o.agentId)" (change)="onSelectUpdate(o, 'agentId', $event)">
                <option *ngFor="let a of agents()" [value]="a._id">{{ a.name }}</option>
              </select>
            </td>
            <td class="col-wide">
              <select [ngModel]="o.adGroupId" (change)="onSelectUpdate(o, 'adGroupId', $event)">
                <option *ngFor="let g of adGroups()" [value]="g._id">{{ g.name }}</option>
              </select>
            </td>
            <td class="col-active text-center">
              <input type="checkbox" [ngModel]="o.isActive" (change)="onInputUpdate(o, 'isActive', $event)" />
            </td>
            <td class="col-wide col-service"><input type="text" [ngModel]="o.serviceDetails" (blur)="onInputUpdate(o, 'serviceDetails', $event)" /></td>
            <td class="col-wide col-prod-status" [ngStyle]="statusCellStyle('prod', o.productionStatus)">
              <select [ngModel]="o.productionStatus" (change)="onSelectUpdate(o, 'productionStatus', $event)"
                [ngStyle]="statusSelectStyle('prod', o.productionStatus)" class="status-dropdown">
                <option *ngFor="let s of productionStatuses()" [value]="s" [ngStyle]="getStatusOptionStyle('prod', s)">{{ s }}</option>
              </select>
            </td>
            <td class="w-order-status col-order-status" [ngStyle]="statusCellStyle('del', o.orderStatus || 'ChÆ°a cÃ³ mÃ£ váº­n Ä‘Æ¡n')">
              <select class="w-100 status-dropdown" [ngModel]="o.orderStatus || 'ChÆ°a cÃ³ mÃ£ váº­n Ä‘Æ¡n'"
                (change)="onSelectUpdate(o, 'orderStatus', $event)"
                [ngStyle]="statusSelectStyle('del', o.orderStatus || 'ChÆ°a cÃ³ mÃ£ váº­n Ä‘Æ¡n')">
                <option *ngFor="let s of orderStatuses()" [value]="s" [ngStyle]="getStatusOptionStyle('del', s)">{{ s }}</option>
              </select>
            </td>
            <td class="col-wide col-submit-link"><input type="text" [ngModel]="o.submitLink" (blur)="onInputUpdate(o, 'submitLink', $event)" /></td>
            <td class="col-tracking"><input type="text" [ngModel]="o.trackingNumber" (blur)="onInputUpdate(o, 'trackingNumber', $event)" /></td>
            <td class="col-wide"><input type="number" min="0" step="1000" [ngModel]="o.depositAmount"
                (blur)="onInputUpdate(o, 'depositAmount', $event)" /></td>
            <td class="col-wide"><input type="number" min="0" step="1000" [ngModel]="o.codAmount"
                (blur)="onInputUpdate(o, 'codAmount', $event)" /></td>
            <td class="col-wider"><input type="text" [ngModel]="o.receiverName" (blur)="onInputUpdate(o, 'receiverName', $event)" /></td>
            <td class="col-wide"><input type="text" [ngModel]="o.receiverPhone" (blur)="onInputUpdate(o, 'receiverPhone', $event)" /></td>
            <td class="col-wider"><input type="text" [ngModel]="o.receiverAddress" (blur)="onInputUpdate(o, 'receiverAddress', $event)" /></td>
            <td class="center col-delete"><button class="btn btn-sm btn-danger" (click)="delete(o)">XÃ³a</button></td>
          </tr>
          <tr *ngIf="orders().length===0">
            <td class="center muted" colspan="15">ChÆ°a cÃ³ Ä‘Æ¡n</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <ng-template #loadingTpl>
    <div class="loading">Äang táº£i...</div>
  </ng-template>

  <!-- Upload Modal -->
  <div *ngIf="isUploadModalOpen()" class="modal-overlay" (click)="closeUploadModal()">
    <div class="modal upload-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>ğŸ“¤ Táº£i lÃªn vÃ  Cáº­p nháº­t ÄÆ¡n hÃ ng</h3>
        <button class="modal-close" (click)="closeUploadModal()">âœ•</button>
      </div>

      <div class="modal-body">
        <div class="upload-section">
          <h4>1. Táº£i Template máº«u</h4>
          <button class="btn btn-secondary" (click)="downloadTemplate()">
            ğŸ“¥ Táº£i template CSV
          </button>
          <p class="help-text">
            Táº£i file template Ä‘á»ƒ cÃ³ Ä‘á»‹nh dáº¡ng Ä‘Ãºng. Äiá»n thÃ´ng tin cáº§n cáº­p nháº­t vÃ  giá»¯ nguyÃªn _id Ä‘á»ƒ cáº­p nháº­t báº£n ghi
            hiá»‡n cÃ³.
          </p>
        </div>

        <div class="upload-section">
          <h4>2. Chá»n file Ä‘á»ƒ táº£i lÃªn</h4>
          <div class="file-drop-zone" (drop)="onFileDrop($event)" (dragover)="onDragOver($event)"
            [class.has-file]="uploadFile()">
            <div *ngIf="!uploadFile(); else fileSelectedTpl" class="drop-message">
              <div class="drop-icon">ğŸ“</div>
              <p>KÃ©o tháº£ file vÃ o Ä‘Ã¢y hoáº·c</p>
              <input type="file" #fileInput (change)="onFileSelected($event)" accept=".csv,.xls,.xlsx"
                style="display: none;">
              <button class="btn btn-outline" (click)="fileInput.click()">>
                Chá»n file
              </button>
              <p class="file-types">Há»— trá»£: CSV, Excel (.xls, .xlsx) - Tá»‘i Ä‘a 10MB</p>
            </div>

            <ng-template #fileSelectedTpl>
              <div class="file-selected">
                <div class="file-icon">ğŸ“„</div>
                <div class="file-info">
                  <strong>{{ uploadFile()?.name }}</strong>
                  <p>{{ (uploadFile()?.size || 0) / 1024 / 1024 | number:'1.2-2' }} MB</p>
                </div>
                <button class="btn btn-sm btn-danger" (click)="uploadFile.set(null)">
                  âœ• XÃ³a
                </button>
              </div>
            </ng-template>
          </div>
        </div>

        <div *ngIf="uploadResults()" class="upload-results">
          <h4>ğŸ“Š Káº¿t quáº£ xá»­ lÃ½</h4>
          <div class="results-summary">
            <div class="result-item success">
              <strong>âœ… ThÃ nh cÃ´ng: {{ uploadResults()?.success || 0 }}</strong>
            </div>
            @if (uploadResults() && uploadResults()!.errors && uploadResults()!.errors.length > 0) {
            <div class="result-item error">
              <strong>âŒ Lá»—i: {{ uploadResults()!.errors.length }}</strong>
            </div>
            }
          </div>

          @if (uploadResults() && uploadResults()!.errors && uploadResults()!.errors.length > 0) {
          <div class="error-details">
            <h5>Chi tiáº¿t lá»—i:</h5>
            <div class="error-list">
              @for (err of uploadResults()!.errors; track err.row) {
              <div class="error-row">
                <strong>DÃ²ng {{ err.row }}:</strong> {{ err.error }}
              </div>
              }
            </div>
          </div>
          }

          <p class="results-message">{{ uploadResults()?.message || '' }}</p>
        </div>

        <div *ngIf="error()" class="error-message">
          âŒ {{ error() }}
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeUploadModal()">
          Há»§y
        </button>
        <button class="btn btn-primary" [disabled]="!uploadFile() || isUploading()" (click)="uploadImportFile()">
          <span *ngIf="isUploading()">ğŸ”„ Äang xá»­ lÃ½...</span>
          <span *ngIf="!isUploading()">ğŸ“¤ Táº£i lÃªn vÃ  Cáº­p nháº­t</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Delivery Status Update Modal -->
  <div *ngIf="isDeliveryModalOpen()" class="modal-overlay" (click)="closeDeliveryModal()">
    <div class="modal delivery-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>ğŸšš Cáº­p nháº­t Tráº¡ng thÃ¡i Giao hÃ ng</h3>
        <button class="modal-close" (click)="closeDeliveryModal()">âœ•</button>
      </div>

      <div class="modal-body">
        <div class="upload-section">
          <h4>1. Táº£i Template (7 cá»™t Ä‘áº§y Ä‘á»§)</h4>
          <button class="btn btn-secondary" (click)="downloadDeliveryTemplate()">
            ğŸ“¥ Táº£i template Excel
          </button>
          <p class="help-text">
            File cÃ³ 7 cá»™t: <strong>ID Ä‘Æ¡n hÃ ng</strong>, <strong>MÃ£ váº­n Ä‘Æ¡n</strong>, <strong>Tráº¡ng thÃ¡i giao hÃ ng</strong>, 
            <strong>Sá»‘ tiá»n COD</strong>, <strong>TÃªn ngÆ°á»i nháº­n</strong>, <strong>SÄT ngÆ°á»i nháº­n</strong>, <strong>Äá»‹a chá»‰ ngÆ°á»i nháº­n</strong>.
          </p>
          <p class="help-text">
            Cáº­p nháº­t 6 cá»™t dá»±a trÃªn ID Ä‘Æ¡n hÃ ng. CÃ³ thá»ƒ Ä‘á»ƒ trá»‘ng cÃ¡c trÆ°á»ng khÃ´ng cáº§n cáº­p nháº­t.
          </p>
        </div>

        <div class="upload-section">
          <h4>2. Táº£i Ä‘Æ¡n hÃ ng chÆ°a giao thÃ nh cÃ´ng</h4>
          <button class="btn btn-info" (click)="downloadPendingDelivery()">
            ğŸ“Š Táº£i Ä‘Æ¡n chÆ°a giao thÃ nh cÃ´ng
          </button>
          <p class="help-text">
            Táº£i file Excel chá»©a táº¥t cáº£ Ä‘Æ¡n hÃ ng chÆ°a giao thÃ nh cÃ´ng Ä‘á»ƒ dá»… dÃ ng cáº­p nháº­t tráº¡ng thÃ¡i.
          </p>
        </div>

        <div class="upload-section">
          <h4>3. Chá»n file Ä‘á»ƒ cáº­p nháº­t tráº¡ng thÃ¡i</h4>
          <div class="file-drop-zone" (drop)="onDeliveryFileDrop($event)" (dragover)="onDragOver($event)"
            [class.has-file]="deliveryUploadFile()">
            <div *ngIf="!deliveryUploadFile(); else deliveryFileSelectedTpl" class="drop-message">
              <div class="drop-icon">ğŸšš</div>
              <p>KÃ©o tháº£ file vÃ o Ä‘Ã¢y hoáº·c</p>
              <input type="file" #deliveryFileInput (change)="onDeliveryFileSelected($event)" accept=".csv,.xls,.xlsx"
                style="display: none;">
              <button class="btn btn-outline" (click)="deliveryFileInput.click()">
                Chá»n file
              </button>
              <p class="file-types">File Excel/CSV vá»›i 7 cá»™t (CSV, Excel: .xls, .xlsx)</p>
            </div>

            <ng-template #deliveryFileSelectedTpl>
              <div class="file-selected">
                <div class="file-icon">ğŸ“„</div>
                <div class="file-info">
                  <strong>{{ deliveryUploadFile()?.name }}</strong>
                  <p>{{ (deliveryUploadFile()?.size || 0) / 1024 / 1024 | number:'1.2-2' }} MB</p>
                </div>
                <button class="btn btn-sm btn-danger" (click)="deliveryUploadFile.set(null)">
                  âœ• XÃ³a
                </button>
              </div>
            </ng-template>
          </div>
        </div>

        <div *ngIf="deliveryUploadResults()" class="upload-results">
          <h4>ğŸ“Š Káº¿t quáº£ cáº­p nháº­t tráº¡ng thÃ¡i</h4>
          <div class="results-summary">
            <div class="result-item success">
              <strong>âœ… ÄÃ£ cáº­p nháº­t: {{ deliveryUploadResults()?.success || 0 }} Ä‘Æ¡n hÃ ng</strong>
            </div>
            @if (deliveryUploadResults() && deliveryUploadResults()!.errors && deliveryUploadResults()!.errors.length > 0) {
            <div class="result-item error">
              <strong>âŒ Lá»—i: {{ deliveryUploadResults()!.errors.length }}</strong>
            </div>
            }
          </div>

          @if (deliveryUploadResults() && deliveryUploadResults()!.errors && deliveryUploadResults()!.errors.length > 0) {
          <div class="error-details">
            <h5>Chi tiáº¿t lá»—i:</h5>
            <div class="error-list">
              @for (err of deliveryUploadResults()!.errors; track err.row) {
              <div class="error-row">
                <strong>DÃ²ng {{ err.row }}:</strong> {{ err.error }}
              </div>
              }
            </div>
          </div>
          }

          <p class="results-message">{{ deliveryUploadResults()?.message || '' }}</p>
        </div>

        <div *ngIf="error()" class="error-message">
          âŒ {{ error() }}
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeDeliveryModal()">
          Há»§y
        </button>
        <button class="btn btn-primary" [disabled]="!deliveryUploadFile() || isDeliveryUploading()" (click)="uploadDeliveryStatusFile()">
          <span *ngIf="isDeliveryUploading()">ğŸ”„ Äang cáº­p nháº­t...</span>
          <span *ngIf="!isDeliveryUploading()">ğŸšš Cáº­p nháº­t Tráº¡ng thÃ¡i</span>
        </button>
      </div>
    </div>
  </div>

<!-- Pagination Controls -->
<div class="pagination-wrapper" *ngIf="!isLoading() && totalItems() > 0">
  <div class="pagination-info">
    Hiá»ƒn thá»‹ {{ (currentPage() - 1) * pageSize() + 1 }} - 
    {{ Math.min(currentPage() * pageSize(), totalItems()) }} 
    trong tá»•ng sá»‘ {{ totalItems() }} káº¿t quáº£
  </div>
  
  <div class="pagination-controls">
    <select [ngModel]="pageSize()" (ngModelChange)="changePageSize($event)" class="page-size-select">
      <option value="10">10/trang</option>
      <option value="25">25/trang</option>
      <option value="50">50/trang</option>
      <option value="100">100/trang</option>
    </select>

    <button class="btn btn-sm" [disabled]="currentPage() <= 1" (click)="goToPage(1)">
      â®ï¸ Äáº§u
    </button>
    <button class="btn btn-sm" [disabled]="currentPage() <= 1" (click)="goToPage(currentPage() - 1)">
      â¬…ï¸ TrÆ°á»›c
    </button>
    
    <span class="page-info">
      Trang {{ currentPage() }} / {{ totalPages() }}
    </span>
    
    <button class="btn btn-sm" [disabled]="currentPage() >= totalPages()" (click)="goToPage(currentPage() + 1)">
      Sau â¡ï¸
    </button>
    <button class="btn btn-sm" [disabled]="currentPage() >= totalPages()" (click)="goToPage(totalPages())">
      Cuá»‘i â­ï¸
    </button>
  </div>
</div>
</div>