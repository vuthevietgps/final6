<div class="test-order2-page">
  <div class="toolbar">
    <div class="left">
      <button class="btn btn-primary" (click)="addNew()" aria-label="ThÃªm Ä‘Æ¡n má»›i">â• ThÃªm má»›i</button>
      <button class="btn" (click)="refresh()" aria-label="LÃ m má»›i dá»¯ liá»‡u">ğŸ”„ LÃ m má»›i</button>
      <button class="btn btn-success" (click)="downloadCSV()" aria-label="Táº£i CSV">ğŸ“¥ Táº£i CSV</button>
      <button class="btn btn-warning" (click)="openUploadModal()" aria-label="Táº£i lÃªn & Cáº­p nháº­t">ğŸ“¤ Táº£i lÃªn & Cáº­p
        nháº­t</button>
    </div>
    <div class="stats">
      <span class="badge">Tá»•ng: {{ stats().total }}</span>
      <span class="badge info">Äang hiá»ƒn thá»‹: {{ stats().filtered }}</span>
      <span class="badge success">KÃ­ch hoáº¡t: {{ stats().active }}</span>
    </div>
  </div>

  <div class="filters-grid">
    <input class="input" type="text" placeholder="TÃ¬m KH/SÄT/mÃ£ váº­n Ä‘Æ¡n" [ngModel]="q()"
      (ngModelChange)="q.set($event)" />
    <select class="select" [ngModel]="selectedProduct()" (ngModelChange)="selectedProduct.set($event)">
      <option value="all">Sáº£n pháº©m: Táº¥t cáº£</option>
      <option *ngFor="let p of products()" [value]="p._id">{{ p.name }}</option>
    </select>
    <select class="select" [ngModel]="selectedAgent()" (ngModelChange)="selectedAgent.set($event)">
      <option value="all">Äáº¡i lÃ½: Táº¥t cáº£</option>
      <option *ngFor="let a of agents()" [value]="a._id">{{ a.name }}</option>
    </select>
    <select class="select" [ngModel]="selectedAdGroup()" (ngModelChange)="selectedAdGroup.set($event)">
      <option value="all">ID NhÃ³m QC: Táº¥t cáº£</option>
      <option *ngFor="let g of adGroups()" [value]="g._id">{{ g._id }}</option>
    </select>

    <select class="select status-select" [ngModel]="selectedProductionStatus()"
      (ngModelChange)="selectedProductionStatus.set($event)">
      <option value="all">TT Sáº£n xuáº¥t: Táº¥t cáº£</option>
      <option *ngFor="let s of productionStatuses()" [value]="s" [ngStyle]="getStatusOptionStyle('prod', s)">{{ s }}
      </option>
    </select>
    <select class="select status-select" [ngModel]="selectedOrderStatus()"
      (ngModelChange)="selectedOrderStatus.set($event)">
      <option value="all">TT Váº­n Ä‘Æ¡n: Táº¥t cáº£</option>
      <option *ngFor="let s of orderStatuses()" [value]="s" [ngStyle]="getStatusOptionStyle('del', s)">{{ s }}</option>
    </select>
    <select class="select" [ngModel]="selectedActive()" (ngModelChange)="selectedActive.set($event)">
      <option value="all">Tráº¡ng thÃ¡i: Táº¥t cáº£</option>
      <option value="true">Äang hoáº¡t Ä‘á»™ng</option>
      <option value="false">Ngá»«ng</option>
    </select>
    <input class="input date-input" type="date" [ngModel]="from()" (ngModelChange)="from.set($event)" title="Tá»« ngÃ y" />
    <input class="input date-input" type="date" [ngModel]="to()" (ngModelChange)="to.set($event)" title="Äáº¿n ngÃ y" />
    <div class="filter-actions">
      <button class="btn btn-outline" (click)="resetFilters()">â†º Äáº·t láº¡i</button>
      <button class="btn btn-search" (click)="refresh()">ğŸ” TÃ¬m kiáº¿m</button>
    </div>
  </div>

  <div class="table-wrapper" *ngIf="!isLoading(); else loadingTpl">
    <table class="data-table" #tableEl>
      <thead>
        <tr>
          <th class="col-date sticky-col" #dateHeader>NgÃ y</th>
          <th class="col-customer sticky-col-2">KH</th>
          <th class="col-product">SP</th>
          <th class="col-qty">SL</th>
          <th class="col-agent">Äáº¡i lÃ½</th>
          <th class="col-wide">ID NhÃ³m QC</th>
          <th class="col-active">KÃ­ch hoáº¡t</th>
          <th class="col-wide">Chi tiáº¿t DV</th>
          <th class="col-wide">TT Sáº£n xuáº¥t</th>
          <th class="w-order-status">TT Váº­n Ä‘Æ¡n</th>
          <th class="col-wide">Link ná»™p</th>
          <th class="col-wide">MÃ£ váº­n Ä‘Æ¡n</th>
          <th class="col-wide">Äáº·t cá»c</th>
          <th class="col-wide">COD</th>
          <th class="col-wider">NgÆ°á»i nháº­n</th>
          <th class="col-wide">SÄT</th>
          <th class="col-wider">Äá»‹a chá»‰</th>
          <th class="center">XÃ³a</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let o of filtered(); trackBy: trackById">
          <td class="muted col-date sticky-col">{{ formatDate(o.createdAt) }}</td>
          <td class="col-customer sticky-col-2"><input type="text" [ngModel]="o.customerName"
              (blur)="onInputUpdate(o, 'customerName', $event)" /></td>
          <td class="col-product">
            <select [ngModel]="getId(o.productId)" (change)="onSelectUpdate(o, 'productId', $event)">
              <option *ngFor="let p of products()" [value]="p._id">{{ p.name }}</option>
            </select>
          </td>
          <td class="col-qty"><input class="input-qty" type="number" min="1" [ngModel]="o.quantity"
              (blur)="onInputUpdate(o, 'quantity', $event)" /></td>
          <td class="col-agent">
            <select [ngModel]="getId(o.agentId)" (change)="onSelectUpdate(o, 'agentId', $event)">
              <option *ngFor="let a of agents()" [value]="a._id">{{ a.name }}</option>
            </select>
          </td>
          <td>
            <select [ngModel]="o.adGroupId" (change)="onSelectUpdate(o, 'adGroupId', $event)">
              <option *ngFor="let g of adGroups()" [value]="g._id">{{ g.name }}</option>
            </select>
          </td>
          <td class="center col-active"><input type="checkbox" [ngModel]="o.isActive"
              (change)="onInputUpdate(o, 'isActive', $event)" /></td>
          <td><input type="text" [ngModel]="o.serviceDetails" (blur)="onInputUpdate(o, 'serviceDetails', $event)" />
          </td>
          <td [ngStyle]="statusCellStyle('prod', o.productionStatus)">
            <select [ngModel]="o.productionStatus" (change)="onSelectUpdate(o, 'productionStatus', $event)"
              [ngStyle]="statusSelectStyle('prod', o.productionStatus)" class="status-dropdown">
              <option *ngFor="let s of productionStatuses()" [value]="s" [ngStyle]="getStatusOptionStyle('prod', s)">{{
                s }}</option>
            </select>
          </td>
          <td [ngStyle]="statusCellStyle('del', o.orderStatus || 'ChÆ°a cÃ³ mÃ£ váº­n Ä‘Æ¡n')">
            <select class="w-100 status-dropdown" [ngModel]="o.orderStatus || 'ChÆ°a cÃ³ mÃ£ váº­n Ä‘Æ¡n'"
              (change)="onSelectUpdate(o, 'orderStatus', $event)"
              [ngStyle]="statusSelectStyle('del', o.orderStatus || 'ChÆ°a cÃ³ mÃ£ váº­n Ä‘Æ¡n')">
              <option *ngFor="let s of orderStatuses()" [value]="s" [ngStyle]="getStatusOptionStyle('del', s)">{{ s }}
              </option>
            </select>
          </td>
          <td><input type="text" [ngModel]="o.submitLink" (blur)="onInputUpdate(o, 'submitLink', $event)" /></td>
          <td><input type="text" [ngModel]="o.trackingNumber" (blur)="onInputUpdate(o, 'trackingNumber', $event)" />
          </td>
          <td><input type="number" min="0" step="1000" [ngModel]="o.depositAmount"
              (blur)="onInputUpdate(o, 'depositAmount', $event)" /></td>
          <td><input type="number" min="0" step="1000" [ngModel]="o.codAmount"
              (blur)="onInputUpdate(o, 'codAmount', $event)" /></td>
          <td><input type="text" [ngModel]="o.receiverName" (blur)="onInputUpdate(o, 'receiverName', $event)" /></td>
          <td><input type="text" [ngModel]="o.receiverPhone" (blur)="onInputUpdate(o, 'receiverPhone', $event)" /></td>
          <td><input type="text" [ngModel]="o.receiverAddress" (blur)="onInputUpdate(o, 'receiverAddress', $event)" />
          </td>
          <td class="center"><button class="btn btn-sm btn-danger" (click)="delete(o)">XÃ³a</button></td>
        </tr>
        <tr *ngIf="filtered().length===0">
          <td class="center muted" colspan="18">ChÆ°a cÃ³ Ä‘Æ¡n</td>
        </tr>
      </tbody>
    </table>
  </div>

  <ng-template #loadingTpl>
    <div class="loading">Äang táº£i...</div>
  </ng-template>

  <!-- Upload Modal -->
  <div *ngIf="isUploadModalOpen()" class="modal-overlay" (click)="closeUploadModal()">
    <div class="modal upload-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>ğŸ“¤ Táº£i lÃªn vÃ  Cáº­p nháº­t ÄÆ¡n hÃ ng</h3>
        <button class="modal-close" (click)="closeUploadModal()">âœ•</button>
      </div>

      <div class="modal-body">
        <div class="upload-section">
          <h4>1. Táº£i Template máº«u</h4>
          <button class="btn btn-secondary" (click)="downloadTemplate()">
            ğŸ“¥ Táº£i template CSV
          </button>
          <p class="help-text">
            Táº£i file template Ä‘á»ƒ cÃ³ Ä‘á»‹nh dáº¡ng Ä‘Ãºng. Äiá»n thÃ´ng tin cáº§n cáº­p nháº­t vÃ  giá»¯ nguyÃªn _id Ä‘á»ƒ cáº­p nháº­t báº£n ghi
            hiá»‡n cÃ³.
          </p>
        </div>

        <div class="upload-section">
          <h4>2. Chá»n file Ä‘á»ƒ táº£i lÃªn</h4>
          <div class="file-drop-zone" (drop)="onFileDrop($event)" (dragover)="onDragOver($event)"
            [class.has-file]="uploadFile()">
            <div *ngIf="!uploadFile(); else fileSelectedTpl" class="drop-message">
              <div class="drop-icon">ğŸ“</div>
              <p>KÃ©o tháº£ file vÃ o Ä‘Ã¢y hoáº·c</p>
              <input type="file" #fileInput (change)="onFileSelected($event)" accept=".csv,.xls,.xlsx"
                style="display: none;">
              <button class="btn btn-outline" (click)="fileInput.click()">>
                Chá»n file
              </button>
              <p class="file-types">Há»— trá»£: CSV, Excel (.xls, .xlsx) - Tá»‘i Ä‘a 10MB</p>
            </div>

            <ng-template #fileSelectedTpl>
              <div class="file-selected">
                <div class="file-icon">ğŸ“„</div>
                <div class="file-info">
                  <strong>{{ uploadFile()?.name }}</strong>
                  <p>{{ (uploadFile()?.size || 0) / 1024 / 1024 | number:'1.2-2' }} MB</p>
                </div>
                <button class="btn btn-sm btn-danger" (click)="uploadFile.set(null)">
                  âœ• XÃ³a
                </button>
              </div>
            </ng-template>
          </div>
        </div>

        <div *ngIf="uploadResults()" class="upload-results">
          <h4>ğŸ“Š Káº¿t quáº£ xá»­ lÃ½</h4>
          <div class="results-summary">
            <div class="result-item success">
              <strong>âœ… ThÃ nh cÃ´ng: {{ uploadResults()?.success || 0 }}</strong>
            </div>
            @if (uploadResults() && uploadResults()!.errors && uploadResults()!.errors.length > 0) {
            <div class="result-item error">
              <strong>âŒ Lá»—i: {{ uploadResults()!.errors.length }}</strong>
            </div>
            }
          </div>

          @if (uploadResults() && uploadResults()!.errors && uploadResults()!.errors.length > 0) {
          <div class="error-details">
            <h5>Chi tiáº¿t lá»—i:</h5>
            <div class="error-list">
              @for (err of uploadResults()!.errors; track err.row) {
              <div class="error-row">
                <strong>DÃ²ng {{ err.row }}:</strong> {{ err.error }}
              </div>
              }
            </div>
          </div>
          }

          <p class="results-message">{{ uploadResults()?.message || '' }}</p>
        </div>

        <div *ngIf="error()" class="error-message">
          âŒ {{ error() }}
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeUploadModal()">
          Há»§y
        </button>
        <button class="btn btn-primary" [disabled]="!uploadFile() || isUploading()" (click)="uploadImportFile()">
          <span *ngIf="isUploading()">ğŸ”„ Äang xá»­ lÃ½...</span>
          <span *ngIf="!isUploading()">ğŸ“¤ Táº£i lÃªn vÃ  Cáº­p nháº­t</span>
        </button>
      </div>
    </div>
  </div>
</div>