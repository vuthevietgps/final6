<div class="test-order2-page">
  <div class="toolbar">
    <div class="left">
      <button class="btn btn-primary" (click)="addNew()" aria-label="Th√™m ƒë∆°n m·ªõi">‚ûï Th√™m m·ªõi</button>
      <button class="btn" (click)="refresh()" aria-label="L√†m m·ªõi d·ªØ li·ªáu">üîÑ L√†m m·ªõi</button>
      <button class="btn btn-success" (click)="downloadCSV()" aria-label="T·∫£i CSV">üì• T·∫£i CSV</button>
      <button class="btn btn-warning" (click)="openUploadModal()" aria-label="T·∫£i l√™n & C·∫≠p nh·∫≠t">üì§ T·∫£i l√™n & C·∫≠p
        nh·∫≠t</button>
      <button class="btn btn-info" (click)="openDeliveryModal()" aria-label="C·∫≠p nh·∫≠t Tr·∫°ng th√°i Giao h√†ng">üöö C·∫≠p nh·∫≠t TT Giao h√†ng</button>
      <button class="btn btn-danger" (click)="downloadPendingDelivery()" aria-label="T·∫£i xu·ªëng ƒë∆°n ch∆∞a giao th√†nh c√¥ng">‚ùå Ch∆∞a Giao Th√†nh C√¥ng</button>
    </div>
    <div class="stats">
      <span class="badge">T·ªïng: {{ stats().total }}</span>
      <span class="badge info">ƒêang hi·ªÉn th·ªã: {{ stats().filtered }}</span>
      <span class="badge success">K√≠ch ho·∫°t: {{ stats().active }}</span>
    </div>
  </div>

  <div class="filters-grid">
    <input class="input" type="text" placeholder="T√¨m KH/SƒêT/m√£ v·∫≠n ƒë∆°n" [ngModel]="q()"
      (ngModelChange)="onFilterChange('q', $event)" />
    <select class="select" [ngModel]="selectedProduct()" (ngModelChange)="onFilterChange('product', $event)">
      <option value="all">S·∫£n ph·∫©m: T·∫•t c·∫£</option>
      <option *ngFor="let p of products()" [value]="p._id">{{ p.name }}</option>
    </select>
    <select class="select" [ngModel]="selectedAgent()" (ngModelChange)="onFilterChange('agent', $event)">
      <option value="all">ƒê·∫°i l√Ω: T·∫•t c·∫£</option>
      <option *ngFor="let a of agents()" [value]="a._id">{{ a.name }}</option>
    </select>
    <select class="select" [ngModel]="selectedAdGroup()" (ngModelChange)="onFilterChange('adGroup', $event)">
      <option value="all">ID Nh√≥m QC: T·∫•t c·∫£</option>
      <option *ngFor="let g of adGroups()" [value]="g._id">{{ g._id }}</option>
    </select>

    <select class="select status-select" [ngModel]="selectedProductionStatus()"
      (ngModelChange)="onFilterChange('productionStatus', $event)">
      <option value="all">TT S·∫£n xu·∫•t: T·∫•t c·∫£</option>
      <option *ngFor="let s of productionStatuses()" [value]="s" [ngStyle]="getStatusOptionStyle('prod', s)">{{ s }}
      </option>
    </select>
    <select class="select status-select" [ngModel]="selectedOrderStatus()"
      (ngModelChange)="onFilterChange('orderStatus', $event)">
      <option value="all">TT V·∫≠n ƒë∆°n: T·∫•t c·∫£</option>
      <option *ngFor="let s of orderStatuses()" [value]="s" [ngStyle]="getStatusOptionStyle('del', s)">{{ s }}</option>
    </select>
    <select class="select" [ngModel]="selectedActive()" (ngModelChange)="onFilterChange('active', $event)">
      <option value="all">Tr·∫°ng th√°i: T·∫•t c·∫£</option>
      <option value="true">ƒêang ho·∫°t ƒë·ªông</option>
      <option value="false">Ng·ª´ng</option>
    </select>
    <input class="input date-input" type="date" [ngModel]="from()" (ngModelChange)="onFilterChange('from', $event)" title="T·ª´ ng√†y" />
    <input class="input date-input" type="date" [ngModel]="to()" (ngModelChange)="onFilterChange('to', $event)" title="ƒê·∫øn ng√†y" />
    <div class="filter-actions">
      <button class="btn btn-outline" (click)="resetFilters()">‚Ü∫ ƒê·∫∑t l·∫°i</button>
      <button class="btn btn-search" (click)="refresh()">üîç T√¨m ki·∫øm</button>
    </div>
  </div>

  <!-- Split layout: fixed left (3 cols) + scrollable right -->
  <div class="split-table" *ngIf="!isLoading(); else loadingTpl">
    <div class="fixed-pane" #fixedPane (scroll)="onFixedScroll($event)">
      <table class="fixed-table">
        <thead>
          <tr>
            <th class="col-date">Ng√†y</th>
            <th class="col-customer">KH</th>
            <th class="col-product">SP</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let o of orders(); trackBy: trackById; let i = index" [class.alt]="i % 2 === 1">
            <td class="muted col-date">{{ formatDate(o.createdAt) }}</td>
            <td class="col-customer">
              <input type="text" [ngModel]="o.customerName" (blur)="onInputUpdate(o, 'customerName', $event)" />
            </td>
            <td class="col-product">
              <select [ngModel]="getId(o.productId)" (change)="onSelectUpdate(o, 'productId', $event)"
                      [ngStyle]="productSelectStyle(o.productId)" class="status-dropdown">
                <option *ngFor="let p of products()" [value]="p._id" [ngStyle]="getProductOptionStyle(p._id)">{{ p.name }}</option>
              </select>
            </td>
          </tr>
          <tr *ngIf="orders().length===0">
            <td class="center muted" colspan="3">Ch∆∞a c√≥ ƒë∆°n</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="scroll-pane" #scrollPane (scroll)="onScrollPane($event)">
      <table class="scroll-table">
        <thead>
          <tr>
            <th class="col-qty">SL</th>
            <th class="col-agent">ƒê·∫°i l√Ω</th>
            <th class="col-wide">ID Nh√≥m QC</th>
            <th class="col-active">K√≠ch ho·∫°t</th>
            <th class="col-wide col-service">Chi ti·∫øt DV</th>
            <th class="col-wide col-prod-status">TT S·∫£n xu·∫•t</th>
            <th class="w-order-status col-order-status">TT V·∫≠n ƒë∆°n</th>
            <th class="col-wide col-submit-link">Link n·ªôp</th>
            <th class="col-tracking">M√£ v·∫≠n ƒë∆°n</th>
            <th class="col-wide">ƒê·∫∑t c·ªçc</th>
            <th class="col-wide">COD</th>
            <th class="col-wider">Ng∆∞·ªùi nh·∫≠n</th>
            <th class="col-wide">SƒêT</th>
            <th class="col-wider">ƒê·ªãa ch·ªâ</th>
            <th class="center col-delete">X√≥a</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let o of orders(); trackBy: trackById; let i = index" [class.alt]="i % 2 === 1">
            <td class="col-qty"><input class="input-qty" type="number" min="1" [ngModel]="o.quantity"
                (blur)="onInputUpdate(o, 'quantity', $event)" /></td>
            <td class="col-agent">
              <select [ngModel]="getId(o.agentId)" (change)="onSelectUpdate(o, 'agentId', $event)">
                <option *ngFor="let a of agents()" [value]="a._id">{{ a.name }}</option>
              </select>
            </td>
            <td class="col-wide">
              <select [ngModel]="o.adGroupId" (change)="onSelectUpdate(o, 'adGroupId', $event)">
                <option *ngFor="let g of adGroups()" [value]="g._id">{{ g.name }}</option>
              </select>
            </td>
            <td class="col-active text-center">
              <input type="checkbox" [ngModel]="o.isActive" (change)="onInputUpdate(o, 'isActive', $event)" />
            </td>
            <td class="col-wide col-service"><input type="text" [ngModel]="o.serviceDetails" (blur)="onInputUpdate(o, 'serviceDetails', $event)" /></td>
            <td class="col-wide col-prod-status" [ngStyle]="statusCellStyle('prod', o.productionStatus)">
              <select [ngModel]="o.productionStatus" (change)="onSelectUpdate(o, 'productionStatus', $event)"
                [ngStyle]="statusSelectStyle('prod', o.productionStatus)" class="status-dropdown">
                <option *ngFor="let s of productionStatuses()" [value]="s" [ngStyle]="getStatusOptionStyle('prod', s)">{{ s }}</option>
              </select>
            </td>
            <td class="w-order-status col-order-status" [ngStyle]="statusCellStyle('del', o.orderStatus || 'Ch∆∞a c√≥ m√£ v·∫≠n ƒë∆°n')">
              <select class="w-100 status-dropdown" [ngModel]="o.orderStatus || 'Ch∆∞a c√≥ m√£ v·∫≠n ƒë∆°n'"
                (change)="onSelectUpdate(o, 'orderStatus', $event)"
                [ngStyle]="statusSelectStyle('del', o.orderStatus || 'Ch∆∞a c√≥ m√£ v·∫≠n ƒë∆°n')">
                <option *ngFor="let s of orderStatuses()" [value]="s" [ngStyle]="getStatusOptionStyle('del', s)">{{ s }}</option>
              </select>
            </td>
            <td class="col-wide col-submit-link"><input type="text" [ngModel]="o.submitLink" (blur)="onInputUpdate(o, 'submitLink', $event)" /></td>
            <td class="col-tracking"><input type="text" [ngModel]="o.trackingNumber" (blur)="onInputUpdate(o, 'trackingNumber', $event)" /></td>
            <td class="col-wide"><input type="number" min="0" step="1000" [ngModel]="o.depositAmount"
                (blur)="onInputUpdate(o, 'depositAmount', $event)" /></td>
            <td class="col-wide"><input type="number" min="0" step="1000" [ngModel]="o.codAmount"
                (blur)="onInputUpdate(o, 'codAmount', $event)" /></td>
            <td class="col-wider"><input type="text" [ngModel]="o.receiverName" (blur)="onInputUpdate(o, 'receiverName', $event)" /></td>
            <td class="col-wide"><input type="text" [ngModel]="o.receiverPhone" (blur)="onInputUpdate(o, 'receiverPhone', $event)" /></td>
            <td class="col-wider"><input type="text" [ngModel]="o.receiverAddress" (blur)="onInputUpdate(o, 'receiverAddress', $event)" /></td>
            <td class="center col-delete"><button class="btn btn-sm btn-danger" (click)="delete(o)">X√≥a</button></td>
          </tr>
          <tr *ngIf="orders().length===0">
            <td class="center muted" colspan="15">Ch∆∞a c√≥ ƒë∆°n</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <ng-template #loadingTpl>
    <div class="loading">ƒêang t·∫£i...</div>
  </ng-template>

  <!-- Upload Modal -->
  <div *ngIf="isUploadModalOpen()" class="modal-overlay" (click)="closeUploadModal()">
    <div class="modal upload-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>üì§ T·∫£i l√™n v√† C·∫≠p nh·∫≠t ƒê∆°n h√†ng</h3>
        <button class="modal-close" (click)="closeUploadModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="upload-section">
          <h4>1. T·∫£i Template m·∫´u</h4>
          <button class="btn btn-secondary" (click)="downloadTemplate()">
            üì• T·∫£i template CSV
          </button>
          <p class="help-text">
            T·∫£i file template ƒë·ªÉ c√≥ ƒë·ªãnh d·∫°ng ƒë√∫ng. ƒêi·ªÅn th√¥ng tin c·∫ßn c·∫≠p nh·∫≠t v√† gi·ªØ nguy√™n _id ƒë·ªÉ c·∫≠p nh·∫≠t b·∫£n ghi
            hi·ªán c√≥.
          </p>
        </div>

        <div class="upload-section">
          <h4>2. Ch·ªçn file ƒë·ªÉ t·∫£i l√™n</h4>
          <div class="file-drop-zone" (drop)="onFileDrop($event)" (dragover)="onDragOver($event)"
            [class.has-file]="uploadFile()">
            <div *ngIf="!uploadFile(); else fileSelectedTpl" class="drop-message">
              <div class="drop-icon">üìÅ</div>
              <p>K√©o th·∫£ file v√†o ƒë√¢y ho·∫∑c</p>
              <input type="file" #fileInput (change)="onFileSelected($event)" accept=".csv,.xls,.xlsx"
                style="display: none;">
              <button class="btn btn-outline" (click)="fileInput.click()">>
                Ch·ªçn file
              </button>
              <p class="file-types">H·ªó tr·ª£: CSV, Excel (.xls, .xlsx) - T·ªëi ƒëa 10MB</p>
            </div>

            <ng-template #fileSelectedTpl>
              <div class="file-selected">
                <div class="file-icon">üìÑ</div>
                <div class="file-info">
                  <strong>{{ uploadFile()?.name }}</strong>
                  <p>{{ (uploadFile()?.size || 0) / 1024 / 1024 | number:'1.2-2' }} MB</p>
                </div>
                <button class="btn btn-sm btn-danger" (click)="uploadFile.set(null)">
                  ‚úï X√≥a
                </button>
              </div>
            </ng-template>
          </div>
        </div>

        <div *ngIf="uploadResults()" class="upload-results">
          <h4>üìä K·∫øt qu·∫£ x·ª≠ l√Ω</h4>
          <div class="results-summary">
            <div class="result-item success">
              <strong>‚úÖ Th√†nh c√¥ng: {{ uploadResults()?.success || 0 }}</strong>
            </div>
            @if (uploadResults() && uploadResults()!.errors && uploadResults()!.errors.length > 0) {
            <div class="result-item error">
              <strong>‚ùå L·ªói: {{ uploadResults()!.errors.length }}</strong>
            </div>
            }
          </div>

          @if (uploadResults() && uploadResults()!.errors && uploadResults()!.errors.length > 0) {
          <div class="error-details">
            <h5>Chi ti·∫øt l·ªói:</h5>
            <div class="error-list">
              @for (err of uploadResults()!.errors; track err.row) {
              <div class="error-row">
                <strong>D√≤ng {{ err.row }}:</strong> {{ err.error }}
              </div>
              }
            </div>
          </div>
          }

          <p class="results-message">{{ uploadResults()?.message || '' }}</p>
        </div>

        <div *ngIf="error()" class="error-message">
          ‚ùå {{ error() }}
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeUploadModal()">
          H·ªßy
        </button>
        <button class="btn btn-primary" [disabled]="!uploadFile() || isUploading()" (click)="uploadImportFile()">
          <span *ngIf="isUploading()">üîÑ ƒêang x·ª≠ l√Ω...</span>
          <span *ngIf="!isUploading()">üì§ T·∫£i l√™n v√† C·∫≠p nh·∫≠t</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Delivery Status Update Modal -->
  <div *ngIf="isDeliveryModalOpen()" class="modal-overlay" (click)="closeDeliveryModal()">
    <div class="modal delivery-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>üöö C·∫≠p nh·∫≠t Tr·∫°ng th√°i Giao h√†ng</h3>
        <button class="modal-close" (click)="closeDeliveryModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="upload-section">
          <h4>1. T·∫£i Template ƒë∆°n gi·∫£n (ch·ªâ 3 c·ªôt)</h4>
          <button class="btn btn-secondary" (click)="downloadDeliveryTemplate()">
            üì• T·∫£i template Excel
          </button>
          <p class="help-text">
            File ch·ªâ c√≥ 3 c·ªôt: <strong>ID ƒë∆°n h√†ng, M√£ v·∫≠n ƒë∆°n, Tr·∫°ng th√°i giao h√†ng</strong>. 
            D·ªÖ d√†ng c·∫≠p nh·∫≠t h√†ng lo·∫°t m√† kh√¥ng lo l·ªói do qu√° nhi·ªÅu c·ªôt.
          </p>
        </div>

        <div class="upload-section">
          <h4>2. Ch·ªçn file ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i</h4>
          <div class="file-drop-zone" (drop)="onDeliveryFileDrop($event)" (dragover)="onDragOver($event)"
            [class.has-file]="deliveryUploadFile()">
            <div *ngIf="!deliveryUploadFile(); else deliveryFileSelectedTpl" class="drop-message">
              <div class="drop-icon">üöö</div>
              <p>K√©o th·∫£ file v√†o ƒë√¢y ho·∫∑c</p>
              <input type="file" #deliveryFileInput (change)="onDeliveryFileSelected($event)" accept=".csv,.xls,.xlsx"
                style="display: none;">
              <button class="btn btn-outline" (click)="deliveryFileInput.click()">
                Ch·ªçn file
              </button>
              <p class="file-types">File ƒë∆°n gi·∫£n: CSV, Excel (.xls, .xlsx) - Ch·ªâ 3 c·ªôt</p>
            </div>

            <ng-template #deliveryFileSelectedTpl>
              <div class="file-selected">
                <div class="file-icon">üìÑ</div>
                <div class="file-info">
                  <strong>{{ deliveryUploadFile()?.name }}</strong>
                  <p>{{ (deliveryUploadFile()?.size || 0) / 1024 / 1024 | number:'1.2-2' }} MB</p>
                </div>
                <button class="btn btn-sm btn-danger" (click)="deliveryUploadFile.set(null)">
                  ‚úï X√≥a
                </button>
              </div>
            </ng-template>
          </div>
        </div>

        <div *ngIf="deliveryUploadResults()" class="upload-results">
          <h4>üìä K·∫øt qu·∫£ c·∫≠p nh·∫≠t tr·∫°ng th√°i</h4>
          <div class="results-summary">
            <div class="result-item success">
              <strong>‚úÖ ƒê√£ c·∫≠p nh·∫≠t: {{ deliveryUploadResults()?.success || 0 }} ƒë∆°n h√†ng</strong>
            </div>
            @if (deliveryUploadResults() && deliveryUploadResults()!.errors && deliveryUploadResults()!.errors.length > 0) {
            <div class="result-item error">
              <strong>‚ùå L·ªói: {{ deliveryUploadResults()!.errors.length }}</strong>
            </div>
            }
          </div>

          @if (deliveryUploadResults() && deliveryUploadResults()!.errors && deliveryUploadResults()!.errors.length > 0) {
          <div class="error-details">
            <h5>Chi ti·∫øt l·ªói:</h5>
            <div class="error-list">
              @for (err of deliveryUploadResults()!.errors; track err.row) {
              <div class="error-row">
                <strong>D√≤ng {{ err.row }}:</strong> {{ err.error }}
              </div>
              }
            </div>
          </div>
          }

          <p class="results-message">{{ deliveryUploadResults()?.message || '' }}</p>
        </div>

        <div *ngIf="error()" class="error-message">
          ‚ùå {{ error() }}
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeDeliveryModal()">
          H·ªßy
        </button>
        <button class="btn btn-primary" [disabled]="!deliveryUploadFile() || isDeliveryUploading()" (click)="uploadDeliveryStatusFile()">
          <span *ngIf="isDeliveryUploading()">üîÑ ƒêang c·∫≠p nh·∫≠t...</span>
          <span *ngIf="!isDeliveryUploading()">üöö C·∫≠p nh·∫≠t Tr·∫°ng th√°i</span>
        </button>
      </div>
    </div>
  </div>

<!-- Pagination Controls -->
<div class="pagination-wrapper" *ngIf="!isLoading() && totalItems() > 0">
  <div class="pagination-info">
    Hi·ªÉn th·ªã {{ (currentPage() - 1) * pageSize() + 1 }} - 
    {{ Math.min(currentPage() * pageSize(), totalItems()) }} 
    trong t·ªïng s·ªë {{ totalItems() }} k·∫øt qu·∫£
  </div>
  
  <div class="pagination-controls">
    <select [ngModel]="pageSize()" (ngModelChange)="changePageSize($event)" class="page-size-select">
      <option value="10">10/trang</option>
      <option value="25">25/trang</option>
      <option value="50">50/trang</option>
      <option value="100">100/trang</option>
    </select>

    <button class="btn btn-sm" [disabled]="currentPage() <= 1" (click)="goToPage(1)">
      ‚èÆÔ∏è ƒê·∫ßu
    </button>
    <button class="btn btn-sm" [disabled]="currentPage() <= 1" (click)="goToPage(currentPage() - 1)">
      ‚¨ÖÔ∏è Tr∆∞·ªõc
    </button>
    
    <span class="page-info">
      Trang {{ currentPage() }} / {{ totalPages() }}
    </span>
    
    <button class="btn btn-sm" [disabled]="currentPage() >= totalPages()" (click)="goToPage(currentPage() + 1)">
      Sau ‚û°Ô∏è
    </button>
    <button class="btn btn-sm" [disabled]="currentPage() >= totalPages()" (click)="goToPage(totalPages())">
      Cu·ªëi ‚è≠Ô∏è
    </button>
  </div>
</div>
</div>