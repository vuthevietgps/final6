<!-- Header v√† toolbar -->
<div class="fanpage-container">
  <div class="header">
    <h2>üìò Qu·∫£n l√Ω Fanpage</h2>
    <div class="header-actions">
      <button class="btn-primary" (click)="openAddModal()">
        ‚ûï Th√™m m·ªõi
      </button>
    </div>
  </div>

  <!-- Th√¥ng b√°o l·ªói -->
  <div *ngIf="error()" class="alert alert-error">
    {{ error() }}
    <button (click)="error.set(null)" class="btn-close">√ó</button>
  </div>

  <!-- Loading -->
  <div *ngIf="loading()" class="loading">
    ƒêang t·∫£i d·ªØ li·ªáu...
  </div>

  <!-- B·∫£ng danh s√°ch fanpage -->
  <div *ngIf="!loading()" class="table-container">
    <table class="fanpage-table">
      <thead>
        <tr>
          <th>Avatar</th>
          <th>T√™n</th>
          <th>ID</th>
          <th>Tr·∫°ng th√°i</th>
          <th>K·∫øt n·ªëi</th>
          <th>OpenAI Config</th>
          <th>Token</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let fanpage of fanpages(); trackBy: trackById" class="fanpage-row">
          <td class="avatar-col">
            <div class="avatar" [style.background-image]="fanpage.avatarUrl ? 'url(' + fanpage.avatarUrl + ')' : ''">
                          <span class="avatar-text" *ngIf="!fanpage.avatarUrl">{{ fanpage.name.charAt(0).toUpperCase() }}</span>
            </div>
          </td>
          <td>
            <div class="fanpage-name">{{ fanpage.name }}</div>
            <div class="fanpage-desc" *ngIf="fanpage.description">{{ fanpage.description }}</div>
          </td>
          <td>{{ fanpage.pageId }}</td>
          <td>
            <span class="status-badge" [class]="fanpage.status">
              {{ fanpage.status === 'active' ? 'Ho·∫°t ƒë·ªông' : 'T·∫°m d·ª´ng' }}
            </span>
          </td>
          <td>
            <div class="connection-info">
              <div>{{ fanpage.connectedAt | date:'dd/MM/yyyy' }}</div>
              <div class="ai-status">
                <span [class]="fanpage.aiEnabled ? 'ai-enabled' : 'ai-disabled'">
                  {{ fanpage.aiEnabled ? 'ü§ñ AI B·∫≠t' : '‚≠ï AI T·∫Øt' }}
                </span>
                <small *ngIf="fanpage.openAIConfigId" style="display:block;opacity:.6;font-size:10px;">Cfg: {{ fanpage.openAIConfigId.slice(-6) }}</small>
              </div>
            </div>
          </td>
          <td>
            <div class="ai-config-col">
              <ng-container *ngIf="fanpage.openAIConfigId; else noConfig">
                <span>{{ getOpenAIConfigName(fanpage) }}</span>
              </ng-container>
              <ng-template #noConfig><span class="muted">Ch∆∞a ch·ªçn</span></ng-template>
            </div>
          </td>
          <td>
            <div class="token-col">
              <ng-container *ngIf="hasApiTokens(fanpage._id); else noApiTokens">
                <span class="token-status" [class]="getTokenStatus(fanpage._id).css">
                  <ng-container [ngSwitch]="getTokenStatus(fanpage._id).css">
                    <span *ngSwitchCase="'status-valid'">‚úÖ H·ª£p l·ªá</span>
                    <span *ngSwitchCase="'status-expired'">‚ö†Ô∏è H·∫øt h·∫°n</span>
                    <span *ngSwitchCase="'status-invalid'">‚ùå Kh√¥ng h·ª£p l·ªá</span>
                    <span *ngSwitchDefault>‚è∫ Ch∆∞a ki·ªÉm tra</span>
                  </ng-container>
                </span>
                <small *ngIf="getTokenStatus(fanpage._id).detail" class="muted" style="display:block">{{ getTokenStatus(fanpage._id).detail }}</small>
                <div class="token-actions">
                  <button class="btn-xs" (click)="checkToken(fanpage)" [disabled]="validatingTokenFor()===fanpage._id">
                    {{ validatingTokenFor()===fanpage._id ? 'ƒêang ki·ªÉm tra...' : 'Ki·ªÉm tra' }}
                  </button>
                  <button 
                    class="btn-xs btn-refresh" 
                    (click)="openTokenRecovery(fanpage)" 
                    title="Kh√¥i ph·ª•c token"
                    *ngIf="getTokenStatus(fanpage._id).css === 'status-expired' || getTokenStatus(fanpage._id).css === 'status-invalid'">
                    üîß Kh√¥i ph·ª•c
                  </button>
                </div>
              </ng-container>
              <ng-template #noApiTokens>
                <div class="muted">
                  <span *ngIf="hasFanpageAccessToken(fanpage); else noAccess">Ch∆∞a c√≥ tr·∫°ng th√°i</span>
                  <ng-template #noAccess>Ch∆∞a c√≥</ng-template>
                </div>
              </ng-template>
            </div>
          </td>
          <td class="actions">
            <button class="btn-icon" (click)="openEditModal(fanpage)" title="Ch·ªânh s·ª≠a">
              ‚úèÔ∏è
            </button>
            <button class="btn-icon" (click)="toggleAI(fanpage)" [title]="fanpage.aiEnabled ? 'T·∫Øt AI' : 'B·∫≠t AI'">
              {{ fanpage.aiEnabled ? 'üî¥' : 'üü¢' }}
            </button>
            <button class="btn-icon" *ngIf="!fanpage.openAIConfigId" (click)="createAIConfig(fanpage)" title="T·∫°o config AI">
              ü§ñ
            </button>
            <button class="btn-icon btn-danger" (click)="deleteFanpage(fanpage)" title="X√≥a">
              üóëÔ∏è
            </button>
          </td>
        </tr>
        <tr *ngIf="fanpages().length === 0" class="empty-row">
          <td colspan="8" class="text-center">Ch∆∞a c√≥ fanpage n√†o</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal th√™m/s·ª≠a fanpage -->
<div *ngIf="showAddModal()" class="modal-overlay" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ editingFanpage() ? 'Ch·ªânh s·ª≠a' : 'Th√™m m·ªõi' }} Fanpage</h3>
      <button class="btn-close" (click)="closeModal()">√ó</button>
    </div>
    
    <div class="modal-body">
      <!-- Page ID -->
      <div class="form-group">
        <label for="pageId">Page ID **</label>
        <input 
          id="pageId"
          type="text" 
          [value]="formData().pageId || ''"
          (input)="onInputChange($event, 'pageId')"
          placeholder="Nh·∫≠p Page ID"
          required>
      </div>

      <!-- T√™n fanpage -->
      <div class="form-group">
        <label for="name">T√™n Fanpage **</label>
        <input 
          id="name"
          type="text" 
          [value]="formData().name || ''"
          (input)="onInputChange($event, 'name')"
          placeholder="Nh·∫≠p t√™n fanpage"
          required>
      </div>

      <!-- Access Token -->
      <div class="form-group">
        <label for="accessToken">Access Token **</label>
        <textarea 
          id="accessToken"
          [value]="formData().accessToken || ''"
          (input)="onInputChange($event, 'accessToken')"
          placeholder="Nh·∫≠p access token"
          rows="3"
          required></textarea>
      </div>

      <!-- Tr·∫°ng th√°i v√† ng√†y -->
      <div class="form-row">
        <div class="form-group">
          <label for="status">Tr·∫°ng th√°i **</label>
          <select 
            id="status"
            [value]="formData().status || 'active'"
            (change)="onInputChange($event, 'status')">
            <option value="active">active</option>
            <option value="inactive">inactive</option>
          </select>
        </div>
        <div class="form-group">
          <label>K·∫øt n·ªëi **</label>
          <input type="text" value="09/29/2025 05" readonly>
        </div>
        <div class="form-group">
          <label>Refresh g·∫ßn nh·∫•t</label>
          <input type="text" placeholder="mm/dd/yyyy --:-">
        </div>
      </div>

      <!-- Avatar URL -->
      <div class="form-group">
        <label for="avatarUrl">Avatar URL</label>
        <input 
          id="avatarUrl"
          type="text" 
          [value]="formData().avatarUrl || ''"
          (input)="onInputChange($event, 'avatarUrl')"
          placeholder="https://...">
      </div>

      <!-- OpenAI Config: lu√¥n hi·ªÉn th·ªã ƒë·ªÉ d·ªÖ t√¨m th·∫•y -->
      <div class="form-group">
        <label for="openAIConfig">C·∫•u h√¨nh OpenAI</label>
        <select id="openAIConfig" [value]="formData().openAIConfigId || ''" (change)="onInputChange($event, 'openAIConfigId')">
          <option value="">(T·ª± t·∫°o config AI m·∫∑c ƒë·ªãnh theo m√¥ t·∫£ fanpage)</option>
          <option *ngFor="let c of aiConfigs()" [value]="c._id">{{ c.name }} ‚Ä¢ {{ c.model }}</option>
        </select>
        <div class="hint" *ngIf="aiConfigLoading()">ƒêang t·∫£i danh s√°ch c·∫•u h√¨nh...</div>
        <div class="hint">ƒê·ªÉ tr·ªëng: h·ªá th·ªëng t·ª± t·∫°o config AI sau khi l∆∞u fanpage.</div>
      </div>

      <!-- ConnectedBy v√† Default Product Group -->
      <div class="form-row">
        <div class="form-group">
          <label>ConnectedBy (UserId)</label>
          <input type="text" [value]="formData().connectedBy || ''" readonly>
        </div>
        <div class="form-group">
          <label>Default Product Group **</label>
          <select [value]="formData().defaultProductGroup || ''">
            <option value="">Ch·ªçn nh√≥m s·∫£n ph·∫©m...</option>
          </select>
        </div>
      </div>

      <!-- M√¥ t·∫£ -->
      <div class="form-group">
        <label for="description">M√¥ t·∫£ fanpage / lƒ©nh v·ª±c kinh doanh</label>
        <textarea 
          id="description"
          [value]="formData().description || ''"
          (input)="onInputChange($event, 'description')"
          rows="3"
          placeholder="M√¥ t·∫£ ng·∫Øn g·ªçn v·ªÅ fanpage..."></textarea>
      </div>

      <!-- Scripts -->
      <div class="scripts-section">
        <h4>K·ªãch b·∫£n Chat Fallback (Generic Script)</h4>
        <p class="help-text">S·ª≠ d·ª•ng khi kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c nh√≥m qu·∫£ng c√°o t·ª´ tin nh·∫Øn</p>
        
        <div class="script-grid">
          <div class="form-group">
            <label>L·ªùi ch√†o (Greeting)</label>
            <textarea 
              [value]="formData().greetingScript || ''"
              (input)="onInputChange($event, 'greetingScript')"
              placeholder="Tin nh·∫Øn ƒë·∫ßu ti√™n"></textarea>
          </div>
          
          <div class="form-group">
            <label>Y√™u c·∫ßu l√†m r√µ (Clarify)</label>
            <textarea 
              [value]="formData().clarifyScript || ''"
              (input)="onInputChange($event, 'clarifyScript')"
              placeholder="Khi tin nh·∫≠n ch∆∞a r√µ r√†ng, c·∫ßn clarify t√¥i ƒë·ªÉ bi·∫øt s·∫µn s√†ng, h·ªó tr·ª£ th√¥ng tin..."></textarea>
          </div>

          <div class="form-group">
            <label>ƒê·ªÅ xu·∫•t s·∫£n ph·∫©m</label>
            <textarea 
              [value]="formData().productSuggestScript || ''"
              (input)="onInputChange($event, 'productSuggestScript')"
              placeholder="Tr∆∞·ªõc khi AI ƒë·ªÅ xu·∫•t, h·ªèi th√™m c√°c th√¥ng tin kh√°ch h√†ng ƒë·ªÉ l√†m r√µ th√™m v√† nghi√™m t·ª± kh√°ch..."></textarea>
          </div>

          <div class="form-group">
            <label>Tin nh·∫Øn chuy·ªÉn nh√¢n vi√™n</label>
            <textarea 
              [value]="formData().fallbackScript || ''"
              (input)="onInputChange($event, 'fallbackScript')"
              placeholder="Khi kh√¥ng th·ªÉ x·ª≠ l√Ω"></textarea>
          </div>

          <div class="form-group">
            <label>L·ªùi k·∫øt th√∫c (Closing)</label>
            <textarea 
              [value]="formData().closingScript || ''"
              (input)="onInputChange($event, 'closingScript')"
              placeholder="Tin nh·∫Øn k·∫øt th√∫c cu·ªôc h·ªôi tho·∫°i. ƒê·ªãnh h∆∞·ªõng c√°c th·ªß t·ª•c tinh AI c·∫ßn. L·∫ßn clarify li√™n h·ªá cho h·ªèi th√¥ng tin AI (size, m√†u s·∫Øc, v.v.)"></textarea>
          </div>
        </div>
      </div>

      <!-- Qu·∫£n l√Ω s·∫£n ph·∫©m cho fanpage -->
      <details class="products-section" [open]="true">
        <summary>üì¶ Qu·∫£n l√Ω s·∫£n ph·∫©m cho fanpage n√†y</summary>
        
        <div class="products-manager">
          <!-- Search v√† add s·∫£n ph·∫©m -->
          <div class="product-search-section">
            <div class="search-row">
              <input 
                type="text" 
                placeholder="T√¨m s·∫£n ph·∫©m ƒë·ªÉ th√™m v√†o fanpage..."
                [(ngModel)]="productSearchQuery"
                (input)="searchProducts()"
                class="product-search-input">
              <button class="btn-primary btn-sm" (click)="loadAllProducts()">
                üîç T√¨m ki·∫øm
              </button>
            </div>
            
            <!-- Danh s√°ch s·∫£n ph·∫©m c√≥ th·ªÉ th√™m -->
            <div *ngIf="availableProducts().length > 0" class="available-products">
              <h5>S·∫£n ph·∫©m c√≥ th·ªÉ th√™m:</h5>
              <div class="product-list">
                <div *ngFor="let product of availableProducts()" class="product-item">
                  <div class="product-info">
                    <div class="product-name">{{ product.name }}</div>
                    <div class="product-price">{{ product.importPrice | number }}ƒë</div>
                  </div>
                  <button class="btn-primary btn-xs" (click)="addProductToFanpage(product)">
                    ‚ûï Th√™m
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- S·∫£n ph·∫©m ƒë√£ th√™m v√†o fanpage -->
          <div class="fanpage-products-section">
            <h5>S·∫£n ph·∫©m c·ªßa fanpage n√†y:</h5>
            <div *ngIf="fanpageProducts().length === 0" class="empty-products">
              <p>{{ editingFanpage() ? 'Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c th√™m v√†o fanpage n√†y.' : 'Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c ch·ªçn cho fanpage m·ªõi.' }}</p>
              <p class="hint">S·ª≠ d·ª•ng t√¨m ki·∫øm ·ªü tr√™n ƒë·ªÉ th√™m s·∫£n ph·∫©m{{ editingFanpage() ? '.' : ' (s·∫Ω ƒë∆∞·ª£c l∆∞u khi t·∫°o fanpage).' }}</p>
            </div>
            
            <div *ngIf="fanpageProducts().length > 0" class="fanpage-product-list">
              <div *ngFor="let productVariation of fanpageProducts()" class="fanpage-product-item">
                <div class="product-details">
                  <div class="product-name">{{ productVariation.productName }}</div>
                  <div class="product-custom-info">
                    <div class="custom-name" *ngIf="productVariation.customName">
                      <strong>T√™n t√πy ch·ªânh:</strong> {{ productVariation.customName }}
                    </div>
                    <div class="custom-price" *ngIf="productVariation.price">
                      <strong>Gi√° b√°n:</strong> {{ productVariation.price | number }}ƒë
                    </div>
                    <div class="priority">
                      <strong>∆Øu ti√™n:</strong> {{ productVariation.priority || 0 }}
                    </div>
                    <div class="status">
                      <span [class]="productVariation.isActive ? 'status-active' : 'status-inactive'">
                        {{ productVariation.isActive ? 'ƒêang b√°n' : 'T·∫°m d·ª´ng' }}
                      </span>
                    </div>
                  </div>
                </div>
                <div class="product-actions">
                  <button class="btn-secondary btn-xs" (click)="editProductVariation(productVariation)">
                    ‚úèÔ∏è S·ª≠a
                  </button>
                  <button class="btn-danger btn-xs" (click)="removeProductFromFanpage(productVariation)">
                    üóëÔ∏è X√≥a
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </details>

      <!-- Th·ªëng k√™ -->
      <details class="stats-section">
        <summary>üìä Th·ªëng k√™ v√† c√†i ƒë·∫∑t n√¢ng cao</summary>
        <div class="stats-grid">
          <div class="form-group">
            <label>Subscriber</label>
            <input 
              type="number" 
              [value]="formData().subscriberCount || 0"
              (input)="onNumberChange($event, 'subscriberCount')"
              min="0">
          </div>
          <div class="form-group">
            <label>Message quota</label>
            <input 
              type="number" 
              [value]="formData().messageQuota || 10000"
              (input)="onNumberChange($event, 'messageQuota')"
              min="0">
          </div>
          <div class="form-group">
            <label>Sent this month</label>
            <input 
              type="number" 
              [value]="formData().sentThisMonth || 0"
              (input)="onNumberChange($event, 'sentThisMonth')"
              min="0"
              readonly>
          </div>
        </div>

        <!-- Timezone v√† flags -->
        <div class="form-row">
          <div class="form-group">
            <label>M√∫i gi·ªù</label>
            <input 
              type="text" 
              [value]="formData().timezone || 'Asia/Ho_Chi_Minh'"
              (input)="onInputChange($event, 'timezone')">
          </div>
          <div class="form-group checkbox-group">
            <label>
              <input 
                type="checkbox" 
                [checked]="formData().subscribedWebhook || false"
                (change)="onCheckboxChange($event, 'subscribedWebhook')">
              ƒê√£ subscribe webhook
            </label>
          </div>
          <div class="form-group checkbox-group">
            <label>
              <input 
                type="checkbox" 
                [checked]="formData().aiEnabled || false"
                (change)="onCheckboxChange($event, 'aiEnabled')">
              B·∫≠t AI Chatbot
            </label>
          </div>
        </div>
      </details>
    </div>

    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeModal()">H·ªßy</button>
      <button class="btn-primary" (click)="saveFanpage()">L∆∞u</button>
    </div>
  </div>
</div>

<!-- Modal s·ª≠a product variation -->
<div *ngIf="showProductModal()" class="modal-overlay" (click)="closeProductModal()">
  <div class="modal-content modal-sm" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>T√πy ch·ªânh s·∫£n ph·∫©m cho fanpage</h3>
      <button class="btn-close" (click)="closeProductModal()">√ó</button>
    </div>
    
    <div class="modal-body">
      <div class="form-group">
        <label>S·∫£n ph·∫©m g·ªëc:</label>
        <div class="product-original">{{ editingProductVariation()?.productName }}</div>
      </div>

      <div class="form-group">
        <label for="customName">T√™n t√πy ch·ªânh cho fanpage:</label>
        <input 
          id="customName"
          type="text" 
          [value]="productFormData().customName || ''"
          (input)="onProductInputChange($event, 'customName')"
          placeholder="ƒê·ªÉ tr·ªëng s·∫Ω d√πng t√™n g·ªëc">
      </div>

      <div class="form-group">
        <label for="customDescription">M√¥ t·∫£ t√πy ch·ªânh:</label>
        <textarea 
          id="customDescription"
          [value]="productFormData().customDescription || ''"
          (input)="onProductInputChange($event, 'customDescription')"
          rows="3"
          placeholder="M√¥ t·∫£ ƒë·∫∑c bi·ªát cho fanpage n√†y..."></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="customPrice">Gi√° b√°n (ƒë):</label>
          <input 
            id="customPrice"
            type="number" 
            [value]="productFormData().price || ''"
            (input)="onProductNumberChange($event, 'price')"
            placeholder="Gi√° b√°n cho fanpage n√†y"
            min="0">
        </div>
        <div class="form-group">
          <label for="priority">∆Øu ti√™n:</label>
          <input 
            id="priority"
            type="number" 
            [value]="productFormData().priority || 0"
            (input)="onProductNumberChange($event, 'priority')"
            min="0"
            max="10">
        </div>
      </div>

      <div class="form-group checkbox-group">
        <label>
          <input 
            type="checkbox" 
            [checked]="productFormData().isActive !== false"
            (change)="onProductCheckboxChange($event, 'isActive')">
          ƒêang b√°n tr√™n fanpage n√†y
        </label>
      </div>

      <div class="form-group">
        <label>·∫¢nh t√πy ch·ªânh (URLs, m·ªói URL m·ªôt d√≤ng):</label>
        <textarea 
          [value]="(productFormData().customImages || []).join('\n')"
          (input)="onCustomImagesChange($event)"
          rows="3"
          placeholder="https://example.com/image1.jpg&#10;https://example.com/image2.jpg"></textarea>
        <div class="hint">ƒê·ªÉ tr·ªëng s·∫Ω d√πng ·∫£nh g·ªëc c·ªßa s·∫£n ph·∫©m</div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeProductModal()">H·ªßy</button>
      <button class="btn-primary" (click)="saveProductVariation()">L∆∞u</button>
    </div>
  </div>
</div>

<!-- Token Recovery Modal -->
<app-token-recovery
  [showModal]="showTokenRecovery()"
  [tokenStatus]="tokenRecoveryData()"
  [hasBackupTokens]="hasBackupTokens()"
  [backupTokenCount]="backupTokenCount()"
  (onClose)="closeTokenRecovery()"
  (onRecovery)="handleTokenRecovery($event)">
</app-token-recovery>
