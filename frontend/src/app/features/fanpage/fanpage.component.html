<!-- Header v√† toolbar -->
<div class="fanpage-container">
  <div class="header">
    <h2>üìò Qu·∫£n l√Ω Fanpage</h2>
    <button class="btn-primary" (click)="openAddModal()">
      ‚ûï Th√™m m·ªõi
    </button>
  </div>

  <!-- Th√¥ng b√°o l·ªói -->
  <div *ngIf="error()" class="alert alert-error">
    {{ error() }}
    <button (click)="error.set(null)" class="btn-close">√ó</button>
  </div>

  <!-- Loading -->
  <div *ngIf="loading()" class="loading">
    ƒêang t·∫£i d·ªØ li·ªáu...
  </div>

  <!-- B·∫£ng danh s√°ch fanpage -->
  <div *ngIf="!loading()" class="table-container">
    <table class="fanpage-table">
      <thead>
        <tr>
          <th>Avatar</th>
          <th>T√™n</th>
          <th>ID</th>
          <th>Tr·∫°ng th√°i</th>
          <th>K·∫øt n·ªëi</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let fanpage of fanpages(); trackBy: trackById" class="fanpage-row">
          <td class="avatar-col">
            <div class="avatar" [style.background-image]="fanpage.avatarUrl ? 'url(' + fanpage.avatarUrl + ')' : ''">
                          <span class="avatar-text" *ngIf="!fanpage.avatarUrl">{{ fanpage.name.charAt(0).toUpperCase() }}</span>
            </div>
          </td>
          <td>
            <div class="fanpage-name">{{ fanpage.name }}</div>
            <div class="fanpage-desc" *ngIf="fanpage.description">{{ fanpage.description }}</div>
          </td>
          <td>{{ fanpage.pageId }}</td>
          <td>
            <span class="status-badge" [class]="fanpage.status">
              {{ fanpage.status === 'active' ? 'Ho·∫°t ƒë·ªông' : 'T·∫°m d·ª´ng' }}
            </span>
          </td>
          <td>
            <div class="connection-info">
              <div>{{ fanpage.connectedAt | date:'dd/MM/yyyy' }}</div>
              <div class="ai-status">
                <span [class]="fanpage.aiEnabled ? 'ai-enabled' : 'ai-disabled'">
                  {{ fanpage.aiEnabled ? 'ü§ñ AI B·∫≠t' : '‚≠ï AI T·∫Øt' }}
                </span>
                <small *ngIf="fanpage.openAIConfigId" style="display:block;opacity:.6;font-size:10px;">Cfg: {{ fanpage.openAIConfigId.slice(-6) }}</small>
              </div>
            </div>
          </td>
          <td class="actions">
            <button class="btn-icon" (click)="openEditModal(fanpage)" title="Ch·ªânh s·ª≠a">
              ‚úèÔ∏è
            </button>
            <button class="btn-icon" (click)="toggleAI(fanpage)" [title]="fanpage.aiEnabled ? 'T·∫Øt AI' : 'B·∫≠t AI'">
              {{ fanpage.aiEnabled ? 'üî¥' : 'üü¢' }}
            </button>
            <button class="btn-icon" *ngIf="!fanpage.openAIConfigId" (click)="createAIConfig(fanpage)" title="T·∫°o config AI">
              ü§ñ
            </button>
            <button class="btn-icon btn-danger" (click)="deleteFanpage(fanpage)" title="X√≥a">
              üóëÔ∏è
            </button>
          </td>
        </tr>
        <tr *ngIf="fanpages().length === 0" class="empty-row">
          <td colspan="6" class="text-center">Ch∆∞a c√≥ fanpage n√†o</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal th√™m/s·ª≠a fanpage -->
<div *ngIf="showAddModal()" class="modal-overlay" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ editingFanpage() ? 'Ch·ªânh s·ª≠a' : 'Th√™m m·ªõi' }} Fanpage</h3>
      <button class="btn-close" (click)="closeModal()">√ó</button>
    </div>
    
    <div class="modal-body">
      <!-- Page ID -->
      <div class="form-group">
        <label for="pageId">Page ID **</label>
        <input 
          id="pageId"
          type="text" 
          [value]="formData().pageId || ''"
          (input)="onInputChange($event, 'pageId')"
          placeholder="Nh·∫≠p Page ID"
          required>
      </div>

      <!-- T√™n fanpage -->
      <div class="form-group">
        <label for="name">T√™n Fanpage **</label>
        <input 
          id="name"
          type="text" 
          [value]="formData().name || ''"
          (input)="onInputChange($event, 'name')"
          placeholder="Nh·∫≠p t√™n fanpage"
          required>
      </div>

      <!-- Access Token -->
      <div class="form-group">
        <label for="accessToken">Access Token **</label>
        <textarea 
          id="accessToken"
          [value]="formData().accessToken || ''"
          (input)="onInputChange($event, 'accessToken')"
          placeholder="Nh·∫≠p access token"
          rows="3"
          required></textarea>
      </div>

      <!-- Tr·∫°ng th√°i v√† ng√†y -->
      <div class="form-row">
        <div class="form-group">
          <label for="status">Tr·∫°ng th√°i **</label>
          <select 
            id="status"
            [value]="formData().status || 'active'"
            (change)="onInputChange($event, 'status')">
            <option value="active">active</option>
            <option value="inactive">inactive</option>
          </select>
        </div>
        <div class="form-group">
          <label>K·∫øt n·ªëi **</label>
          <input type="text" value="09/29/2025 05" readonly>
        </div>
        <div class="form-group">
          <label>Refresh g·∫ßn nh·∫•t</label>
          <input type="text" placeholder="mm/dd/yyyy --:-">
        </div>
      </div>

      <!-- Avatar URL -->
      <div class="form-group">
        <label for="avatarUrl">Avatar URL</label>
        <input 
          id="avatarUrl"
          type="text" 
          [value]="formData().avatarUrl || ''"
          (input)="onInputChange($event, 'avatarUrl')"
          placeholder="https://...">
      </div>

      <!-- OpenAI Config ch·ªçn s·∫µn (ch·ªâ hi·ªán khi ch·ªânh s·ª≠a) -->
      <div class="form-group" *ngIf="editingFanpage()">
        <label for="openAIConfig">C·∫•u h√¨nh OpenAI</label>
        <select id="openAIConfig" [value]="formData().openAIConfigId || ''" (change)="onInputChange($event, 'openAIConfigId')">
          <option value="">(S·ª≠ d·ª•ng config m·∫∑c ƒë·ªãnh c·ªßa fanpage)</option>
          <option *ngFor="let c of aiConfigs()" [value]="c._id">{{ c.name }} ‚Ä¢ {{ c.model }}</option>
        </select>
        <div class="hint" *ngIf="aiConfigLoading()">ƒêang t·∫£i danh s√°ch c·∫•u h√¨nh...</div>
        <div class="hint">Khi t·∫°o m·ªõi fanpage s·∫Ω t·ª± t·∫°o config AI d·ª±a tr√™n m√¥ t·∫£ kinh doanh</div>
      </div>

      <!-- ConnectedBy v√† Default Product Group -->
      <div class="form-row">
        <div class="form-group">
          <label>ConnectedBy (UserId)</label>
          <input type="text" [value]="formData().connectedBy || ''" readonly>
        </div>
        <div class="form-group">
          <label>Default Product Group **</label>
          <select [value]="formData().defaultProductGroup || ''">
            <option value="">Ch·ªçn nh√≥m s·∫£n ph·∫©m...</option>
          </select>
        </div>
      </div>

      <!-- M√¥ t·∫£ -->
      <div class="form-group">
        <label for="description">M√¥ t·∫£ fanpage / lƒ©nh v·ª±c kinh doanh</label>
        <textarea 
          id="description"
          [value]="formData().description || ''"
          (input)="onInputChange($event, 'description')"
          rows="3"
          placeholder="M√¥ t·∫£ ng·∫Øn g·ªçn v·ªÅ fanpage..."></textarea>
      </div>

      <!-- Scripts -->
      <div class="scripts-section">
        <h4>K·ªãch b·∫£n Chat Fallback (Generic Script)</h4>
        <p class="help-text">S·ª≠ d·ª•ng khi kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c nh√≥m qu·∫£ng c√°o t·ª´ tin nh·∫Øn</p>
        
        <div class="script-grid">
          <div class="form-group">
            <label>L·ªùi ch√†o (Greeting)</label>
            <textarea 
              [value]="formData().greetingScript || ''"
              (input)="onInputChange($event, 'greetingScript')"
              placeholder="Tin nh·∫Øn ƒë·∫ßu ti√™n"></textarea>
          </div>
          
          <div class="form-group">
            <label>Y√™u c·∫ßu l√†m r√µ (Clarify)</label>
            <textarea 
              [value]="formData().clarifyScript || ''"
              (input)="onInputChange($event, 'clarifyScript')"
              placeholder="Khi tin nh·∫≠n ch∆∞a r√µ r√†ng, c·∫ßn clarify t√¥i ƒë·ªÉ bi·∫øt s·∫µn s√†ng, h·ªó tr·ª£ th√¥ng tin..."></textarea>
          </div>

          <div class="form-group">
            <label>ƒê·ªÅ xu·∫•t s·∫£n ph·∫©m</label>
            <textarea 
              [value]="formData().productSuggestScript || ''"
              (input)="onInputChange($event, 'productSuggestScript')"
              placeholder="Tr∆∞·ªõc khi AI ƒë·ªÅ xu·∫•t, h·ªèi th√™m c√°c th√¥ng tin kh√°ch h√†ng ƒë·ªÉ l√†m r√µ th√™m v√† nghi√™m t·ª± kh√°ch..."></textarea>
          </div>

          <div class="form-group">
            <label>Tin nh·∫Øn chuy·ªÉn nh√¢n vi√™n</label>
            <textarea 
              [value]="formData().fallbackScript || ''"
              (input)="onInputChange($event, 'fallbackScript')"
              placeholder="Khi kh√¥ng th·ªÉ x·ª≠ l√Ω"></textarea>
          </div>

          <div class="form-group">
            <label>L·ªùi k·∫øt th√∫c (Closing)</label>
            <textarea 
              [value]="formData().closingScript || ''"
              (input)="onInputChange($event, 'closingScript')"
              placeholder="Tin nh·∫Øn k·∫øt th√∫c cu·ªôc h·ªôi tho·∫°i. ƒê·ªãnh h∆∞·ªõng c√°c th·ªß t·ª•c tinh AI c·∫ßn. L·∫ßn clarify li√™n h·ªá cho h·ªèi th√¥ng tin AI (size, m√†u s·∫Øc, v.v.)"></textarea>
          </div>
        </div>
      </div>

      <!-- Th·ªëng k√™ -->
      <details class="stats-section">
        <summary>‚ûï Th√™m thu·ªôc t√≠nh s·∫£n ph·∫©m</summary>
        <div class="stats-grid">
          <div class="form-group">
            <label>Subscriber</label>
            <input 
              type="number" 
              [value]="formData().subscriberCount || 0"
              (input)="onNumberChange($event, 'subscriberCount')"
              min="0">
          </div>
          <div class="form-group">
            <label>Message quota</label>
            <input 
              type="number" 
              [value]="formData().messageQuota || 10000"
              (input)="onNumberChange($event, 'messageQuota')"
              min="0">
          </div>
          <div class="form-group">
            <label>Sent this month</label>
            <input 
              type="number" 
              [value]="formData().sentThisMonth || 0"
              (input)="onNumberChange($event, 'sentThisMonth')"
              min="0"
              readonly>
          </div>
        </div>

        <!-- Timezone v√† flags -->
        <div class="form-row">
          <div class="form-group">
            <label>M√∫i gi·ªù</label>
            <input 
              type="text" 
              [value]="formData().timezone || 'Asia/Ho_Chi_Minh'"
              (input)="onInputChange($event, 'timezone')">
          </div>
          <div class="form-group checkbox-group">
            <label>
              <input 
                type="checkbox" 
                [checked]="formData().subscribedWebhook || false"
                (change)="onCheckboxChange($event, 'subscribedWebhook')">
              ƒê√£ subscribe webhook
            </label>
          </div>
          <div class="form-group checkbox-group">
            <label>
              <input 
                type="checkbox" 
                [checked]="formData().aiEnabled || false"
                (change)="onCheckboxChange($event, 'aiEnabled')">
              B·∫≠t AI Chatbot
            </label>
          </div>
        </div>
      </details>
    </div>

    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeModal()">H·ªßy</button>
      <button class="btn-primary" (click)="saveFanpage()">L∆∞u</button>
    </div>
  </div>
</div>
