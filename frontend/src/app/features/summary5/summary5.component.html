<div class="toolbar">
  <div class="left">
    <h2>Báo cáo 5</h2>
    <button (click)="refresh()">Làm mới</button>
    <button (click)="sync()">Đồng bộ</button>
    <button (click)="syncLast7Days()">Đồng bộ 7 ngày qua</button>
    <button (click)="showFilters.set(!showFilters())">Bộ lọc</button>
  </div>
  <div class="right">
    <input type="text" placeholder="Tìm kiếm..." [ngModel]="searchTerm()" (ngModelChange)="searchTerm.set($event)" />
  </div>
</div>

<div class="alert error" *ngIf="error()">
  {{ error() }}
  <button (click)="error.set(null)">Đóng</button>
  <button (click)="refresh()">Thử lại</button>
  <small class="hint">Kiểm tra token đăng nhập/CORS và API http://localhost:3000/summary5</small>
  <hr />
</div>

<div class="filters" *ngIf="showFilters()">
  <div class="row">
    <label>Từ ngày</label>
    <input type="date" [ngModel]="filter().startDate" (ngModelChange)="updateFilter('startDate', $event)" />
    <label>Đến ngày</label>
    <input type="date" [ngModel]="filter().endDate" (ngModelChange)="updateFilter('endDate', $event)" />
    <label>Trạng thái SX</label>
    <input type="text" [ngModel]="filter().productionStatus" (ngModelChange)="updateFilter('productionStatus', $event)" placeholder="VD: Đã trả kết quả" />
    <label>Trạng thái ĐH</label>
    <input type="text" [ngModel]="filter().orderStatus" (ngModelChange)="updateFilter('orderStatus', $event)" placeholder="VD: Giao thành công" />
  </div>
  <div class="row">
    <!-- Reserved for future: agentId/productId dropdowns like Summary4 -->
  </div>
</div>

<div class="stats" *ngIf="stats() as s">
  <div class="card">
    <div class="label">Doanh thu</div>
    <div class="value">{{ formatCurrency(s.totalRevenue) }}</div>
  </div>
  <div class="card">
    <div class="label">Giá vốn</div>
    <div class="value">{{ formatCurrency(s.totalCostOfGoods) }}</div>
  </div>
  <div class="card">
    <div class="label">Chi phí Ads</div>
    <div class="value">{{ formatCurrency(s.totalAdCost) }}</div>
  </div>
  <div class="card">
    <div class="label">Chi phí Nhân công</div>
    <div class="value">{{ formatCurrency(s.totalLaborCost) }}</div>
  </div>
  <div class="card">
    <div class="label">Chi phí khác</div>
    <div class="value">{{ formatCurrency(s.totalOtherCost) }}</div>
  </div>
  <div class="card">
    <div class="label">Lợi nhuận</div>
    <div class="value">{{ formatCurrency(s.totalProfit) }}</div>
  </div>
</div>

<div class="empty-state" *ngIf="!loading() && filteredData().length === 0">
  <p>Chưa có dữ liệu để hiển thị. Hãy chọn khoảng ngày và bấm "Đồng bộ" để tạo dữ liệu Báo cáo 5 từ Tổng Hợp 4.</p>
  <p *ngIf="lastSynced() !== null">Lần đồng bộ gần nhất: {{ lastSynced() }} dòng.</p>
  <button (click)="sync()">Đồng bộ ngay</button>
  <button (click)="syncLast7Days()">Đồng bộ 7 ngày qua</button>
  <button (click)="refresh()">Làm mới</button>
  <button (click)="showFilters.set(true)">Mở bộ lọc</button>
  <div class="hint">Gợi ý: đồng bộ theo từng tuần/tháng để đảm bảo tốc độ.</div>
  <hr />
</div>

<div class="table-wrapper">
  <table>
    <thead>
      <tr>
        <th>Ngày</th>
        <th>Khách hàng</th>
        <th>Agent</th>
        <th>Sản phẩm</th>
        <th>Số lượng</th>
        <th>Giá vốn</th>
        <th>Chi phí Ads</th>
        <th>Chi phí Nhân công</th>
        <th>Chi phí khác</th>
        <th>Doanh thu</th>
        <th>Lợi nhuận</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let row of filteredData()">
        <td>{{ formatDate(row.orderDate) }}</td>
        <td>{{ row.customerName }}</td>
        <td>{{ row.agentName }}</td>
        <td>{{ row.product }}</td>
        <td class="num">{{ row.quantity }}</td>
        <td class="num">{{ formatCurrency(row.costOfGoods) }}</td>
        <td class="num">{{ formatCurrency(row.adCost) }}</td>
        <td class="num">{{ formatCurrency(row.laborCost) }}</td>
        <td class="num">{{ formatCurrency(row.otherCost) }}</td>
        <td class="num">{{ formatCurrency(row.revenue) }}</td>
        <td class="num profit">{{ formatCurrency(row.profit) }}</td>
      </tr>
    </tbody>
  </table>
</div>

<div class="pagination" *ngIf="totalRecords() > 0">
  <div class="info">
    Hiển thị {{ displayFrom() }} - {{ displayTo() }} / {{ totalRecords() }} bản ghi
  </div>
  <div class="controls">
    <button (click)="goToPage(currentPage()-1)" [disabled]="currentPage()<=1">«</button>
    <span>Trang {{ currentPage() }} / {{ totalPages() }}</span>
    <button (click)="goToPage(currentPage()+1)" [disabled]="currentPage()>=totalPages()">»</button>
    <select [ngModel]="filter().limit" (ngModelChange)="changePageSize($event)">
      <option [ngValue]="20">20</option>
      <option [ngValue]="50">50</option>
      <option [ngValue]="100">100</option>
      <option [ngValue]="200">200</option>
    </select>
  </div>
</div>
