<!-- Product Profit Report Template -->
<div class="product-profit-report">
  <!-- Header -->
  <div class="header">
    <h2>üìà B√°o C√°o L·ª£i Nhu·∫≠n S·∫£n Ph·∫©m Theo Ng√†y</h2>
    <p class="description">D·ª±a tr√™n d·ªØ li·ªáu t·ª´ T·ªïng h·ª£p 2, hi·ªÉn th·ªã l·ª£i nhu·∫≠n c·ªßa t·ª´ng s·∫£n ph·∫©m theo t·ª´ng ng√†y</p>
  </div>

  <!-- Filter Panel -->
  <div class="filter-panel">
    <div class="filter-grid">
      <!-- Year Filter -->
      <div class="filter-group">
        <label>NƒÉm:</label>
        <select 
          [value]="filter().year || ''" 
          (change)="updateFilterYear($event)">
          <option value="">T·∫•t c·∫£ nƒÉm</option>
          <option *ngFor="let year of availableYears()" [value]="year">{{ year }}</option>
        </select>
      </div>

      <!-- Period Filter -->
      <div class="filter-group">
        <label>Kho·∫£ng th·ªùi gian:</label>
        <select 
          [value]="filter().period || '30days'" 
          (change)="updateFilterPeriod($event)">
          <option *ngFor="let option of periodOptions" [value]="option.value">
            {{ option.label }}
          </option>
        </select>
      </div>

      <!-- Product Filter -->
      <div class="filter-group">
        <label>S·∫£n ph·∫©m:</label>
        <select 
          [value]="filter().productId || ''" 
          (change)="updateFilterProduct($event)">
          <option value="">T·∫•t c·∫£ s·∫£n ph·∫©m</option>
          <option *ngFor="let product of products()" [value]="product.id">
            {{ product.name }}
          </option>
        </select>
      </div>

      <!-- Custom Date Range (when period = custom) -->
      <div class="filter-group" *ngIf="isCustomPeriod()">
        <label>T·ª´ ng√†y:</label>
        <input 
          type="date" 
          [value]="filter().fromDate || ''" 
          (change)="updateFilterFromDate($event)">
      </div>

      <div class="filter-group" *ngIf="isCustomPeriod()">
        <label>ƒê·∫øn ng√†y:</label>
        <input 
          type="date" 
          [value]="filter().toDate || ''" 
          (change)="updateFilterToDate($event)">
      </div>

      <!-- Action Buttons -->
      <div class="filter-actions">
        <button class="btn-reset" (click)="resetFilter()">üîÑ ƒê·∫∑t l·∫°i</button>
        <button class="btn-export" (click)="exportToCSV()" [disabled]="!hasData()">
          üìä Xu·∫•t CSV
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading()" class="loading">
    <div class="spinner"></div>
    <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error()" class="error">
    <p>‚ùå {{ error() }}</p>
    <button (click)="loadReport()">Th·ª≠ l·∫°i</button>
  </div>

  <!-- Summary Statistics -->
  <div *ngIf="hasData() && report()?.summary" class="summary-panel">
    <div class="summary-grid">
      <div class="summary-card">
        <span class="summary-label">T·ªïng l·ª£i nhu·∫≠n</span>
        <span class="summary-value profit" [class]="getProfitClass(report()!.summary.totalProfit)">
          {{ formatCurrency(report()!.summary.totalProfit) }}
        </span>
      </div>
      <div class="summary-card">
        <span class="summary-label">T·ªïng doanh thu</span>
        <span class="summary-value revenue">
          {{ formatCurrency(report()!.summary.totalRevenue) }}
        </span>
      </div>
      <div class="summary-card">
        <span class="summary-label">T·ªïng chi ph√≠</span>
        <span class="summary-value cost">
          {{ formatCurrency(report()!.summary.totalCost) }}
        </span>
      </div>
      <div class="summary-card">
        <span class="summary-label">T·ªïng s·ªë l∆∞·ª£ng</span>
        <span class="summary-value quantity">
          {{ report()!.summary.totalQuantity | number }}
        </span>
      </div>
    </div>
  </div>

  <!-- Data Table -->
  <div *ngIf="hasData()" class="table-container">
    <table class="profit-table">
      <thead>
        <tr>
          <th class="product-column">S·∫£n ph·∫©m</th>
          <th class="chart-column">Bi·ªÉu ƒë·ªì</th>
          <th *ngFor="let date of report()!.dates" class="date-column">
            {{ formatDate(date) }}
          </th>
          <th class="total-column">T·ªïng</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of report()!.data">
          <td class="product-name">{{ row.productName }}</td>
          <td class="chart-cell">
            <button class="chart-btn" (click)="showChart(row)" title="Xem bi·ªÉu ƒë·ªì tƒÉng tr∆∞·ªüng l·ª£i nhu·∫≠n">
              üìä
            </button>
          </td>
          <td *ngFor="let date of report()!.dates" 
              class="profit-cell"
              [class]="getProfitClass(row.dailyProfits[date] || 0)">
            {{ formatCurrency(row.dailyProfits[date] || 0) }}
          </td>
          <td class="total-cell" [class]="getProfitClass(row.totalProfit)">
            {{ formatCurrency(row.totalProfit) }}
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- No Data State -->
  <div *ngIf="!loading() && !error() && !hasData()" class="no-data">
    <div class="no-data-icon">üìä</div>
    <h3>Kh√¥ng c√≥ d·ªØ li·ªáu</h3>
    <p>Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn.</p>
    <button (click)="resetFilter()">ƒê·∫∑t l·∫°i b·ªô l·ªçc</button>
  </div>

  <!-- Chart Popup Modal -->
  <div *ngIf="showChartModal()" class="chart-modal-overlay" (click)="closeChart()">
    <div class="chart-modal" (click)="$event.stopPropagation()">
      <div class="chart-header">
        <h3>üìà Bi·ªÉu ƒê·ªì L·ª£i Nhu·∫≠n: {{ selectedProductChart()?.productName }}</h3>
        <button class="close-btn" (click)="closeChart()">‚úï</button>
      </div>
      
      <div class="chart-content">
        <!-- Chart Canvas -->
        <div class="chart-container">
          <canvas #chartCanvas width="800" height="400"></canvas>
        </div>
        
        <!-- Chart Legend -->
        <div class="chart-legend">
          <div class="legend-item">
            <span class="legend-color profit"></span>
            <span>L·ª£i nhu·∫≠n</span>
          </div>
          <div class="legend-item">
            <span class="legend-color revenue"></span>
            <span>Doanh thu</span>
          </div>
          <div class="legend-item">
            <span class="legend-color cost"></span>
            <span>Chi ph√≠</span>
          </div>
        </div>
        
        <!-- Chart Summary -->
        <div class="chart-summary" *ngIf="selectedProductChart()">
          <div class="summary-item">
            <span class="label">T·ªïng l·ª£i nhu·∫≠n:</span>
            <span class="value" [class]="getProfitClass(getTotalProfit())">
              {{ formatCurrency(getTotalProfit()) }}
            </span>
          </div>
          <div class="summary-item">
            <span class="label">L·ª£i nhu·∫≠n trung b√¨nh/ng√†y:</span>
            <span class="value" [class]="getProfitClass(getAverageProfit())">
              {{ formatCurrency(getAverageProfit()) }}
            </span>
          </div>
          <div class="summary-item">
            <span class="label">Ng√†y c√≥ l·ª£i nhu·∫≠n cao nh·∫•t:</span>
            <span class="value">{{ getBestDay() }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
