<!-- Template: B√°o c√°o l·ª£i nhu·∫≠n qu·∫£ng c√°o theo ng√†y (ƒë·ªìng b·ªô phong c√°ch v·ªõi L·ª£i Nhu·∫≠n S·∫£n Ph·∫©m Theo Ng√†y) -->
<div class="product-profit-report">
  <!-- Header -->
  <div class="header">
    <h2>ÔøΩ B√°o C√°o L·ª£i Nhu·∫≠n Qu·∫£ng C√°o Theo Ng√†y</h2>
    <p class="description">D·ª±a tr√™n d·ªØ li·ªáu t·ª´ T·ªïng h·ª£p 5 (Summary5), hi·ªÉn th·ªã l·ª£i nhu·∫≠n v√† chi ph√≠ qu·∫£ng c√°o theo t·ª´ng nh√≥m qu·∫£ng c√°o theo ng√†y</p>
  </div>

  <!-- Filter Panel -->
  <div class="filter-panel">
    <div class="filter-grid">
      <!-- Period Filter -->
      <div class="filter-group">
        <label>Kho·∫£ng th·ªùi gian:</label>
        <select [ngModel]="query.period" (ngModelChange)="onPeriodChange($event)">
          <option *ngFor="let option of periodOptions" [value]="option.value">{{ option.label }}</option>
        </select>
      </div>

      <!-- Custom Date Range -->
      <div class="filter-group" *ngIf="isCustomPeriod()">
        <label>T·ª´ ng√†y:</label>
        <input type="date" [ngModel]="query.fromDate" (ngModelChange)="setFromDate($event)" />
      </div>
      <div class="filter-group" *ngIf="isCustomPeriod()">
        <label>ƒê·∫øn ng√†y:</label>
        <input type="date" [ngModel]="query.toDate" (ngModelChange)="setToDate($event)" />
      </div>

      <!-- Ad Group Filter -->
      <div class="filter-group">
        <label>Nh√≥m qu·∫£ng c√°o:</label>
        <select [ngModel]="query.adGroupId" (ngModelChange)="onAdGroupChange($event)">
          <option value="">T·∫•t c·∫£</option>
          <option *ngFor="let adGroup of adGroups()" [value]="adGroup.adGroupId">{{ adGroup.name }}</option>
        </select>
      </div>

      <!-- Date window sliders -->
      <div class="filter-group" *ngIf="hasData()">
        <label>S·ªë ng√†y hi·ªÉn th·ªã:</label>
        <input type="range" min="7" max="120" [ngModel]="windowSize()" (ngModelChange)="setWindowSize($event)" />
      </div>
      <div class="filter-group" *ngIf="hasData()">
        <label>D·ªãch sang ph·∫£i/tr√°i:</label>
        <input type="range" [min]="0" [max]="maxStartIndex()" [ngModel]="startIndex()" (ngModelChange)="setStartIndex($event)" />
      </div>

      <!-- Actions -->
      <div class="filter-actions">
        <button class="btn-reset" (click)="resetFilters()">üîÑ ƒê·∫∑t l·∫°i</button>
        <button class="btn-export" (click)="exportToCSV()" [disabled]="!hasData()">üìä Xu·∫•t CSV</button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading()" class="loading">
    <div class="spinner"></div>
    <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error()" class="error">
    <p>‚ùå {{ error() }}</p>
    <button (click)="loadReport()">Th·ª≠ l·∫°i</button>
  </div>

  <!-- Summary -->
  <div *ngIf="hasData() && report()?.summary" class="summary-panel">
    <div class="summary-grid">
      <div class="summary-card">
        <span class="summary-label">T·ªïng l·ª£i nhu·∫≠n</span>
        <span class="summary-value profit" [class]="getProfitClass(report()!.summary.totalProfit)">
          {{ formatCurrency(report()!.summary.totalProfit) }}
        </span>
      </div>
      <div class="summary-card">
        <span class="summary-label">T·ªïng doanh thu</span>
        <span class="summary-value revenue">{{ formatCurrency(report()!.summary.totalRevenue) }}</span>
      </div>
      <div class="summary-card">
        <span class="summary-label">T·ªïng chi ph√≠</span>
        <span class="summary-value cost">{{ formatCurrency(report()!.summary.totalCost) }}</span>
      </div>
      <div class="summary-card">
        <span class="summary-label">T·ªïng ƒë∆°n</span>
        <span class="summary-value quantity">{{ report()!.summary.totalOrders | number }}</span>
      </div>
    </div>
  </div>

  <!-- Data Table -->
  <div *ngIf="hasData()" class="table-container">
    <table class="profit-table">
      <thead>
        <tr>
          <th class="product-column">Nh√≥m qu·∫£ng c√°o</th>
          <th class="chart-column">Bi·ªÉu ƒë·ªì</th>
          <th *ngFor="let d of visibleDates()" class="cost-column">{{ formatDate(d) }}</th>
          <th *ngFor="let d of visibleDates()" class="date-column">{{ formatDate(d) }}</th>
          <th class="total-column">T·ªïng</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of report()!.data">
          <td class="product-name">
            <span class="adgroup-name">{{ row.adGroupName }}</span>
            <span class="adgroup-id">&#123; {{ row.adGroupId }} &#125;</span>
          </td>
          <td class="chart-cell">
            <button class="chart-btn" (click)="showChart(row)" title="Xem bi·ªÉu ƒë·ªì tƒÉng tr∆∞·ªüng l·ª£i nhu·∫≠n">üìä</button>
          </td>
          <!-- Cost cells per day (headers are dates without 'CP') -->
          <td *ngFor="let d of visibleDates()" class="cost-cell">
            {{ formatCurrency(row.dailyCosts?.[d] || 0) }}
          </td>
          <td *ngFor="let d of visibleDates()" class="profit-cell" [class]="getProfitClass(row.dailyProfits[d] || 0)">
            {{ formatCurrency(row.dailyProfits[d] || 0) }}
          </td>
          <td class="total-cell" [class]="getProfitClass(row.totalProfit)">{{ formatCurrency(row.totalProfit) }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- No Data -->
  <div *ngIf="!loading() && !error() && !hasData()" class="no-data">
    <div class="no-data-icon">üìä</div>
    <h3>Kh√¥ng c√≥ d·ªØ li·ªáu</h3>
    <p>Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn.</p>
    <button (click)="resetFilters()">ƒê·∫∑t l·∫°i b·ªô l·ªçc</button>
  </div>

  <!-- Chart Modal -->
  <div *ngIf="showChartModal()" class="chart-modal-overlay" (click)="closeChart()">
    <div class="chart-modal" (click)="$event.stopPropagation()">
      <div class="chart-header">
        <h3>üìà Bi·ªÉu ƒê·ªì L·ª£i Nhu·∫≠n: {{ selectedAdGroupChart()?.adGroupName }}</h3>
        <button class="close-btn" (click)="closeChart()">‚úï</button>
      </div>
      <div class="chart-content">
        <div class="chart-container">
          <canvas #chartCanvas width="800" height="400"></canvas>
        </div>
        <div class="chart-legend">
          <div class="legend-item"><span class="legend-color profit"></span><span>L·ª£i nhu·∫≠n (ƒë∆∞·ªùng)</span></div>
        </div>
        <div class="chart-summary" *ngIf="selectedAdGroupChart()">
          <div class="summary-item">
            <span class="label">T·ªïng l·ª£i nhu·∫≠n:</span>
            <span class="value" [class]="getProfitClass(getTotalChartProfit())">{{ formatCurrency(getTotalChartProfit()) }}</span>
          </div>
          <div class="summary-item">
            <span class="label">L·ª£i nhu·∫≠n trung b√¨nh/ng√†y:</span>
            <span class="value" [class]="getProfitClass(getAverageChartProfit())">{{ formatCurrency(getAverageChartProfit()) }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Ng√†y t·ªët nh·∫•t:</span>
            <span class="value">{{ getBestChartDay() }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
