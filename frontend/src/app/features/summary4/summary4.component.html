<div class="summary4-container">
  <div class="header">
    <h1>ğŸ“Š BÃ¡o CÃ¡o Tá»•ng Há»£p 4</h1>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="toggleFilters()">
        {{ showFilters() ? 'ğŸ”¼ áº¨n Bá»™ Lá»c' : 'ğŸ”½ Hiá»‡n Bá»™ Lá»c' }}
      </button>
      <button class="btn btn-primary" (click)="syncData()" [disabled]="loading()">
        {{ loading() ? 'Äang Ä‘á»“ng bá»™...' : 'ğŸ”„ Äá»“ng bá»™ dá»¯ liá»‡u' }}
      </button>
      <button class="btn btn-warning" (click)="exportUnpaidToExcel()" [disabled]="loading()">
        {{ loading() ? 'Äang xuáº¥t...' : 'ğŸ“‹ ChÆ°a Thanh ToÃ¡n' }}
      </button>
      <button class="btn btn-info" (click)="exportManualPaymentTemplate()" [disabled]="loading()">
        {{ loading() ? 'Äang xuáº¥t...' : 'ğŸ“„ Táº£i Template' }}
      </button>
      <div class="manual-payment-upload">
        <input type="file" 
               id="manual-payment-file" 
               accept=".xlsx,.xls" 
               (change)="onFileSelected($event)"
               style="display: none;">
        <button class="btn btn-success" (click)="triggerFileInput()" [disabled]="loading()">
          {{ loading() ? 'Äang xá»­ lÃ½...' : 'ğŸ“¤ Thanh ToÃ¡n Tay' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Filter Panel -->
  <div class="filter-panel" *ngIf="showFilters()">
    <div class="filter-grid">
      <!-- Agent Filter -->
      <div class="filter-group">
        <label>ğŸ¢ Äáº¡i LÃ½:</label>
        <select (change)="filterByAgent($any($event.target).value)" [value]="filter().agentId || 'all'">
          <option value="all">Táº¥t cáº£ Ä‘áº¡i lÃ½</option>
          <option *ngFor="let agent of agents()" [value]="agent.agentId">
            {{ agent.agentName }} ({{ agent.orderCount }} Ä‘Æ¡n)
          </option>
        </select>
        <input type="text" 
               placeholder="TÃ¬m theo tÃªn Ä‘áº¡i lÃ½..." 
               #agentNameInput
               (keyup.enter)="searchAgent(agentNameInput.value)"
               [value]="filter().agentName || ''">
      </div>

      <!-- Date Filter -->
      <div class="filter-group">
        <label>ğŸ“… Thá»i Gian:</label>
        <div class="date-inputs">
          <input type="date" 
                 placeholder="Tá»« ngÃ y" 
                 [value]="startDateInput()"
                 (change)="startDateInput($any($event.target).value)">
          <input type="date" 
                 placeholder="Äáº¿n ngÃ y"
                 [value]="endDateInput()"
                 (change)="endDateInput($any($event.target).value)">
          <button class="btn btn-sm btn-primary" (click)="applyDateFilter()">Ãp dá»¥ng</button>
          <button class="btn btn-sm btn-secondary" (click)="clearDateFilter()">XÃ³a</button>
        </div>
      </div>

      <!-- Payment Status Filter -->
      <div class="filter-group">
        <label>ğŸ’° Thanh ToÃ¡n:</label>
        <select (change)="filterByPaymentStatus($any($event.target).value)" [value]="filter().paymentStatus || 'all'">
          <option value="all">Táº¥t cáº£</option>
          <option value="unpaid">ChÆ°a thanh toÃ¡n</option>
          <option value="paid">ÄÃ£ thanh toÃ¡n</option>
          <option value="manual">CÃ³ thanh toÃ¡n tay</option>
        </select>
      </div>

      <!-- Customer Search -->
      <div class="filter-group">
        <label>ğŸ‘¤ KhÃ¡ch HÃ ng:</label>
        <input type="text" 
               placeholder="TÃ¬m theo tÃªn khÃ¡ch hÃ ng..." 
               #customerNameInput
               (keyup.enter)="searchCustomer(customerNameInput.value)"
               [value]="filter().customerName || ''">
      </div>

      <!-- Product Search -->
      <div class="filter-group">
        <label>ğŸ“¦ Sáº£n Pháº©m:</label>
        <input type="text" 
               placeholder="TÃ¬m theo tÃªn sáº£n pháº©m..." 
               #productNameInput
               (keyup.enter)="searchProduct(productNameInput.value)"
               [value]="filter().productName || ''">
      </div>

      <!-- Clear Filters -->
      <div class="filter-group">
        <button class="btn btn-warning" (click)="clearAllFilters()">
          ğŸ—‘ï¸ XÃ³a Táº¥t Cáº£ Bá»™ Lá»c
        </button>
      </div>
    </div>
  </div>

  <!-- Statistics Panel (Summary1-like) -->
  <div class="stats-panel" *ngIf="stats()">
    <div class="stats-grid">
      <div class="stat-item">
        <div class="stat-label">Tá»•ng sá»‘ dÃ²ng:</div>
        <div class="stat-value">{{ stats()?.totalRecords }}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Tá»•ng pháº£i tráº£:</div>
        <div class="stat-value">{{ formatCurrency(stats()?.totalMustPay || 0) }}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Tá»•ng Ä‘Ã£ tráº£:</div>
        <div class="stat-value">{{ formatCurrency(stats()?.totalPaidToCompany || 0) }}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Tá»•ng thanh toÃ¡n tay:</div>
        <div class="stat-value">{{ formatCurrency(stats()?.totalManualPayment || 0) }}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Tá»•ng cáº§n thanh toÃ¡n:</div>
        <div class="stat-value">{{ formatCurrency(stats()?.totalNeedToPay || 0) }}</div>
      </div>
    </div>
  </div>

  <!-- Filter Toolbar removed per requirement -->

  <!-- Error message -->
  <div class="alert alert-danger" *ngIf="error()">
    {{ error() }}
  </div>

  <!-- Loading indicator -->
  <div class="loading" *ngIf="loading()">
    <div class="spinner"></div>
    <p>Äang táº£i dá»¯ liá»‡u...</p>
  </div>

  <!-- Data Table -->
  <div class="table-wrapper" *ngIf="!loading()">
  <table class="data-table">
      <thead>
        <tr>
          <th (click)="onSortChange('orderDate')" class="sortable">
            NgÃ y thÃ¡ng
            <span class="sort-icon">{{ filter().sortBy === 'orderDate' ? (filter().sortOrder === 'asc' ? 'â†‘' : 'â†“') : 'â†•' }}</span>
          </th>
          <th (click)="onSortChange('customerName')" class="sortable">
            TÃªn khÃ¡ch hÃ ng
            <span class="sort-icon">{{ filter().sortBy === 'customerName' ? (filter().sortOrder === 'asc' ? 'â†‘' : 'â†“') : 'â†•' }}</span>
          </th>
          <th>Sáº£n pháº©m</th>
          <th>Sá»‘ lÆ°á»£ng</th>
          <th>TÃªn Ä‘áº¡i lÃ½</th>
          <th>ID nhÃ³m quáº£ng cÃ¡o</th>
          <th>KÃ­ch hoáº¡t</th>
          <th>Chi tiáº¿t dá»‹ch vá»¥</th>
          <th>Tráº¡ng thÃ¡i sáº£n xuáº¥t</th>
          <th>Tráº¡ng thÃ¡i váº­n Ä‘Æ¡n</th>
          <th>Link ná»™p</th>
          <th>MÃ£ váº­n Ä‘Æ¡n</th>
          <th>Äáº·t cá»c</th>
          <th>COD</th>
          <th>BÃ¡o giÃ¡ Ä‘áº¡i lÃ½</th>
          <th>Pháº£i Tráº£ cÃ´ng ty<br/><span class="muted">Tá»•ng: {{ (stats()?.totalMustPay || 0) | number:'1.0-0' }}</span></th>
          <th>ÄÃ£ Tráº£ cÃ´ng ty<br/><span class="muted">Tá»•ng: {{ (stats()?.totalPaidToCompany || 0) | number:'1.0-0' }}</span></th>
          <th>Cáº§n thanh toÃ¡n<br/><span class="muted">Tá»•ng: {{ (stats()?.totalNeedToPay || 0) | number:'1.0-0' }}</span></th>
          <th>Thanh toÃ¡n tay</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of filteredData(); trackBy: trackByFn">
          <td>{{ formatDate(item.orderDate) }}</td>
          <td>{{ item.customerName }}</td>
          <td>{{ item.product }}</td>
          <td>{{ item.quantity }}</td>
          <td>{{ item.agentName }}</td>
          <td>{{ item.adGroupId }}</td>
          <td>{{ item.isActive ? 'CÃ³' : 'KhÃ´ng' }}</td>
          <td>{{ item.serviceDetails || '' }}</td>
          <td>
            <span [class]="getStatusColor(item.productionStatus)">{{ item.productionStatus }}</span>
          </td>
          <td>
            <span [class]="getStatusColor(item.orderStatus)">{{ item.orderStatus }}</span>
          </td>
          <td>
            <a *ngIf="item.submitLink" [href]="item.submitLink" target="_blank" rel="noopener">Má»Ÿ</a>
          </td>
          <td>{{ item.trackingNumber }}</td>
          <td>{{ formatCurrency(item.depositAmount) }}</td>
          <td>{{ formatCurrency(item.codAmount) }}</td>
          <td>{{ formatCurrency(item.approvedQuotePrice) }}</td>
          <td>{{ formatCurrency(item.mustPayToCompany) }}</td>
          <td>{{ formatCurrency(item.paidToCompany) }}</td>
          <td [class]="item.needToPay > 0 ? 'text-red-600' : item.needToPay < 0 ? 'text-green-600' : ''">
            {{ formatCurrency(item.needToPay) }}
          </td>
          <td>
            <input 
              class="input" 
              type="number" 
              step="1000"
              [ngModel]="item.manualPayment || 0"
              (blur)="onBlurManual(item._id, $event)"
              (keydown.enter)="$event.target.blur()" />
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination (Summary1-like) -->
  <div class="pagination-wrapper" *ngIf="!loading() && totalRecords() > 0">
    <div class="pagination-info">
      Hiá»ƒn thá»‹ {{ displayFrom() }} - {{ displayTo() }} trong tá»•ng sá»‘ {{ totalRecords() }} káº¿t quáº£
    </div>
    <div class="pagination-controls">
      <select [ngModel]="filter().limit" (ngModelChange)="changePageSize($event)" class="page-size-select">
        <option value="10">10/trang</option>
        <option value="25">25/trang</option>
        <option value="50">50/trang</option>
        <option value="100">100/trang</option>
      </select>
      <button class="btn btn-sm" [disabled]="currentPage() <= 1" (click)="goToPage(1)">â®ï¸ Äáº§u</button>
      <button class="btn btn-sm" [disabled]="currentPage() <= 1" (click)="goToPage(currentPage() - 1)">â¬…ï¸ TrÆ°á»›c</button>
      <span class="page-info">Trang {{ currentPage() }} / {{ totalPages() }}</span>
      <button class="btn btn-sm" [disabled]="currentPage() >= totalPages()" (click)="goToPage(currentPage() + 1)">Sau â¡ï¸</button>
      <button class="btn btn-sm" [disabled]="currentPage() >= totalPages()" (click)="goToPage(totalPages())">Cuá»‘i â­ï¸</button>
    </div>
  </div>
</div>