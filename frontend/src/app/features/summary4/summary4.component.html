<div class="summary4-container">
  <div class="header">
    <h1>üìä B√°o C√°o T·ªïng H·ª£p 4</h1>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="syncData()" [disabled]="loading()">
        {{ loading() ? 'ƒêang ƒë·ªìng b·ªô...' : 'üîÑ ƒê·ªìng b·ªô d·ªØ li·ªáu' }}
      </button>
    </div>
  </div>

  <!-- Statistics Panel (Summary1-like) -->
  <div class="stats-panel" *ngIf="stats()">
    <div class="stats-grid">
      <div class="stat-item">
        <div class="stat-label">T·ªïng s·ªë d√≤ng:</div>
        <div class="stat-value">{{ stats()?.totalRecords }}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">T·ªïng ph·∫£i tr·∫£:</div>
        <div class="stat-value">{{ formatCurrency(stats()?.totalMustPay || 0) }}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">T·ªïng ƒë√£ tr·∫£:</div>
        <div class="stat-value">{{ formatCurrency(stats()?.totalPaidToCompany || 0) }}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">T·ªïng thanh to√°n tay:</div>
        <div class="stat-value">{{ formatCurrency(stats()?.totalManualPayment || 0) }}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">T·ªïng c·∫ßn thanh to√°n:</div>
        <div class="stat-value">{{ formatCurrency(stats()?.totalNeedToPay || 0) }}</div>
      </div>
    </div>
  </div>

  <!-- Filter Toolbar (Summary1-like) -->
  <div class="filter-toolbar">
    <div class="filter-row">
      <input class="form-control search-input" type="text" placeholder="T√¨m ki·∫øm KH/SƒêT/M√£ v·∫≠n ƒë∆°n"
             [ngModel]="searchTerm()" (ngModelChange)="searchTerm.set($event)" />
      <button class="btn btn-secondary" (click)="showFilters.set(!showFilters())">
        {{ showFilters() ? 'üîº ·∫®n Filter' : 'üîΩ Hi·ªán Filter' }}
      </button>
      <button class="btn btn-primary" (click)="refresh()">üîÑ L√†m m·ªõi</button>
    </div>

    <div class="filter-panel" *ngIf="showFilters()">
      <div class="filter-grid">
        <!-- Advanced Filters -->
        <div class="filter-group">
          <label>ƒê·∫°i l√Ω:</label>
          <select [ngModel]="filter().agentId" (ngModelChange)="updateFilter('agentId', $event)">
            <option value="">T·∫•t c·∫£ ƒë·∫°i l√Ω</option>
            <option *ngFor="let agent of agents()" [value]="agent._id">{{ agent.fullName }}</option>
          </select>
        </div>
        <div class="filter-group">
          <label>S·∫£n ph·∫©m:</label>
          <select [ngModel]="filter().productId" (ngModelChange)="updateFilter('productId', $event)">
            <option value="">T·∫•t c·∫£ s·∫£n ph·∫©m</option>
            <option *ngFor="let product of products()" [value]="product._id">{{ product.name }}</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Tr·∫°ng th√°i s·∫£n xu·∫•t:</label>
          <select [ngModel]="filter().productionStatus" (ngModelChange)="updateFilter('productionStatus', $event)">
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="ƒê√£ tr·∫£ k·∫øt qu·∫£">ƒê√£ tr·∫£ k·∫øt qu·∫£</option>
            <option value="ƒêang x·ª≠ l√Ω">ƒêang x·ª≠ l√Ω</option>
            <option value="Ch∆∞a l√†m">Ch∆∞a l√†m</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Tr·∫°ng th√°i v·∫≠n ƒë∆°n:</label>
          <select [ngModel]="filter().orderStatus" (ngModelChange)="updateFilter('orderStatus', $event)">
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
            <option value="Giao th√†nh c√¥ng">Giao th√†nh c√¥ng</option>
            <option value="ƒêang v·∫≠n chuy·ªÉn">ƒêang v·∫≠n chuy·ªÉn</option>
            <option value="ƒêang l·∫•y h√†ng">ƒêang l·∫•y h√†ng</option>
            <option value="Ch∆∞a c√≥ m√£ v·∫≠n ƒë∆°n">Ch∆∞a c√≥ m√£ v·∫≠n ƒë∆°n</option>
          </select>
        </div>
        <div class="filter-group">
          <label>T·ª´ ng√†y:</label>
          <input type="date" [ngModel]="filter().startDate" (ngModelChange)="updateFilter('startDate', $event)" />
        </div>
        <div class="filter-group">
          <label>ƒê·∫øn ng√†y:</label>
          <input type="date" [ngModel]="filter().endDate" (ngModelChange)="updateFilter('endDate', $event)" />
        </div>
        <div class="filter-group">
          <label>S·∫Øp x·∫øp theo:</label>
          <select [ngModel]="filter().sortBy" (ngModelChange)="updateFilter('sortBy', $event)">
            <option value="orderDate">Ng√†y t·∫°o</option>
            <option value="customerName">T√™n kh√°ch h√†ng</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Th·ª© t·ª±:</label>
          <select [ngModel]="filter().sortOrder" (ngModelChange)="updateFilter('sortOrder', $event)">
            <option value="asc">TƒÉng d·∫ßn</option>
            <option value="desc">Gi·∫£m d·∫ßn</option>
          </select>
        </div>
      </div>
      <div class="filter-actions">
        <button class="btn btn-warning" (click)="filter.set({ page: 1, limit: 50, sortBy: 'orderDate', sortOrder: 'desc' }); searchTerm.set(''); loadData();">üîÑ Reset Filter</button>
        <div class="filter-info">T√¨m th·∫•y {{ totalRecords() }} k·∫øt qu·∫£</div>
      </div>
    </div>
  </div>

  <!-- Error message -->
  <div class="alert alert-danger" *ngIf="error()">
    {{ error() }}
  </div>

  <!-- Loading indicator -->
  <div class="loading" *ngIf="loading()">
    <div class="spinner"></div>
    <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
  </div>

  <!-- Data Table -->
  <div class="table-wrapper" *ngIf="!loading()">
  <table class="data-table">
      <thead>
        <tr>
          <th (click)="onSortChange('orderDate')" class="sortable">
            Ng√†y th√°ng
            <span class="sort-icon">{{ filter().sortBy === 'orderDate' ? (filter().sortOrder === 'asc' ? '‚Üë' : '‚Üì') : '‚Üï' }}</span>
          </th>
          <th (click)="onSortChange('customerName')" class="sortable">
            T√™n kh√°ch h√†ng
            <span class="sort-icon">{{ filter().sortBy === 'customerName' ? (filter().sortOrder === 'asc' ? '‚Üë' : '‚Üì') : '‚Üï' }}</span>
          </th>
          <th>S·∫£n ph·∫©m</th>
          <th>S·ªë l∆∞·ª£ng</th>
          <th>T√™n ƒë·∫°i l√Ω</th>
          <th>ID nh√≥m qu·∫£ng c√°o</th>
          <th>K√≠ch ho·∫°t</th>
          <th>Chi ti·∫øt d·ªãch v·ª•</th>
          <th>Tr·∫°ng th√°i s·∫£n xu·∫•t</th>
          <th>Tr·∫°ng th√°i v·∫≠n ƒë∆°n</th>
          <th>Link n·ªôp</th>
          <th>M√£ v·∫≠n ƒë∆°n</th>
          <th>ƒê·∫∑t c·ªçc</th>
          <th>COD</th>
          <th>B√°o gi√° ƒë·∫°i l√Ω</th>
          <th>Ph·∫£i Tr·∫£ c√¥ng ty<br/><span class="muted">T·ªïng: {{ (stats()?.totalMustPay || 0) | number:'1.0-0' }}</span></th>
          <th>ƒê√£ Tr·∫£ c√¥ng ty<br/><span class="muted">T·ªïng: {{ (stats()?.totalPaidToCompany || 0) | number:'1.0-0' }}</span></th>
          <th>C·∫ßn thanh to√°n<br/><span class="muted">T·ªïng: {{ (stats()?.totalNeedToPay || 0) | number:'1.0-0' }}</span></th>
          <th>Thanh to√°n tay</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of filteredData(); trackBy: trackByFn">
          <td>{{ formatDate(item.orderDate) }}</td>
          <td>{{ item.customerName }}</td>
          <td>{{ item.product }}</td>
          <td>{{ item.quantity }}</td>
          <td>{{ item.agentName }}</td>
          <td>{{ item.adGroupId }}</td>
          <td>{{ item.isActive ? 'C√≥' : 'Kh√¥ng' }}</td>
          <td>{{ item.serviceDetails || '' }}</td>
          <td>
            <span [class]="getStatusColor(item.productionStatus)">{{ item.productionStatus }}</span>
          </td>
          <td>
            <span [class]="getStatusColor(item.orderStatus)">{{ item.orderStatus }}</span>
          </td>
          <td>
            <a *ngIf="item.submitLink" [href]="item.submitLink" target="_blank" rel="noopener">M·ªü</a>
          </td>
          <td>{{ item.trackingNumber }}</td>
          <td>{{ formatCurrency(item.depositAmount) }}</td>
          <td>{{ formatCurrency(item.codAmount) }}</td>
          <td>{{ formatCurrency(item.approvedQuotePrice) }}</td>
          <td>{{ formatCurrency(item.mustPayToCompany) }}</td>
          <td>{{ formatCurrency(item.paidToCompany) }}</td>
          <td [class]="item.needToPay > 0 ? 'text-red-600' : item.needToPay < 0 ? 'text-green-600' : ''">
            {{ formatCurrency(item.needToPay) }}
          </td>
          <td>
            <input 
              class="input" 
              type="number" 
              step="1000"
              [ngModel]="item.manualPayment || 0"
              (blur)="onBlurManual(item._id, $event)"
              (keydown.enter)="$event.target.blur()" />
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination (Summary1-like) -->
  <div class="pagination-wrapper" *ngIf="!loading() && totalRecords() > 0">
    <div class="pagination-info">
      Hi·ªÉn th·ªã {{ displayFrom() }} - {{ displayTo() }} trong t·ªïng s·ªë {{ totalRecords() }} k·∫øt qu·∫£
    </div>
    <div class="pagination-controls">
      <select [ngModel]="filter().limit" (ngModelChange)="changePageSize($event)" class="page-size-select">
        <option value="10">10/trang</option>
        <option value="25">25/trang</option>
        <option value="50">50/trang</option>
        <option value="100">100/trang</option>
      </select>
      <button class="btn btn-sm" [disabled]="currentPage() <= 1" (click)="goToPage(1)">‚èÆÔ∏è ƒê·∫ßu</button>
      <button class="btn btn-sm" [disabled]="currentPage() <= 1" (click)="goToPage(currentPage() - 1)">‚¨ÖÔ∏è Tr∆∞·ªõc</button>
      <span class="page-info">Trang {{ currentPage() }} / {{ totalPages() }}</span>
      <button class="btn btn-sm" [disabled]="currentPage() >= totalPages()" (click)="goToPage(currentPage() + 1)">Sau ‚û°Ô∏è</button>
      <button class="btn btn-sm" [disabled]="currentPage() >= totalPages()" (click)="goToPage(totalPages())">Cu·ªëi ‚è≠Ô∏è</button>
    </div>
  </div>
</div>